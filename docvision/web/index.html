<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DocVision — Document Scanner</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' rx='16' fill='%230b1220'/%3E%3Crect x='25' y='8' width='50' height='65' rx='4' fill='%239ca3af' opacity='.85'/%3E%3Cellipse cx='50' cy='58' rx='26' ry='16' fill='none' stroke='%2314b8a6' stroke-width='4' opacity='.8'/%3E%3Cpath d='M50 42c10 0 19 5.5 24 14-5 8.5-14 14-24 14' fill='%2314b8a6' opacity='.55'/%3E%3Ccircle cx='50' cy='58' r='10' fill='%230b1220'/%3E%3Ccircle cx='50' cy='58' r='6' fill='%231e293b' stroke='%23334155' stroke-width='1.5'/%3E%3Ccircle cx='47' cy='55' r='2.5' fill='rgba(255,255,255,.45)'/%3E%3Ccircle cx='55' cy='62' r='11' fill='none' stroke='%23e4e6f0' stroke-width='3' opacity='.7'/%3E%3Cline x1='63' y1='70' x2='74' y2='81' stroke='%23e4e6f0' stroke-width='4' stroke-linecap='round' opacity='.7'/%3E%3C/svg%3E">
<link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="app">
  <!-- Header -->
  <header>
    <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <!-- Document -->
      <rect x="25" y="8" width="50" height="65" rx="4" fill="#9ca3af" opacity=".85"/>
      <path d="M63 8h-1l13 13v-1a4 4 0 0 0-4-4h-4V12a4 4 0 0 0-4-4z" fill="#6b7280"/>
      <rect x="33" y="18" width="12" height="3" rx="1" fill="#4b5563"/>
      <rect x="48" y="18" width="18" height="2" rx="1" fill="#4b5563"/>
      <rect x="48" y="23" width="18" height="2" rx="1" fill="#4b5563"/>
      <!-- Eye -->
      <ellipse cx="50" cy="58" rx="28" ry="18" fill="#374151" opacity=".9"/>
      <ellipse cx="50" cy="58" rx="26" ry="16" fill="none" stroke="#14b8a6" stroke-width="4" opacity=".8"/>
      <!-- Teal accent half -->
      <path d="M50 42c10 0 19 5.5 24 14-5 8.5-14 14-24 14" fill="#14b8a6" opacity=".55"/>
      <!-- Iris -->
      <circle cx="50" cy="58" r="10" fill="#0b1220"/>
      <circle cx="50" cy="58" r="6" fill="#1e293b" stroke="#334155" stroke-width="1.5"/>
      <circle cx="47" cy="55" r="2.5" fill="rgba(255,255,255,.45)"/>
      <!-- Magnifying glass -->
      <circle cx="55" cy="62" r="11" fill="none" stroke="#e4e6f0" stroke-width="3" opacity=".7"/>
      <line x1="63" y1="70" x2="74" y2="81" stroke="#e4e6f0" stroke-width="4" stroke-linecap="round" opacity=".7"/>
      <!-- Sparkle -->
      <path d="M88 88l-2-5-2 5-5 2 5 2 2 5 2-5 5-2z" fill="#8890a4" opacity=".6"/>
    </svg>
    <h1>Doc<span>Vision</span></h1>
    <span class="version" id="versionBadge">DocVision Web UI</span>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="upload"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Upload</div>
    <div class="tab" data-tab="artifacts"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Artifacts</div>
    <div class="tab" data-tab="output"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Output</div>
    <div class="tab" data-tab="history"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>History</div>
    <div class="tab" data-tab="costs"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Costs</div>
  </div>

  <!-- ─── UPLOAD PANEL ──────────────────────────────────────────── -->
  <div class="panel active" id="panel-upload">
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.tiff,.tif,.bmp,.webp" multiple>
      <div class="icon">📁</div>
      <div><strong>Drop documents here</strong> or click to browse</div>
      <p>PDF · JPEG · PNG · TIFF · BMP · WebP — single or multiple files</p>
    </div>

    <!-- Preview area (single file) -->
    <div id="previewArea" style="display:none"></div>

    <!-- File list (batch) -->
    <div id="fileListArea" style="display:none">
      <div class="file-list" id="fileList"></div>
    </div>

    <!-- Processing Mode -->
    <div class="mode-row">
      <label for="modeSelect">Processing Mode</label>
      <select id="modeSelect">
        <option value="local">🖥 Local Models</option>
        <option value="azure">☁ Azure Cloud</option>
      </select>
      <span class="mode-badge local" id="modeBadge">LOCAL</span>
      <label for="docTypeSelect" id="docTypeLabel" style="margin-left:18px;display:none">Document Type</label>
      <select id="docTypeSelect" style="display:none">
        <option value="auto">Auto-detect</option>
        <option value="bol">Bill of Lading</option>
        <option value="invoice">Invoice</option>
        <option value="receipt">Receipt</option>
        <option value="delivery_ticket">Delivery Ticket</option>
      </select>
    </div>

    <details style="margin-top:16px" id="localOptionsDetails">
      <summary style="cursor:pointer;color:var(--muted);font-size:.88rem">⚙ Processing Options</summary>
      <div class="options" id="optionsGrid">
        <label class="opt"><input type="checkbox" name="preprocess" checked> Preprocess</label>
        <label class="opt"><input type="checkbox" name="detect_layout" checked> Layout Detection</label>
        <label class="opt"><input type="checkbox" name="detect_text" checked> Text Detection</label>
        <label class="opt"><input type="checkbox" name="detect_tables" checked> Table Detection</label>
        <label class="opt"><input type="checkbox" name="run_ocr" checked> OCR Recognition</label>
        <label class="opt"><input type="checkbox" name="run_donut"> Donut KIE</label>
        <label class="opt"><input type="checkbox" name="run_layoutlmv3"> LayoutLMv3 KIE</label>
        <label class="opt"><input type="checkbox" name="run_validators" checked> Validators</label>
      </div>
    </details>

    <div style="margin-top:20px;display:flex;gap:10px">
      <button class="btn btn-primary" id="btnProcess" disabled>🚀 Process Document</button>
      <button class="btn btn-primary" id="btnBatch" disabled style="display:none">🚀 Process All Files</button>
    </div>

    <div class="status-bar" id="statusBar">
      <div class="status-top">
        <div class="spinner"></div>
        <div class="status-text" id="statusText">Processing…</div>
        <div class="status-time" id="statusTime">0s</div>
        <button class="btn-cancel" id="btnCancel" onclick="cancelCurrentJob()">Cancel</button>
      </div>
      <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
    </div>
  </div>

  <!-- ─── ARTIFACTS PANEL ───────────────────────────────────────── -->
  <div class="panel" id="panel-artifacts">
    <div id="artifactsJobSelector" class="job-selector" style="display:none">
      <label>Document:</label>
      <select id="artifactsJobSelect" onchange="onArtifactsJobChange(this.value)"></select>
    </div>
    <div id="artifactsContent">
      <div class="empty"><div class="icon">🔍</div><p>Upload and process a document first</p></div>
    </div>
  </div>

  <!-- ─── OUTPUT PANEL (Field Editor + JSON toggle) ─────────────── -->
  <div class="panel" id="panel-output">
    <div id="outputJobSelector" class="job-selector" style="display:none">
      <label>Document:</label>
      <select id="outputJobSelect" onchange="onOutputJobChange(this.value)"></select>
    </div>
    <div id="outputContent">
      <div class="empty"><div class="icon">📝</div><p>Upload and process a document first</p></div>
    </div>
  </div>

  <!-- ─── HISTORY PANEL ─────────────────────────────────────────── -->
  <div class="panel" id="panel-history">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
      <h2 style="font-size:1.15rem;font-weight:700">Processing History</h2>
      <button class="btn btn-secondary btn-sm" onclick="loadHistory()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>Refresh</button>
    </div>
    <div class="history-table-wrap">
      <table class="history-table">
        <thead><tr><th>File</th><th>Mode</th><th>Status</th><th>Pages</th><th>Lines</th><th>Tables</th><th>Fields</th><th>Time</th><th>Created</th></tr></thead>
        <tbody id="historyTableBody">
          <tr><td colspan="9" style="text-align:center;color:var(--muted);padding:40px">No documents processed yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ─── COST & USAGE PANEL ────────────────────────────────────── -->
  <div class="panel" id="panel-costs">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
      <h2 style="font-size:1.15rem;font-weight:700">Azure API Usage</h2>
      <span class="cost-refresh" id="costRefreshIndicator"><span class="dot"></span> Live</span>
    </div>
    <div class="cost-grid" id="costCards">
      <div class="cost-card"><div class="value money" id="ccTotalCost">$0.00</div><div class="label">Estimated Cost</div></div>
      <div class="cost-card"><div class="value count" id="ccTotalCalls">0</div><div class="label">Total API Calls</div></div>
      <div class="cost-card"><div class="value count" id="ccDICalls">0</div><div class="label">Doc Intelligence</div><div class="badge">DI</div></div>
      <div class="cost-card"><div class="value count" id="ccGPTCalls">0</div><div class="label">GPT Vision</div><div class="badge" style="background:rgba(34,197,94,.12);color:var(--success)">GPT</div></div>
      <div class="cost-card"><div class="value count" id="ccPages">0</div><div class="label">Pages Analysed</div></div>
      <div class="cost-card"><div class="value count" id="ccTokens">0</div><div class="label">Tokens Used</div></div>
      <div class="cost-card"><div class="value cache" id="ccCacheHits">0</div><div class="label">Cache Hits</div></div>
      <div class="cost-card"><div class="value money" id="ccSaved">$0.00</div><div class="label">Saved by Cache</div></div>
    </div>

    <div class="cost-section">
      <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:6px"><path d="M21 21H4.6c-.6 0-1.1-.2-1.4-.6-.4-.4-.6-.9-.6-1.4V3"/><path d="m7 14 4-4 4 4 6-6"/></svg>Cache Performance</h3>
      <div class="breakdown-row">
        <div class="breakdown-box" style="flex:2">
          <h4>Hit Rate</h4>
          <div class="cache-bar"><div class="hits" id="cacheHitBar" style="width:0%"></div><div class="misses" id="cacheMissBar" style="width:0%"></div></div>
          <div class="cache-bar-labels"><span id="cacheHitPct">0% hits</span><span id="cacheMissPct">0% misses</span></div>
        </div>
        <div class="breakdown-box">
          <h4>Cache Store</h4>
          <div class="breakdown-item"><span class="lbl">Entries</span><span class="val" id="cacheEntries">0</span></div>
          <div class="breakdown-item"><span class="lbl">Status</span><span class="val" id="cacheStatus">—</span></div>
        </div>
      </div>
    </div>

    <div class="cost-section">
      <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:6px"><circle cx="12" cy="12" r="10"/><path d="M12 6v12"/><path d="M15.5 9.4a3.5 3.5 0 1 0 0 5.2"/></svg>Cost Breakdown</h3>
      <div class="breakdown-row" id="costBreakdown">
        <div class="breakdown-box"><h4>Document Intelligence</h4>
          <div class="breakdown-item"><span class="lbl">Calls</span><span class="val" id="bdDICalls">0</span></div>
          <div class="breakdown-item"><span class="lbl">Pages</span><span class="val" id="bdDIPages">0</span></div>
          <div class="breakdown-item"><span class="lbl">Cost</span><span class="val" id="bdDICost">$0.00</span></div>
        </div>
        <div class="breakdown-box"><h4>GPT Vision</h4>
          <div class="breakdown-item"><span class="lbl">Calls</span><span class="val" id="bdGPTCalls">0</span></div>
          <div class="breakdown-item"><span class="lbl">Tokens</span><span class="val" id="bdGPTTokens">0</span></div>
          <div class="breakdown-item"><span class="lbl">Cost</span><span class="val" id="bdGPTCost">$0.00</span></div>
        </div>
      </div>
    </div>

    <div class="cost-actions">
      <button class="btn btn-secondary btn-sm" onclick="loadCosts()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>Refresh</button>
      <button class="btn btn-secondary btn-sm" onclick="resetCosts()" style="color:var(--warning)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M3 6h18"/><path d="M8 6V4c0-.5.2-1 .6-1.4C9 2.2 9.5 2 10 2h4c.5 0 1 .2 1.4.6.4.4.6.9.6 1.4v2"/><path d="M19 6v14c0 .5-.2 1-.6 1.4-.4.4-.9.6-1.4.6H7c-.5 0-1-.2-1.4-.6-.4-.4-.6-.9-.6-1.4V6"/></svg>Reset Counters</button>
      <button class="btn btn-secondary btn-sm" onclick="clearCache()" style="color:var(--error)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M4 4l16 16"/><path d="M9 5h9a2 2 0 0 1 2 2v9"/><path d="M3 12v7a2 2 0 0 0 2 2h12"/><path d="m7 9 2.9 2.9"/><path d="M15 5v4"/></svg>Clear Cache</button>
    </div>

    <div class="cost-section">
      <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:6px"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>Call History</h3>
      <div class="cost-table-wrap">
        <table class="cost-table">
          <thead><tr><th>Time</th><th>Service</th><th>Model</th><th>Detail</th><th>Latency</th><th>Cost</th><th></th></tr></thead>
          <tbody id="costTableBody">
            <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:30px">No API calls recorded yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Lightbox overlay -->
<div class="lightbox" id="lightbox">
  <img id="lightboxImg" src="">
</div>

<script src="/static/app.js"></script>
</body>
</html>
