<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DocVision â€” Document Scanner</title>
<style>
/* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1117;--surface:#1a1d27;--surface2:#242836;--surface3:#2e3345;
  --border:#363b4e;--text:#e4e6f0;--muted:#8890a4;
  --primary:#6366f1;--primary-hover:#818cf8;--primary-bg:rgba(99,102,241,.12);
  --success:#22c55e;--warning:#f59e0b;--error:#ef4444;
  --radius:10px;--shadow:0 4px 24px rgba(0,0,0,.35);
  --font:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  --mono:'Cascadia Code','Fira Code','JetBrains Mono',monospace;
  --conf-high:#22c55e;--conf-mid:#f59e0b;--conf-low:#ef4444;
}
html{font-size:15px}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh}
a{color:var(--primary);text-decoration:none}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app{max-width:1320px;margin:0 auto;padding:20px 28px 60px}
header{display:flex;align-items:center;gap:14px;padding:18px 0 28px;border-bottom:1px solid var(--border)}
header h1{font-size:1.55rem;font-weight:700;letter-spacing:-.3px}
header h1 span{color:var(--primary)}
header .version{font-size:.78rem;color:var(--muted);margin-left:auto}

/* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs{display:flex;gap:6px;margin:24px 0 20px;border-bottom:2px solid var(--border);padding-bottom:0;overflow-x:auto}
.tab{padding:10px 22px;cursor:pointer;font-size:.9rem;font-weight:500;color:var(--muted);border-bottom:2px solid transparent;margin-bottom:-2px;transition:.2s;user-select:none;border-radius:var(--radius) var(--radius) 0 0;white-space:nowrap}
.tab:hover{color:var(--text);background:var(--surface)}
.tab.active{color:var(--primary);border-bottom-color:var(--primary);background:var(--surface)}
.panel{display:none}
.panel.active{display:block}

/* â”€â”€ Upload Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.drop-zone{
  border:2px dashed var(--border);border-radius:var(--radius);padding:56px 28px;
  text-align:center;cursor:pointer;transition:.3s;position:relative;
  background:var(--surface)
}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--primary);background:var(--primary-bg)}
.drop-zone .icon{font-size:3rem;margin-bottom:14px;opacity:.6}
.drop-zone p{color:var(--muted);margin-top:6px;font-size:.88rem}
.drop-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}

/* â”€â”€ Preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.preview-area{display:flex;gap:20px;margin:16px 0;align-items:flex-start;flex-wrap:wrap}
.preview-thumb{border-radius:var(--radius);border:1px solid var(--border);max-height:220px;background:#000;object-fit:contain}
.preview-info{flex:1;min-width:200px}
.preview-info .filename{font-weight:600;font-size:1rem;margin-bottom:6px;word-break:break-all}
.preview-info .meta{font-size:.84rem;color:var(--muted);line-height:1.6}
.file-list{margin:12px 0;max-height:240px;overflow-y:auto}
.file-item{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface);border-radius:var(--radius);margin-bottom:6px;font-size:.85rem;border:1px solid var(--border)}
.file-item .name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-item .size{color:var(--muted);font-family:var(--mono);font-size:.78rem}
.file-item .remove{cursor:pointer;color:var(--error);font-size:1.1rem;padding:0 4px}

/* â”€â”€ Options Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.options{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:10px;margin:20px 0}
.opt{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--surface);border-radius:var(--radius);font-size:.85rem}
.opt input[type=checkbox]{accent-color:var(--primary);width:16px;height:16px}
.mode-row{display:flex;gap:14px;margin:18px 0 10px;flex-wrap:wrap;align-items:center}
.mode-row label{font-size:.88rem;color:var(--muted);font-weight:500}
.mode-row select{
  padding:8px 14px;border-radius:var(--radius);border:1px solid var(--border);
  background:var(--surface);color:var(--text);font-size:.88rem;cursor:pointer;
  min-width:180px
}
.mode-row select:focus{outline:none;border-color:var(--primary)}
.mode-badge{font-size:.72rem;padding:3px 10px;border-radius:20px;font-weight:600;letter-spacing:.3px}
.mode-badge.local{background:rgba(99,102,241,.15);color:var(--primary)}
.mode-badge.azure{background:rgba(34,197,94,.15);color:var(--success)}

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{
  display:inline-flex;align-items:center;gap:8px;padding:10px 24px;
  border:none;border-radius:var(--radius);font-size:.9rem;font-weight:600;
  cursor:pointer;transition:.2s
}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:var(--primary-hover)}
.btn-primary:disabled{opacity:.45;cursor:not-allowed}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--surface3)}
.btn-success{background:var(--success);color:#fff}
.btn-sm{padding:6px 14px;font-size:.82rem}
.btn-danger{background:var(--error);color:#fff}
.btn-danger:hover{background:#dc2626}

/* â”€â”€ Progress / Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.status-bar{margin:20px 0;padding:16px 20px;border-radius:var(--radius);background:var(--surface);display:none;align-items:center;gap:14px}
.status-bar.show{display:flex}
.spinner{width:22px;height:22px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.status-text{flex:1;font-size:.9rem}
.status-time{font-size:.8rem;color:var(--muted);font-family:var(--mono)}

/* â”€â”€ Artifact Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.artifacts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:18px;margin-top:16px}
.artifact-card{background:var(--surface);border-radius:var(--radius);overflow:hidden;border:1px solid var(--border);transition:.2s}
.artifact-card:hover{border-color:var(--primary);box-shadow:var(--shadow)}
.artifact-card img{width:100%;display:block;cursor:pointer;background:#000}
.artifact-card .label{padding:10px 14px;font-size:.82rem;color:var(--muted);display:flex;justify-content:space-between}

/* â”€â”€ Confidence Highlighting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.conf-legend{display:flex;gap:16px;margin:12px 0;font-size:.8rem;color:var(--muted);align-items:center;flex-wrap:wrap}
.conf-legend .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:4px}
.conf-high{color:var(--conf-high)}
.conf-mid{color:var(--conf-mid)}
.conf-low{color:var(--conf-low)}
.conf-badge{font-size:.7rem;padding:1px 6px;border-radius:8px;font-weight:600;font-family:var(--mono)}
.conf-badge.high{background:rgba(34,197,94,.15);color:var(--conf-high)}
.conf-badge.mid{background:rgba(245,158,11,.15);color:var(--conf-mid)}
.conf-badge.low{background:rgba(239,68,68,.15);color:var(--conf-low)}

/* â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:999;display:none;justify-content:center;align-items:center;cursor:zoom-out}
.lightbox.show{display:flex}
.lightbox img{max-width:94vw;max-height:92vh;border-radius:6px;box-shadow:0 8px 40px rgba(0,0,0,.5)}

/* â”€â”€ JSON Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.editor-toolbar{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.json-editor{
  width:100%;min-height:520px;padding:18px;border-radius:var(--radius);
  border:1px solid var(--border);background:var(--surface);color:var(--text);
  font-family:var(--mono);font-size:.82rem;line-height:1.55;resize:vertical;
  tab-size:2;white-space:pre;overflow:auto
}
.json-editor:focus{outline:none;border-color:var(--primary)}
.json-status{font-size:.8rem;margin-top:8px}
.json-status.valid{color:var(--success)}
.json-status.invalid{color:var(--error)}

/* â”€â”€ Field Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
.field-card{background:var(--surface);border-radius:var(--radius);padding:14px 16px;border:1px solid var(--border)}
.field-card.low-conf{border-color:var(--error);border-width:2px}
.field-card.mid-conf{border-color:var(--warning)}
.field-card .field-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.field-card .field-name{font-size:.82rem;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;font-weight:600}
.field-card .field-input{width:100%;padding:8px 12px;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:.9rem;font-family:var(--font)}
.field-card .field-input:focus{outline:none;border-color:var(--primary)}
.field-card .field-meta{font-size:.75rem;color:var(--muted);margin-top:6px;display:flex;gap:10px;flex-wrap:wrap}
.field-card .field-source{font-size:.7rem;padding:1px 6px;border-radius:8px;background:var(--primary-bg);color:var(--primary)}
.view-toggle{display:flex;gap:2px;background:var(--surface2);border-radius:var(--radius);padding:2px;margin-bottom:14px}
.view-toggle .vt-btn{padding:6px 16px;border:none;background:transparent;color:var(--muted);font-size:.84rem;cursor:pointer;border-radius:8px;font-weight:500;transition:.2s}
.view-toggle .vt-btn.active{background:var(--primary);color:#fff}
.result-table{width:100%;border-collapse:collapse;font-size:.84rem;background:var(--surface);border-radius:var(--radius);overflow:hidden;border:1px solid var(--border)}
.result-table th{background:var(--surface2);padding:8px 12px;text-align:left;font-weight:600;color:var(--muted);font-size:.78rem;text-transform:uppercase}
.result-table td{padding:7px 12px;border-top:1px solid var(--border)}
.result-table td input{width:100%;background:transparent;border:none;color:var(--text);font-size:.84rem;padding:2px 0;font-family:var(--font)}
.result-table td input:focus{outline:none;border-bottom:1px solid var(--primary)}

/* â”€â”€ Stats Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats{display:flex;gap:14px;flex-wrap:wrap;margin:16px 0}
.stat{background:var(--surface);border-radius:var(--radius);padding:14px 20px;min-width:130px;border:1px solid var(--border)}
.stat .value{font-size:1.5rem;font-weight:700;color:var(--primary)}
.stat .label{font-size:.78rem;color:var(--muted);margin-top:2px}

/* â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty{text-align:center;padding:60px 20px;color:var(--muted)}
.empty .icon{font-size:3rem;margin-bottom:12px;opacity:.4}

/* â”€â”€ History Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.history-table{width:100%;border-collapse:collapse;font-size:.84rem}
.history-table th{text-align:left;padding:10px 14px;background:var(--surface2);color:var(--muted);font-weight:600;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
.history-table td{padding:10px 14px;border-bottom:1px solid var(--border);color:var(--text)}
.history-table tr:hover td{background:var(--surface)}
.history-table tbody tr{cursor:pointer}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.status-dot.completed{background:var(--success)}
.status-dot.failed{background:var(--error)}
.status-dot.processing,.status-dot.queued{background:var(--warning)}
.history-table-wrap{border:1px solid var(--border);border-radius:var(--radius);background:var(--surface);overflow:auto;max-height:600px}

/* â”€â”€ Cost Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cost-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;margin:16px 0}
.cost-card{background:var(--surface);border-radius:var(--radius);padding:18px 20px;border:1px solid var(--border);position:relative;overflow:hidden}
.cost-card .value{font-size:1.7rem;font-weight:700;margin-bottom:2px}
.cost-card .value.money{color:var(--success)}
.cost-card .value.count{color:var(--primary)}
.cost-card .value.cache{color:var(--warning)}
.cost-card .label{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.cost-card .badge{position:absolute;top:12px;right:12px;font-size:.7rem;padding:2px 8px;border-radius:12px;background:var(--primary-bg);color:var(--primary);font-weight:600}
.cost-section{margin:28px 0 16px}
.cost-section h3{font-size:1rem;font-weight:600;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.cost-actions{display:flex;gap:10px;flex-wrap:wrap;margin:18px 0}
.cost-table{width:100%;border-collapse:collapse;font-size:.82rem}
.cost-table thead{position:sticky;top:0}
.cost-table th{text-align:left;padding:10px 14px;background:var(--surface2);color:var(--muted);font-weight:600;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
.cost-table td{padding:9px 14px;border-bottom:1px solid var(--border);color:var(--text)}
.cost-table tr:hover td{background:var(--surface)}
.cost-table .svc{font-weight:600;display:flex;align-items:center;gap:6px}
.cost-table .svc-di{color:var(--primary)}
.cost-table .svc-gpt{color:var(--success)}
.cost-table .cached-tag{font-size:.7rem;padding:1px 7px;border-radius:10px;background:rgba(245,158,11,.15);color:var(--warning);font-weight:600}
.cost-table .time-col{font-family:var(--mono);font-size:.78rem;color:var(--muted)}
.cost-table-wrap{max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius);background:var(--surface)}
.cache-bar{height:24px;border-radius:12px;background:var(--surface2);overflow:hidden;display:flex;margin-top:8px}
.cache-bar .hits{background:var(--success);transition:width .4s ease}
.cache-bar .misses{background:var(--error);opacity:.4;transition:width .4s ease}
.cache-bar-labels{display:flex;justify-content:space-between;font-size:.75rem;color:var(--muted);margin-top:4px}
.cost-refresh{font-size:.75rem;color:var(--muted);margin-left:auto;display:flex;align-items:center;gap:4px}
.cost-refresh .dot{width:6px;height:6px;border-radius:50%;background:var(--success);display:inline-block;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
.breakdown-row{display:flex;gap:20px;flex-wrap:wrap}
.breakdown-box{flex:1;min-width:220px;background:var(--surface);border-radius:var(--radius);padding:16px 18px;border:1px solid var(--border)}
.breakdown-box h4{font-size:.85rem;color:var(--muted);margin-bottom:10px;font-weight:500}
.breakdown-item{display:flex;justify-content:space-between;padding:5px 0;font-size:.84rem}
.breakdown-item .lbl{color:var(--muted)}
.breakdown-item .val{font-weight:600;font-family:var(--mono)}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:640px){
  .app{padding:12px 14px 40px}
  .artifacts-grid{grid-template-columns:1fr}
  .options{grid-template-columns:1fr 1fr}
  .tabs{overflow-x:auto}
  .field-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header>
    <h1>ğŸ“„ Doc<span>Vision</span></h1>
    <span class="version" id="versionBadge">DocVision Web UI</span>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="upload">â¬† Upload &amp; Scan</div>
    <div class="tab" data-tab="artifacts">ğŸ” Artifacts</div>
    <div class="tab" data-tab="output">ğŸ“ Output</div>
    <div class="tab" data-tab="history">ğŸ“‹ History</div>
    <div class="tab" data-tab="costs">ğŸ’° Cost &amp; Usage</div>
  </div>

  <!-- â”€â”€â”€ UPLOAD PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel active" id="panel-upload">
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.tiff,.tif,.bmp,.webp" multiple>
      <div class="icon">ğŸ“</div>
      <div><strong>Drop documents here</strong> or click to browse</div>
      <p>PDF Â· JPEG Â· PNG Â· TIFF Â· BMP Â· WebP â€” single or multiple files</p>
    </div>

    <!-- Preview area (single file) -->
    <div id="previewArea" style="display:none"></div>

    <!-- File list (batch) -->
    <div id="fileListArea" style="display:none">
      <div class="file-list" id="fileList"></div>
    </div>

    <!-- Processing Mode -->
    <div class="mode-row">
      <label for="modeSelect">Processing Mode</label>
      <select id="modeSelect">
        <option value="local">ğŸ–¥ Local Models</option>
        <option value="azure">â˜ Azure Cloud</option>
      </select>
      <span class="mode-badge local" id="modeBadge">LOCAL</span>
      <label for="docTypeSelect" id="docTypeLabel" style="margin-left:18px;display:none">Document Type</label>
      <select id="docTypeSelect" style="display:none">
        <option value="auto">Auto-detect</option>
        <option value="bol">Bill of Lading</option>
        <option value="invoice">Invoice</option>
        <option value="receipt">Receipt</option>
        <option value="delivery_ticket">Delivery Ticket</option>
      </select>
    </div>

    <details style="margin-top:16px" id="localOptionsDetails">
      <summary style="cursor:pointer;color:var(--muted);font-size:.88rem">âš™ Processing Options</summary>
      <div class="options" id="optionsGrid">
        <label class="opt"><input type="checkbox" name="preprocess" checked> Preprocess</label>
        <label class="opt"><input type="checkbox" name="detect_layout" checked> Layout Detection</label>
        <label class="opt"><input type="checkbox" name="detect_text" checked> Text Detection</label>
        <label class="opt"><input type="checkbox" name="detect_tables" checked> Table Detection</label>
        <label class="opt"><input type="checkbox" name="run_ocr" checked> OCR Recognition</label>
        <label class="opt"><input type="checkbox" name="run_donut"> Donut KIE</label>
        <label class="opt"><input type="checkbox" name="run_layoutlmv3"> LayoutLMv3 KIE</label>
        <label class="opt"><input type="checkbox" name="run_validators" checked> Validators</label>
      </div>
    </details>

    <div style="margin-top:20px;display:flex;gap:10px">
      <button class="btn btn-primary" id="btnProcess" disabled>ğŸš€ Process Document</button>
      <button class="btn btn-primary" id="btnBatch" disabled style="display:none">ğŸš€ Process All Files</button>
    </div>

    <div class="status-bar" id="statusBar">
      <div class="spinner"></div>
      <div class="status-text" id="statusText">Processingâ€¦</div>
      <div class="status-time" id="statusTime">0s</div>
    </div>
  </div>

  <!-- â”€â”€â”€ ARTIFACTS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel" id="panel-artifacts">
    <div id="artifactsContent">
      <div class="empty"><div class="icon">ğŸ”</div><p>Upload and process a document first</p></div>
    </div>
  </div>

  <!-- â”€â”€â”€ OUTPUT PANEL (Field Editor + JSON toggle) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel" id="panel-output">
    <div id="outputContent">
      <div class="empty"><div class="icon">ğŸ“</div><p>Upload and process a document first</p></div>
    </div>
  </div>

  <!-- â”€â”€â”€ HISTORY PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel" id="panel-history">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
      <h2 style="font-size:1.15rem;font-weight:700">Processing History</h2>
      <button class="btn btn-secondary btn-sm" onclick="loadHistory()">ğŸ”„ Refresh</button>
    </div>
    <div class="history-table-wrap">
      <table class="history-table">
        <thead><tr><th>File</th><th>Mode</th><th>Status</th><th>Pages</th><th>Lines</th><th>Tables</th><th>Fields</th><th>Time</th><th>Created</th></tr></thead>
        <tbody id="historyTableBody">
          <tr><td colspan="9" style="text-align:center;color:var(--muted);padding:40px">No documents processed yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- â”€â”€â”€ COST & USAGE PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel" id="panel-costs">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
      <h2 style="font-size:1.15rem;font-weight:700">Azure API Usage</h2>
      <span class="cost-refresh" id="costRefreshIndicator"><span class="dot"></span> Live</span>
    </div>
    <div class="cost-grid" id="costCards">
      <div class="cost-card"><div class="value money" id="ccTotalCost">$0.00</div><div class="label">Estimated Cost</div></div>
      <div class="cost-card"><div class="value count" id="ccTotalCalls">0</div><div class="label">Total API Calls</div></div>
      <div class="cost-card"><div class="value count" id="ccDICalls">0</div><div class="label">Doc Intelligence</div><div class="badge">DI</div></div>
      <div class="cost-card"><div class="value count" id="ccGPTCalls">0</div><div class="label">GPT Vision</div><div class="badge" style="background:rgba(34,197,94,.12);color:var(--success)">GPT</div></div>
      <div class="cost-card"><div class="value count" id="ccPages">0</div><div class="label">Pages Analysed</div></div>
      <div class="cost-card"><div class="value count" id="ccTokens">0</div><div class="label">Tokens Used</div></div>
      <div class="cost-card"><div class="value cache" id="ccCacheHits">0</div><div class="label">Cache Hits</div></div>
      <div class="cost-card"><div class="value money" id="ccSaved">$0.00</div><div class="label">Saved by Cache</div></div>
    </div>

    <div class="cost-section">
      <h3>ğŸ“Š Cache Performance</h3>
      <div class="breakdown-row">
        <div class="breakdown-box" style="flex:2">
          <h4>Hit Rate</h4>
          <div class="cache-bar"><div class="hits" id="cacheHitBar" style="width:0%"></div><div class="misses" id="cacheMissBar" style="width:0%"></div></div>
          <div class="cache-bar-labels"><span id="cacheHitPct">0% hits</span><span id="cacheMissPct">0% misses</span></div>
        </div>
        <div class="breakdown-box">
          <h4>Cache Store</h4>
          <div class="breakdown-item"><span class="lbl">Entries</span><span class="val" id="cacheEntries">0</span></div>
          <div class="breakdown-item"><span class="lbl">Status</span><span class="val" id="cacheStatus">â€”</span></div>
        </div>
      </div>
    </div>

    <div class="cost-section">
      <h3>ğŸ’µ Cost Breakdown</h3>
      <div class="breakdown-row" id="costBreakdown">
        <div class="breakdown-box"><h4>Document Intelligence</h4>
          <div class="breakdown-item"><span class="lbl">Calls</span><span class="val" id="bdDICalls">0</span></div>
          <div class="breakdown-item"><span class="lbl">Pages</span><span class="val" id="bdDIPages">0</span></div>
          <div class="breakdown-item"><span class="lbl">Cost</span><span class="val" id="bdDICost">$0.00</span></div>
        </div>
        <div class="breakdown-box"><h4>GPT Vision</h4>
          <div class="breakdown-item"><span class="lbl">Calls</span><span class="val" id="bdGPTCalls">0</span></div>
          <div class="breakdown-item"><span class="lbl">Tokens</span><span class="val" id="bdGPTTokens">0</span></div>
          <div class="breakdown-item"><span class="lbl">Cost</span><span class="val" id="bdGPTCost">$0.00</span></div>
        </div>
      </div>
    </div>

    <div class="cost-actions">
      <button class="btn btn-secondary btn-sm" onclick="loadCosts()">ğŸ”„ Refresh</button>
      <button class="btn btn-secondary btn-sm" onclick="resetCosts()" style="color:var(--warning)">ğŸ—‘ Reset Counters</button>
      <button class="btn btn-secondary btn-sm" onclick="clearCache()" style="color:var(--error)">ğŸ§¹ Clear Cache</button>
    </div>

    <div class="cost-section">
      <h3>ğŸ“‹ Call History</h3>
      <div class="cost-table-wrap">
        <table class="cost-table">
          <thead><tr><th>Time</th><th>Service</th><th>Model</th><th>Detail</th><th>Latency</th><th>Cost</th><th></th></tr></thead>
          <tbody id="costTableBody">
            <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:30px">No API calls recorded yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Lightbox overlay -->
<div class="lightbox" id="lightbox">
  <img id="lightboxImg" src="">
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DocVision â€” Front-end application logic
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€â”€ Global state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentJobId   = null;
let currentResult  = null;
let selectedFile   = null;
let selectedFiles  = [];        // batch
let processStart   = 0;
let outputView     = 'fields';  // 'fields' | 'json'
let costRefreshTimer = null;

// â”€â”€â”€ DOM helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $  = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

const dropZone      = $('#dropZone');
const fileInput     = $('#fileInput');
const btnProcess    = $('#btnProcess');
const btnBatch      = $('#btnBatch');
const statusBar     = $('#statusBar');
const statusText    = $('#statusText');
const statusTime    = $('#statusTime');
const lightbox      = $('#lightbox');
const lightboxImg   = $('#lightboxImg');
const modeSelect    = $('#modeSelect');
const modeBadge     = $('#modeBadge');
const docTypeSelect = $('#docTypeSelect');
const docTypeLabel  = $('#docTypeLabel');
const localDetails  = $('#localOptionsDetails');

// â”€â”€â”€ Mode toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
modeSelect.addEventListener('change', () => {
  const m = modeSelect.value;
  modeBadge.textContent = m.toUpperCase();
  modeBadge.className = 'mode-badge ' + m;
  const isAzure = m === 'azure';
  localDetails.style.display = isAzure ? 'none' : '';
  docTypeSelect.style.display = isAzure ? '' : 'none';
  docTypeLabel.style.display  = isAzure ? '' : 'none';
});

// â”€â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$$('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    $$('.tab').forEach(t => t.classList.remove('active'));
    $$('.panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    $(`#panel-${tab.dataset.tab}`).classList.add('active');
    if (tab.dataset.tab === 'history') loadHistory();
    if (tab.dataset.tab === 'costs') {
      loadCosts();
      if (!costRefreshTimer) costRefreshTimer = setInterval(loadCosts, 10000);
    } else {
      if (costRefreshTimer) { clearInterval(costRefreshTimer); costRefreshTimer = null; }
    }
  });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FILE SELECTION (single + multi / drag-and-drop)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fileInput.addEventListener('change', e => {
  const files = Array.from(e.target.files);
  if (!files.length) return;
  files.length === 1 ? pickFile(files[0]) : pickFiles(files);
});
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('dragover');
  const files = Array.from(e.dataTransfer.files);
  files.length === 1 ? pickFile(files[0]) : pickFiles(files);
});

function pickFile(f) {
  selectedFile  = f;
  selectedFiles = [];
  btnProcess.disabled = false;
  btnProcess.style.display = '';
  btnBatch.style.display   = 'none';
  $('#fileListArea').style.display = 'none';
  generatePreview(f);
}

function pickFiles(files) {
  selectedFiles = files;
  selectedFile  = null;
  btnProcess.style.display = 'none';
  btnBatch.style.display   = '';
  btnBatch.disabled = false;
  $('#previewArea').style.display   = 'none';
  $('#fileListArea').style.display  = 'block';
  renderFileList();
}

function renderFileList() {
  const el = $('#fileList');
  el.innerHTML = selectedFiles.map((f, i) => {
    const kb  = (f.size / 1024).toFixed(0);
    const ext = f.name.split('.').pop().toUpperCase();
    return `<div class="file-item">
      <span>${ext === 'PDF' ? 'ğŸ“„' : 'ğŸ–¼'}</span>
      <span class="name">${esc(f.name)}</span>
      <span class="size">${kb} KB</span>
      <span class="remove" onclick="removeFile(${i})">âœ•</span>
    </div>`;
  }).join('');
}

function removeFile(idx) {
  selectedFiles = selectedFiles.filter((_, i) => i !== idx);
  if (selectedFiles.length === 0) {
    $('#fileListArea').style.display = 'none';
    btnBatch.style.display = 'none';
  } else if (selectedFiles.length === 1) {
    pickFile(selectedFiles[0]);
  } else {
    renderFileList();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PDF / IMAGE PREVIEW
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generatePreview(f) {
  const area   = $('#previewArea');
  const sizeMB = (f.size / 1024 / 1024).toFixed(2);
  const ext    = f.name.split('.').pop().toUpperCase();
  area.style.display = 'block';
  area.innerHTML = `<div class="preview-area">
    <div class="preview-info">
      <div class="filename">ğŸ“ ${esc(f.name)}</div>
      <div class="meta">${sizeMB} MB Â· ${ext}<br><span id="previewPageInfo"></span></div>
    </div>
  </div>`;

  // For images, show inline preview immediately
  if (['JPG','JPEG','PNG','BMP','WEBP'].includes(ext)) {
    try {
      const url = URL.createObjectURL(f);
      const thumb = document.createElement('img');
      thumb.src = url;
      thumb.className = 'preview-thumb';
      thumb.onclick = () => showLightbox(url);
      area.querySelector('.preview-area').prepend(thumb);
    } catch {}
    return;
  }

  // For PDFs, request server-side thumbnail
  try {
    const form = new FormData();
    form.append('file', f);
    const res = await fetch('/api/preview', { method: 'POST', body: form });
    if (res.ok) {
      const data = await res.json();
      if (data.preview) {
        const thumb = document.createElement('img');
        thumb.src = data.preview;
        thumb.className = 'preview-thumb';
        thumb.onclick = () => showLightbox(data.preview);
        area.querySelector('.preview-area').prepend(thumb);
      }
      const info = $('#previewPageInfo');
      if (info && data.pages) info.textContent = `${data.pages} page${data.pages > 1 ? 's' : ''}`;
    }
  } catch (e) { console.warn('Preview error:', e); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SINGLE-FILE PROCESSING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnProcess.addEventListener('click', async () => {
  if (!selectedFile) return;
  const form = new FormData();
  form.append('file', selectedFile);
  form.append('processing_mode', modeSelect.value);
  form.append('document_type', docTypeSelect.value);
  $$('#optionsGrid input[type=checkbox]').forEach(cb => {
    form.append(cb.name, cb.checked ? 'true' : 'false');
  });

  btnProcess.disabled = true;
  showStatus('Uploading & starting processingâ€¦');

  try {
    const res = await fetch('/api/process', { method: 'POST', body: form });
    if (!res.ok) throw new Error((await res.json()).detail || res.statusText);
    const data = await res.json();
    currentJobId = data.job_id;
    statusText.textContent = 'Processing documentâ€¦ This may take a few minutes.';
    pollStatus();
  } catch (err) {
    statusText.textContent = `âŒ Error: ${err.message}`;
    btnProcess.disabled = false;
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  BATCH PROCESSING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnBatch.addEventListener('click', async () => {
  if (!selectedFiles.length) return;
  const form = new FormData();
  selectedFiles.forEach(f => form.append('files', f));
  form.append('processing_mode', modeSelect.value);
  form.append('document_type', docTypeSelect.value);

  btnBatch.disabled = true;
  showStatus(`Uploading ${selectedFiles.length} filesâ€¦`);

  try {
    const res = await fetch('/api/process/batch', { method: 'POST', body: form });
    if (!res.ok) throw new Error((await res.json()).detail || res.statusText);
    const data = await res.json();
    statusText.textContent = `Processing ${data.count} documentsâ€¦`;
    pollBatchStatus(data.job_ids);
  } catch (err) {
    statusText.textContent = `âŒ Error: ${err.message}`;
    btnBatch.disabled = false;
  }
});

async function pollBatchStatus(jobIds) {
  let allDone = true, completed = 0, failed = 0, processing = 0;
  for (const jid of jobIds) {
    try {
      const r = await fetch(`/api/jobs/${jid}`);
      const j = await r.json();
      if (j.status === 'completed') completed++;
      else if (j.status === 'failed') failed++;
      else { processing++; allDone = false; }
    } catch { allDone = false; processing++; }
  }
  statusText.textContent = `Batch: ${completed} done, ${processing} processing, ${failed} failed`;
  if (allDone) {
    statusText.textContent = `âœ… Batch complete! ${completed} succeeded, ${failed} failed`;
    setTimeout(() => statusBar.classList.remove('show'), 4000);
    btnBatch.disabled = false;
    for (let i = jobIds.length - 1; i >= 0; i--) {
      try {
        const r = await fetch(`/api/jobs/${jobIds[i]}`);
        const j = await r.json();
        if (j.status === 'completed') { currentJobId = jobIds[i]; await loadResult(); await loadArtifacts(); break; }
      } catch {}
    }
    loadCosts(); loadHistory();
  } else {
    setTimeout(() => pollBatchStatus(jobIds), 2000);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  STATUS BAR & POLLING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showStatus(msg) {
  statusBar.classList.add('show');
  statusText.textContent = msg;
  processStart = Date.now();
  tickTimer();
}

function tickTimer() {
  if (!statusBar.classList.contains('show')) return;
  statusTime.textContent = ((Date.now() - processStart) / 1000).toFixed(0) + 's';
  requestAnimationFrame(() => setTimeout(tickTimer, 500));
}

async function pollStatus() {
  try {
    const res = await fetch(`/api/jobs/${currentJobId}`);
    const job = await res.json();
    if (job.status === 'completed') {
      statusText.textContent = 'âœ… Processing complete!';
      setTimeout(() => statusBar.classList.remove('show'), 3000);
      btnProcess.disabled = false;
      await loadResult();
      await loadArtifacts();
      loadCosts();
      $$('.tab')[1].click(); // switch to Artifacts
    } else if (job.status === 'failed') {
      statusText.textContent = `âŒ Failed: ${job.error}`;
      btnProcess.disabled = false;
    } else {
      setTimeout(pollStatus, 1500);
    }
  } catch { setTimeout(pollStatus, 2000); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  LOAD RESULT + ARTIFACTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadResult() {
  const res = await fetch(`/api/jobs/${currentJobId}/result`);
  currentResult = await res.json();
  renderOutput();
}

async function loadArtifacts() {
  const res = await fetch(`/api/jobs/${currentJobId}/artifacts`);
  const data = await res.json();
  renderArtifacts(data.artifacts || []);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CONFIDENCE HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confClass(c) { return c >= 0.8 ? 'high' : c >= 0.5 ? 'mid' : 'low'; }
function confBadge(c) { return `<span class="conf-badge ${confClass(c)}">${(c * 100).toFixed(0)}%</span>`; }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  RENDER ARTIFACTS  (with confidence highlighting)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderArtifacts(artifacts) {
  const el = $('#artifactsContent');
  if (!artifacts.length && !currentResult) {
    el.innerHTML = '<div class="empty"><div class="icon">ğŸ”</div><p>Upload and process a document first</p></div>';
    return;
  }
  let html = '';

  // Stats row
  if (currentResult) {
    html += '<div class="stats">';
    html += stat('Pages', currentResult.page_count || 0);
    html += stat('Text Lines', countLines());
    html += stat('Tables', countTables());
    html += stat('Fields', (currentResult.fields || []).length);
    html += stat('Time', (currentResult.metadata?.processing_time_seconds || 0).toFixed(1) + 's');
    html += '</div>';

    // Confidence legend
    html += `<div class="conf-legend">
      Confidence: <span class="dot" style="background:var(--conf-high)"></span> High (â‰¥80%)
      <span class="dot" style="background:var(--conf-mid)"></span> Medium (50-79%)
      <span class="dot" style="background:var(--conf-low)"></span> Low (&lt;50%)
    </div>`;

    // Per-page confidence summary with low-confidence line details
    if (currentResult.pages) {
      currentResult.pages.forEach((page, pi) => {
        const pageNum = page.page_number || (pi + 1);
        const lines = page.text_lines || [];
        if (!lines.length) return;
        const lowLines = lines.filter(l => (l.confidence||0) < 0.5);
        const midLines = lines.filter(l => (l.confidence||0) >= 0.5 && (l.confidence||0) < 0.8);
        const highCount = lines.length - midLines.length - lowLines.length;
        if (lowLines.length || midLines.length) {
          html += `<div style="margin:10px 0;padding:10px 14px;background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);font-size:.84rem">`;
          html += `<strong>Page ${pageNum}</strong> â€” ${lines.length} lines: `;
          html += `<span class="conf-high">${highCount} high</span>, `;
          html += `<span class="conf-mid">${midLines.length} medium</span>, `;
          html += `<span class="conf-low">${lowLines.length} low</span>`;
          if (lowLines.length) {
            html += `<details style="margin-top:6px"><summary style="cursor:pointer;color:var(--error);font-size:.8rem">âš  ${lowLines.length} low-confidence line(s)</summary>`;
            html += `<div style="margin-top:6px;font-family:var(--mono);font-size:.78rem">`;
            lowLines.forEach(l => {
              html += `<div style="padding:3px 0;color:var(--conf-low)">â€¢ ${confBadge(l.confidence||0)} "${esc(l.text)}"</div>`;
            });
            html += '</div></details>';
          }
          html += '</div>';
        }
      });
    }
  }

  // Group artifacts by page
  if (artifacts.length) {
    const pages = {};
    artifacts.forEach(a => {
      const m = a.name.match(/page_(\d+)/);
      const pn = m ? parseInt(m[1]) : 0;
      if (!pages[pn]) pages[pn] = [];
      pages[pn].push(a);
    });

    for (const [pageNum, arts] of Object.entries(pages)) {
      html += `<h3 style="margin:20px 0 10px;color:var(--muted)">Page ${pageNum}</h3>`;
      html += '<div class="artifacts-grid">';
      for (const a of arts) {
        const friendly = a.name.replace(/page_\d+_/, '').replace(/_/g, ' ');
        html += `<div class="artifact-card">
          <img src="${a.url}" alt="${esc(a.name)}" onclick="showLightbox('${a.url}')" loading="lazy">
          <div class="label"><span>${friendly}</span><span>${a.size_kb} KB</span></div>
        </div>`;
      }
      html += '</div>';
    }
  } else if (!currentResult) {
    html += '<div class="empty"><div class="icon">ğŸ”</div><p>No artifacts generated</p></div>';
  }

  el.innerHTML = html;
}

function stat(lbl, val) { return `<div class="stat"><div class="value">${val}</div><div class="label">${lbl}</div></div>`; }
function countLines() {
  if (!currentResult?.pages) return 0;
  return currentResult.pages.reduce((s, p) => s + (p.text_lines?.length || 0), 0);
}
function countTables() {
  if (currentResult?.tables) return currentResult.tables.length;
  if (!currentResult?.pages) return 0;
  return currentResult.pages.reduce((s, p) => s + (p.tables?.length || 0), 0);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  RENDER OUTPUT  (Fields â†” JSON toggle)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOutput() {
  const el = $('#outputContent');
  if (!currentResult) {
    el.innerHTML = '<div class="empty"><div class="icon">ğŸ“</div><p>No result yet</p></div>';
    return;
  }

  let html = `
    <div class="view-toggle">
      <button class="vt-btn ${outputView === 'fields' ? 'active' : ''}" onclick="switchView('fields')">ğŸ“‹ Fields &amp; Tables</button>
      <button class="vt-btn ${outputView === 'json' ? 'active' : ''}" onclick="switchView('json')">{ } JSON Editor</button>
    </div>
    <div class="editor-toolbar">
      <button class="btn btn-success btn-sm" onclick="saveAllEdits()">ğŸ’¾ Save Edits</button>
      <button class="btn btn-primary btn-sm" onclick="saveToDisk()">ğŸ“‚ Save to Disk</button>
      <button class="btn btn-secondary btn-sm" onclick="downloadJson()">â¬‡ Download</button>
    </div>`;

  html += outputView === 'fields' ? renderFieldEditor() : renderJsonEditor();
  html += '<div class="json-status" id="jsonStatus"></div>';
  el.innerHTML = html;

  if (outputView === 'json') {
    const ed = $('#jsonEditor');
    if (ed) { ed.addEventListener('input', validateJson); validateJson(); }
  }
}

function switchView(view) {
  if (outputView === 'json' && view === 'fields') {
    const ed = $('#jsonEditor');
    if (ed) { try { currentResult = JSON.parse(ed.value); } catch {} }
  }
  if (outputView === 'fields' && view === 'json') syncFieldEdits();
  outputView = view;
  renderOutput();
}

// â”€â”€ Field Editor view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFieldEditor() {
  let html = '';
  const fields = currentResult.fields || [];
  const tables = currentResult.tables || [];

  // â”€ Fields â”€
  if (fields.length) {
    html += `<div class="cost-section"><h3>ğŸ“‹ Extracted Fields (${fields.length})</h3></div>`;
    html += `<div class="conf-legend">
      Confidence: <span class="dot" style="background:var(--conf-high)"></span> High
      <span class="dot" style="background:var(--conf-mid)"></span> Medium
      <span class="dot" style="background:var(--conf-low)"></span> Low â€” edit inline to correct
    </div>`;
    html += '<div class="field-grid">';
    fields.forEach((f, i) => {
      const c = f.confidence || 0;
      const cls = c < 0.5 ? 'low-conf' : c < 0.8 ? 'mid-conf' : '';
      const src = f.source ? `<span class="field-source">${f.source}</span>` : '';
      html += `<div class="field-card ${cls}">
        <div class="field-header">
          <span class="field-name">${esc(f.name || 'unnamed')}</span>
          ${confBadge(c)}
        </div>
        <input class="field-input" data-field-idx="${i}" value="${escAttr(f.value ?? '')}" placeholder="(empty)">
        <div class="field-meta">
          <span>Type: ${f.field_type || 'string'}</span>
          ${f.status ? `<span>Status: ${f.status}</span>` : ''}
          ${src}
        </div>
      </div>`;
    });
    html += '</div>';
  } else {
    html += '<div style="margin:20px 0;padding:20px;background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);color:var(--muted);text-align:center">No fields extracted â€” try Azure mode or enable Donut / LayoutLMv3 KIE</div>';
  }

  // â”€ Tables â”€
  if (tables.length) {
    html += `<div class="cost-section"><h3>ğŸ“Š Tables (${tables.length})</h3></div>`;
    tables.forEach((table, ti) => {
      const cells = table.cells || [];
      html += `<div style="margin-bottom:20px">`;
      html += `<div style="font-size:.85rem;color:var(--muted);margin-bottom:8px">Table ${ti + 1} â€” ${table.row_count || table.rows || '?'} rows Ã— ${table.col_count || table.columns || '?'} cols ${confBadge(table.confidence || 0)}</div>`;
      if (cells.length) {
        const maxR = Math.max(...cells.map(c => c.row));
        const maxC = Math.max(...cells.map(c => c.col || c.column || 0));
        html += '<div style="overflow-x:auto"><table class="result-table"><tbody>';
        for (let r = 0; r <= maxR; r++) {
          html += '<tr>';
          for (let c = 0; c <= maxC; c++) {
            const cell = cells.find(x => x.row === r && (x.col === c || x.column === c));
            const txt = cell?.text || '';
            const cc = cell?.confidence || 0;
            const tag = (cell?.is_header || r === 0) ? 'th' : 'td';
            html += `<${tag}><input data-table="${ti}" data-row="${r}" data-col="${c}" value="${escAttr(txt)}" style="color:var(--conf-${confClass(cc)})"></${tag}>`;
          }
          html += '</tr>';
        }
        html += '</tbody></table></div>';
      }
      html += '</div>';
    });
  }

  // â”€ Text lines per page (collapsible) â”€
  if (currentResult.pages) {
    html += '<div class="cost-section"><h3>ğŸ“ƒ Text Lines by Page</h3></div>';
    currentResult.pages.forEach((page, pi) => {
      const lines = page.text_lines || [];
      if (!lines.length) return;
      html += `<details style="margin-bottom:10px"><summary style="cursor:pointer;color:var(--muted);font-size:.88rem;padding:6px 0">Page ${page.page_number || pi + 1} â€” ${lines.length} lines</summary><div style="margin-top:6px">`;
      lines.forEach(l => {
        const c = l.confidence || 0;
        html += `<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:.84rem">
          ${confBadge(c)}
          <span style="color:var(--conf-${confClass(c)});font-family:var(--mono);font-size:.8rem">${esc(l.text)}</span>
          <span style="color:var(--muted);font-size:.72rem;margin-left:auto">${l.content_type || ''}</span>
        </div>`;
      });
      html += '</div></details>';
    });
  }

  return html;
}

// â”€â”€ JSON Editor view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderJsonEditor() {
  const jsonStr = JSON.stringify(currentResult, null, 2);
  return `
    <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap">
      <input style="flex:1;min-width:200px;padding:8px 14px;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:.88rem;font-family:var(--mono)"
             id="jsonSearch" placeholder="ğŸ” Search in JSONâ€¦" oninput="highlightJson()">
      <button class="btn btn-secondary btn-sm" onclick="formatJson()">Format</button>
      <button class="btn btn-secondary btn-sm" onclick="collapseJson()">Collapse</button>
    </div>
    <textarea class="json-editor" id="jsonEditor" spellcheck="false">${esc(jsonStr)}</textarea>`;
}

function syncFieldEdits() {
  if (!currentResult) return;
  $$('.field-input[data-field-idx]').forEach(inp => {
    const idx = parseInt(inp.dataset.fieldIdx);
    if (currentResult.fields?.[idx]) currentResult.fields[idx].value = inp.value;
  });
  $$('input[data-table]').forEach(inp => {
    const ti = parseInt(inp.dataset.table);
    const row = parseInt(inp.dataset.row);
    const col = parseInt(inp.dataset.col);
    const cell = currentResult.tables?.[ti]?.cells?.find(c => c.row === row && (c.col === col || c.column === col));
    if (cell) cell.text = inp.value;
  });
}

function validateJson() {
  const ed = $('#jsonEditor'), st = $('#jsonStatus');
  if (!ed || !st) return;
  try { JSON.parse(ed.value); st.textContent = 'âœ“ Valid JSON'; st.className = 'json-status valid'; }
  catch (e) { st.textContent = 'âœ— ' + e.message; st.className = 'json-status invalid'; }
}
function formatJson() {
  const ed = $('#jsonEditor');
  try { ed.value = JSON.stringify(JSON.parse(ed.value), null, 2); validateJson(); } catch {}
}
function collapseJson() {
  const ed = $('#jsonEditor');
  try { ed.value = JSON.stringify(JSON.parse(ed.value)); validateJson(); } catch {}
}
function highlightJson() {
  const term = $('#jsonSearch')?.value;
  if (!term) return;
  const ed = $('#jsonEditor');
  const idx = ed.value.toLowerCase().indexOf(term.toLowerCase());
  if (idx !== -1) {
    ed.focus(); ed.setSelectionRange(idx, idx + term.length);
    ed.scrollTop = ed.value.substring(0, idx).split('\n').length * 18 - 100;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SAVE / DOWNLOAD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveAllEdits() {
  if (!currentJobId) return;
  if (outputView === 'fields') syncFieldEdits();
  else {
    const ed = $('#jsonEditor');
    if (ed) { try { currentResult = JSON.parse(ed.value); } catch { return alert('Fix JSON errors before saving'); } }
  }
  const res = await fetch(`/api/jobs/${currentJobId}/result`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(currentResult)
  });
  if (res.ok) { const st = $('#jsonStatus'); if (st) { st.textContent = 'âœ“ Saved successfully'; st.className = 'json-status valid'; } }
}

function downloadJson() {
  if (!currentResult) return;
  const blob = new Blob([JSON.stringify(currentResult, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = (currentResult?.metadata?.filename || 'document').replace(/\.[^.]+$/, '') + '_result.json';
  a.click(); URL.revokeObjectURL(url);
}

async function saveToDisk() {
  if (!currentJobId) return alert('No processed document to save');
  if (outputView === 'fields') syncFieldEdits();
  else {
    const ed = $('#jsonEditor');
    if (ed) { try { currentResult = JSON.parse(ed.value); } catch { return alert('Fix JSON errors first'); } }
  }
  await fetch(`/api/jobs/${currentJobId}/result`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(currentResult)
  });
  try {
    const res = await fetch(`/api/jobs/${currentJobId}/save`, { method: 'POST' });
    if (!res.ok) { const e = await res.json(); throw new Error(e.detail || 'Save failed'); }
    const data = await res.json();
    const st = $('#jsonStatus');
    if (st) { st.textContent = `âœ“ Saved to ${data.path}`; st.className = 'json-status valid'; }
  } catch (e) { alert('Failed to save: ' + e.message); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  HISTORY PANEL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHistory() {
  try {
    const res = await fetch('/api/history');
    if (!res.ok) return;
    renderHistory((await res.json()).jobs);
  } catch (e) { console.warn('History load error:', e); }
}

function renderHistory(jobs) {
  const tbody = $('#historyTableBody');
  if (!jobs?.length) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--muted);padding:40px">No documents processed yet</td></tr>';
    return;
  }
  tbody.innerHTML = jobs.map(j => {
    const mode = j.processing_mode === 'azure' ? 'â˜ Azure' : 'ğŸ–¥ Local';
    const dot  = `<span class="status-dot ${j.status}"></span>${j.status}`;
    const time = j.processing_time ? j.processing_time.toFixed(1) + 's' : 'â€”';
    const created = j.created ? new Date(j.created).toLocaleString() : 'â€”';
    return `<tr onclick="loadJob('${j.job_id}')">
      <td><strong>${esc(j.filename)}</strong></td>
      <td>${mode}</td><td>${dot}</td>
      <td>${j.page_count ?? 'â€”'}</td><td>${j.text_lines ?? 'â€”'}</td>
      <td>${j.tables ?? 'â€”'}</td><td>${j.fields ?? 'â€”'}</td>
      <td style="font-family:var(--mono);font-size:.8rem">${time}</td>
      <td style="font-size:.8rem;color:var(--muted)">${created}</td>
    </tr>`;
  }).join('');
}

async function loadJob(jobId) {
  currentJobId = jobId;
  try { await loadResult(); await loadArtifacts(); $$('.tab')[1].click(); }
  catch (e) { alert('Could not load job: ' + e.message); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  COST & USAGE DASHBOARD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCosts() {
  try {
    const res = await fetch('/api/costs');
    if (!res.ok) return;
    renderCosts(await res.json());
  } catch (e) { console.warn('Costs load error:', e); }
}

function renderCosts(data) {
  const c = data.costs || {};
  const cache = data.cache || {};

  $('#ccTotalCost').textContent  = '$' + (c.estimated_cost_usd || 0).toFixed(4);
  $('#ccTotalCalls').textContent = c.total_calls || 0;
  $('#ccDICalls').textContent    = c.total_di_calls || 0;
  $('#ccGPTCalls').textContent   = c.total_gpt_calls || 0;
  $('#ccPages').textContent      = c.total_pages_analysed || 0;
  $('#ccTokens').textContent     = (c.total_tokens || 0).toLocaleString();
  $('#ccCacheHits').textContent  = c.cache_hits || 0;
  $('#ccSaved').textContent      = '$' + (c.cost_saved_by_cache_usd || 0).toFixed(4);

  const hits = cache.hits || 0, misses = cache.misses || 0, total = hits + misses;
  const hitPct = total > 0 ? (hits / total * 100) : 0;
  $('#cacheHitBar').style.width  = hitPct + '%';
  $('#cacheMissBar').style.width = (100 - hitPct) + '%';
  $('#cacheHitPct').textContent  = hitPct.toFixed(0) + '% hits (' + hits + ')';
  $('#cacheMissPct').textContent = (100 - hitPct).toFixed(0) + '% misses (' + misses + ')';
  $('#cacheEntries').textContent = cache.entries || 0;
  const cs = $('#cacheStatus');
  cs.textContent = cache.enabled ? 'âœ“ Active' : 'â—‹ Inactive';
  cs.style.color = cache.enabled ? 'var(--success)' : 'var(--muted)';

  const records = c.records || [];
  let diCost = 0, gptCost = 0, diPages = 0, gptTokens = 0;
  records.forEach(r => {
    if (r.service === 'doc_intelligence') { diCost += r.estimated_cost_usd; diPages += r.pages; }
    else if (r.service === 'gpt_vision') { gptCost += r.estimated_cost_usd; gptTokens += (r.prompt_tokens || 0) + (r.completion_tokens || 0); }
  });
  $('#bdDICalls').textContent  = c.total_di_calls || 0;
  $('#bdDIPages').textContent  = diPages;
  $('#bdDICost').textContent   = '$' + diCost.toFixed(4);
  $('#bdGPTCalls').textContent = c.total_gpt_calls || 0;
  $('#bdGPTTokens').textContent = gptTokens.toLocaleString();
  $('#bdGPTCost').textContent  = '$' + gptCost.toFixed(4);

  const tbody = $('#costTableBody');
  if (!records.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:30px">No API calls recorded yet</td></tr>';
    return;
  }
  tbody.innerHTML = [...records].reverse().map(r => {
    const svcCls = r.service === 'doc_intelligence' ? 'svc-di' : 'svc-gpt';
    const svcLbl = r.service === 'doc_intelligence' ? 'ğŸ” DI' : 'ğŸ¤– GPT';
    const detail = r.service === 'doc_intelligence'
      ? (r.pages || 0) + ' page' + ((r.pages || 0) !== 1 ? 's' : '')
      : ((r.prompt_tokens || 0) + (r.completion_tokens || 0)).toLocaleString() + ' tok';
    const ts = r.timestamp ? new Date(r.timestamp).toLocaleTimeString() : 'â€”';
    const cached = r.cached ? '<span class="cached-tag">CACHED</span>' : '';
    return `<tr><td class="time-col">${ts}</td><td><span class="svc ${svcCls}">${svcLbl}</span></td><td>${r.model || 'â€”'}</td><td>${detail}</td><td class="time-col">${(r.latency_seconds || 0).toFixed(1)}s</td><td>$${(r.estimated_cost_usd || 0).toFixed(4)}</td><td>${cached}</td></tr>`;
  }).join('');
}

async function resetCosts() {
  if (!confirm('Reset all cost tracking counters?')) return;
  try { await fetch('/api/costs/reset', { method: 'POST' }); await loadCosts(); } catch (e) { alert('Failed: ' + e.message); }
}
async function clearCache() {
  if (!confirm('Clear the entire Azure response cache?')) return;
  try {
    const res = await fetch('/api/cache/clear', { method: 'POST' });
    const data = await res.json();
    alert(`Cache cleared â€” ${data.entries_cleared} entries removed`);
    await loadCosts();
  } catch (e) { alert('Failed: ' + e.message); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  LIGHTBOX
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLightbox(url) {
  lightboxImg.src = url;
  lightbox.classList.add('show');
}
lightbox.addEventListener('click', () => lightbox.classList.remove('show'));
document.addEventListener('keydown', e => { if (e.key === 'Escape') lightbox.classList.remove('show'); });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  UTILITY
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escAttr(s) { return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>
