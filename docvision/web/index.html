<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DocVision — Document Scanner</title>
<style>
/* ── Reset & Base ───────────────────────────────────────────────── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1117;--surface:#1a1d27;--surface2:#242836;--surface3:#2e3345;
  --border:#363b4e;--text:#e4e6f0;--muted:#8890a4;
  --primary:#6366f1;--primary-hover:#818cf8;--primary-bg:rgba(99,102,241,.12);
  --success:#22c55e;--warning:#f59e0b;--error:#ef4444;
  --radius:10px;--shadow:0 4px 24px rgba(0,0,0,.35);
  --font:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  --mono:'Cascadia Code','Fira Code','JetBrains Mono',monospace;
  --conf-high:#22c55e;--conf-mid:#f59e0b;--conf-low:#ef4444;
}
html{font-size:15px}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh}
a{color:var(--primary);text-decoration:none}

/* ── Layout ─────────────────────────────────────────────────────── */
.app{max-width:1800px;margin:0 auto;padding:20px 28px 60px}
@media(min-width:1400px){.app{max-width:95vw}}
header{display:flex;align-items:center;gap:14px;padding:18px 0 28px;border-bottom:1px solid var(--border)}
header h1{font-size:1.55rem;font-weight:700;letter-spacing:-.3px}
header h1 span{color:var(--primary)}
header .version{font-size:.78rem;color:var(--muted);margin-left:auto}

/* ── Tabs ───────────────────────────────────────────────────────── */
.tabs{display:flex;gap:6px;margin:24px 0 20px;border-bottom:2px solid var(--border);padding-bottom:0;overflow:hidden}
.tab{padding:10px 22px;cursor:pointer;font-size:.9rem;font-weight:500;color:var(--muted);border-bottom:2px solid transparent;margin-bottom:-2px;transition:.2s;user-select:none;border-radius:var(--radius) var(--radius) 0 0;white-space:nowrap}
.tab:hover{color:var(--text);background:var(--surface)}
.tab.active{color:var(--primary);border-bottom-color:var(--primary);background:var(--surface)}
.panel{display:none}
.panel.active{display:block}

/* ── Upload Panel ───────────────────────────────────────────────── */
.drop-zone{
  border:2px dashed var(--border);border-radius:var(--radius);padding:56px 28px;
  text-align:center;cursor:pointer;transition:.3s;position:relative;
  background:var(--surface)
}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--primary);background:var(--primary-bg)}
.drop-zone .icon{font-size:3rem;margin-bottom:14px;opacity:.6}
.drop-zone p{color:var(--muted);margin-top:6px;font-size:.88rem}
.drop-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}

/* ── Preview ───────────────────────────────────────────────────── */
.preview-area{display:flex;gap:20px;margin:16px 0;align-items:flex-start;flex-wrap:wrap}
.preview-thumb{border-radius:var(--radius);border:1px solid var(--border);max-height:220px;background:#000;object-fit:contain}
.preview-info{flex:1;min-width:200px}
.preview-info .filename{font-weight:600;font-size:1rem;margin-bottom:6px;word-break:break-all}
.preview-info .meta{font-size:.84rem;color:var(--muted);line-height:1.6}
.file-list{margin:12px 0;max-height:240px;overflow-y:auto}
.file-item{display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface);border-radius:var(--radius);margin-bottom:6px;font-size:.85rem;border:1px solid var(--border)}
.file-item .name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-item .size{color:var(--muted);font-family:var(--mono);font-size:.78rem}
.file-item .remove{cursor:pointer;color:var(--error);font-size:1.1rem;padding:0 4px}

/* ── Options Grid ──────────────────────────────────────────────── */
.options{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:10px;margin:20px 0}
.opt{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--surface);border-radius:var(--radius);font-size:.85rem}
.opt input[type=checkbox]{accent-color:var(--primary);width:16px;height:16px}
.mode-row{display:flex;gap:14px;margin:18px 0 10px;flex-wrap:wrap;align-items:center}
.mode-row label{font-size:.88rem;color:var(--muted);font-weight:500}
.mode-row select{
  padding:8px 14px;border-radius:var(--radius);border:1px solid var(--border);
  background:var(--surface);color:var(--text);font-size:.88rem;cursor:pointer;
  min-width:180px
}
.mode-row select:focus{outline:none;border-color:var(--primary)}
.mode-badge{font-size:.72rem;padding:3px 10px;border-radius:20px;font-weight:600;letter-spacing:.3px}
.mode-badge.local{background:rgba(99,102,241,.15);color:var(--primary)}
.mode-badge.azure{background:rgba(34,197,94,.15);color:var(--success)}

/* ── Buttons ────────────────────────────────────────────────────── */
.btn{
  display:inline-flex;align-items:center;gap:8px;padding:10px 24px;
  border:none;border-radius:var(--radius);font-size:.9rem;font-weight:600;
  cursor:pointer;transition:.2s
}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:var(--primary-hover)}
.btn-primary:disabled{opacity:.45;cursor:not-allowed}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--surface3)}
.btn-success{background:var(--success);color:#fff}
.btn-sm{padding:6px 14px;font-size:.82rem}
.btn-danger{background:var(--error);color:#fff}
.btn-danger:hover{background:#dc2626}

/* ── Progress / Status ─────────────────────────────────────────── */
.status-bar{margin:20px 0;padding:16px 20px;border-radius:var(--radius);background:var(--surface);display:none;align-items:center;gap:14px}
.status-bar.show{display:flex}
.spinner{width:22px;height:22px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.status-text{flex:1;font-size:.9rem}
.status-time{font-size:.8rem;color:var(--muted);font-family:var(--mono)}

/* ── Artifact Grid ─────────────────────────────────────────────── */
.artifacts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(400px,1fr));gap:18px;margin-top:16px}
@media(min-width:1400px){.artifacts-grid{grid-template-columns:repeat(auto-fill,minmax(450px,1fr))}}
.artifact-card{background:var(--surface);border-radius:var(--radius);overflow:hidden;border:1px solid var(--border);transition:.2s}
.artifact-card:hover{border-color:var(--primary);box-shadow:var(--shadow)}
.artifact-card img{width:100%;display:block;cursor:pointer;background:#000}
.artifact-card .label{padding:10px 14px;font-size:.82rem;color:var(--muted);display:flex;justify-content:space-between}

/* ── Confidence Highlighting ───────────────────────────────────── */
.conf-legend{display:flex;gap:16px;margin:12px 0;font-size:.8rem;color:var(--muted);align-items:center;flex-wrap:wrap}
.conf-legend .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:4px}
.conf-high{color:var(--conf-high)}
.conf-mid{color:var(--conf-mid)}
.conf-low{color:var(--conf-low)}
.conf-badge{font-size:.7rem;padding:1px 6px;border-radius:8px;font-weight:600;font-family:var(--mono)}
.conf-badge.high{background:rgba(34,197,94,.15);color:var(--conf-high)}
.conf-badge.mid{background:rgba(245,158,11,.15);color:var(--conf-mid)}
.conf-badge.low{background:rgba(239,68,68,.15);color:var(--conf-low)}

/* ── Lightbox ──────────────────────────────────────────────────── */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:999;display:none;justify-content:center;align-items:center;cursor:zoom-out}
.lightbox.show{display:flex}
.lightbox img{max-width:94vw;max-height:92vh;border-radius:6px;box-shadow:0 8px 40px rgba(0,0,0,.5)}

/* ── JSON Editor ───────────────────────────────────────────────── */
.editor-toolbar{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.json-editor{
  width:100%;min-height:520px;padding:18px;border-radius:var(--radius);
  border:1px solid var(--border);background:var(--surface);color:var(--text);
  font-family:var(--mono);font-size:.82rem;line-height:1.55;resize:vertical;
  tab-size:2;white-space:pre;overflow:auto
}
.json-editor:focus{outline:none;border-color:var(--primary)}
.json-status{font-size:.8rem;margin-top:8px}
.json-status.valid{color:var(--success)}
.json-status.invalid{color:var(--error)}

/* ── Field Editor ──────────────────────────────────────────────── */
.field-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
.field-card{background:var(--surface);border-radius:var(--radius);padding:14px 16px;border:1px solid var(--border)}
.field-card.low-conf{border-color:var(--error);border-width:2px}
.field-card.mid-conf{border-color:var(--warning)}
.field-card .field-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.field-card .field-name{font-size:.82rem;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;font-weight:600}
.field-card .field-input{width:100%;padding:8px 12px;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:.9rem;font-family:var(--font)}
.field-card .field-input:focus{outline:none;border-color:var(--primary)}
.field-card .field-meta{font-size:.75rem;color:var(--muted);margin-top:6px;display:flex;gap:10px;flex-wrap:wrap}
.field-card .field-source{font-size:.7rem;padding:1px 6px;border-radius:8px;background:var(--primary-bg);color:var(--primary)}
.view-toggle{display:flex;gap:2px;background:var(--surface2);border-radius:var(--radius);padding:2px;margin-bottom:14px}
.view-toggle .vt-btn{padding:6px 16px;border:none;background:transparent;color:var(--muted);font-size:.84rem;cursor:pointer;border-radius:8px;font-weight:500;transition:.2s}
.view-toggle .vt-btn.active{background:var(--primary);color:#fff}
.result-table{width:100%;border-collapse:collapse;font-size:.84rem;background:var(--surface);border-radius:var(--radius);overflow:hidden;border:1px solid var(--border)}
.result-table th{background:var(--surface2);padding:8px 12px;text-align:left;font-weight:600;color:var(--text);font-size:.78rem;text-transform:uppercase;letter-spacing:.4px}
.result-table td{padding:7px 12px;border-top:1px solid var(--border)}
.result-table td input{width:100%;background:transparent;border:none;color:var(--text);font-size:.84rem;padding:2px 0;font-family:var(--font)}
.result-table td input:focus{outline:none;border-bottom:1px solid var(--primary)}

/* ── Stats Row ─────────────────────────────────────────────────── */
.stats{display:flex;gap:14px;flex-wrap:wrap;margin:16px 0}
.stat{background:var(--surface);border-radius:var(--radius);padding:14px 20px;min-width:130px;border:1px solid var(--border)}
.stat .value{font-size:1.5rem;font-weight:700;color:var(--primary)}
.stat .label{font-size:.78rem;color:var(--muted);margin-top:2px}

/* ── Empty State ───────────────────────────────────────────────── */
.empty{text-align:center;padding:60px 20px;color:var(--muted)}
.empty .icon{font-size:3rem;margin-bottom:12px;opacity:.4}

/* ── History Panel ─────────────────────────────────────────────── */
.history-table{width:100%;border-collapse:collapse;font-size:.84rem}
.history-table th{text-align:left;padding:10px 14px;background:var(--surface2);color:var(--muted);font-weight:600;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
.history-table td{padding:10px 14px;border-bottom:1px solid var(--border);color:var(--text)}
.history-table tr:hover td{background:var(--surface)}
.history-table tbody tr{cursor:pointer}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
.status-dot.completed{background:var(--success)}
.status-dot.failed{background:var(--error)}
.status-dot.processing,.status-dot.queued{background:var(--warning)}
.history-table-wrap{border:1px solid var(--border);border-radius:var(--radius);background:var(--surface);overflow:auto;max-height:600px}

/* ── Cost Dashboard ────────────────────────────────────────────── */
.cost-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;margin:16px 0}
.cost-card{background:var(--surface);border-radius:var(--radius);padding:18px 20px;border:1px solid var(--border);position:relative;overflow:hidden}
.cost-card .value{font-size:1.7rem;font-weight:700;margin-bottom:2px}
.cost-card .value.money{color:var(--success)}
.cost-card .value.count{color:var(--primary)}
.cost-card .value.cache{color:var(--warning)}
.cost-card .label{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.cost-card .badge{position:absolute;top:12px;right:12px;font-size:.7rem;padding:2px 8px;border-radius:12px;background:var(--primary-bg);color:var(--primary);font-weight:600}
.cost-section{margin:28px 0 16px}
.cost-section h3{font-size:1rem;font-weight:600;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.cost-actions{display:flex;gap:10px;flex-wrap:wrap;margin:18px 0}
.cost-table{width:100%;border-collapse:collapse;font-size:.82rem}
.cost-table thead{position:sticky;top:0}
.cost-table th{text-align:left;padding:10px 14px;background:var(--surface2);color:var(--muted);font-weight:600;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
.cost-table td{padding:9px 14px;border-bottom:1px solid var(--border);color:var(--text)}
.cost-table tr:hover td{background:var(--surface)}
.cost-table .svc{font-weight:600;display:flex;align-items:center;gap:6px}
.cost-table .svc-di{color:var(--primary)}
.cost-table .svc-gpt{color:var(--success)}
.cost-table .cached-tag{font-size:.7rem;padding:1px 7px;border-radius:10px;background:rgba(245,158,11,.15);color:var(--warning);font-weight:600}
.cost-table .time-col{font-family:var(--mono);font-size:.78rem;color:var(--muted)}
.cost-table-wrap{max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius);background:var(--surface)}
.cache-bar{height:24px;border-radius:12px;background:var(--surface2);overflow:hidden;display:flex;margin-top:8px}
.cache-bar .hits{background:var(--success);transition:width .4s ease}
.cache-bar .misses{background:var(--error);opacity:.4;transition:width .4s ease}
.cache-bar-labels{display:flex;justify-content:space-between;font-size:.75rem;color:var(--muted);margin-top:4px}
.cost-refresh{font-size:.75rem;color:var(--muted);margin-left:auto;display:flex;align-items:center;gap:4px}
.cost-refresh .dot{width:6px;height:6px;border-radius:50%;background:var(--success);display:inline-block;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
.breakdown-row{display:flex;gap:20px;flex-wrap:wrap}
.breakdown-box{flex:1;min-width:220px;background:var(--surface);border-radius:var(--radius);padding:16px 18px;border:1px solid var(--border)}
.breakdown-box h4{font-size:.85rem;color:var(--muted);margin-bottom:10px;font-weight:500}
.breakdown-item{display:flex;justify-content:space-between;padding:5px 0;font-size:.84rem}
.breakdown-item .lbl{color:var(--muted)}
.breakdown-item .val{font-weight:600;font-family:var(--mono)}

/* ── Report Viewer ──────────────────────────────────────────────── */
.report{font-size:.9rem;line-height:1.7;color:var(--text)}
.report h2{font-size:1.2rem;font-weight:700;margin:28px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.report h3{font-size:1rem;font-weight:600;margin:22px 0 10px;color:var(--muted);display:flex;align-items:center;gap:6px}
.report h4{font-size:.92rem;font-weight:600;margin:16px 0 8px}
.report hr{border:none;border-top:1px solid var(--border);margin:24px 0}
.report-meta{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin:12px 0 18px}
.report-meta-item{background:var(--surface);border-radius:var(--radius);padding:10px 14px;border:1px solid var(--border)}
.report-meta-item .rml{font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.report-meta-item .rmv{font-size:.95rem;font-weight:600;margin-top:2px;word-break:break-all}
.report-table{width:100%;border-collapse:collapse;margin:10px 0 16px;font-size:.84rem;background:var(--surface);border-radius:var(--radius);overflow:hidden;border:1px solid var(--border)}
.report-table th{background:var(--surface2);padding:9px 14px;text-align:left;font-weight:600;color:var(--text);font-size:.78rem;text-transform:uppercase;letter-spacing:.4px;white-space:nowrap}
.report-table td{padding:8px 14px;border-top:1px solid var(--border);vertical-align:top}
.report-table tr:hover td{background:rgba(99,102,241,.04)}
.report-table td.num{text-align:right;font-family:var(--mono);font-size:.82rem}
.spatial-badge{display:inline-flex;align-items:center;gap:4px;font-size:.68rem;padding:2px 8px;border-radius:12px;background:var(--primary-bg);color:var(--primary);font-family:var(--mono);white-space:nowrap;font-weight:600}
.spatial-badge.page-loc{background:rgba(34,197,94,.1);color:var(--success)}
.page-section{background:var(--surface);border-radius:var(--radius);padding:18px 22px;margin:14px 0;border:1px solid var(--border)}
.page-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:12px}
.page-header .page-num{font-size:1.05rem;font-weight:700;display:flex;align-items:center;gap:6px}
.page-header .page-info{font-size:.78rem;color:var(--muted);display:flex;gap:12px}
.field-group{margin:14px 0}
.field-row{display:flex;align-items:flex-start;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);font-size:.86rem}
.field-row:last-child{border-bottom:none}
.field-row .fr-name{min-width:160px;font-weight:600;color:var(--muted);font-size:.8rem;text-transform:uppercase;letter-spacing:.3px;padding-top:2px}
.field-row .fr-value{flex:1;font-weight:500;word-break:break-word}
.field-row .fr-conf{display:flex;align-items:center;gap:6px;min-width:90px;justify-content:flex-end}
.field-row .fr-source{font-size:.7rem;padding:1px 6px;border-radius:8px;background:var(--primary-bg);color:var(--primary);white-space:nowrap}
.conf-bar{width:48px;height:6px;border-radius:3px;background:var(--surface3);overflow:hidden;display:inline-block}
.conf-bar-fill{height:100%;border-radius:3px;transition:width .3s}
.conf-bar-fill.high{background:var(--conf-high)}
.conf-bar-fill.mid{background:var(--conf-mid)}
.conf-bar-fill.low{background:var(--conf-low)}
.status-pill{font-size:.7rem;padding:2px 8px;border-radius:10px;font-weight:600;white-space:nowrap}
.status-pill.confident,.status-pill.validated{background:rgba(34,197,94,.12);color:var(--success)}
.status-pill.uncertain{background:rgba(245,158,11,.12);color:var(--warning)}
.status-pill.single_source{background:rgba(99,102,241,.12);color:var(--primary)}
.status-pill.validation_failed{background:rgba(239,68,68,.12);color:var(--error)}
.rpt-table-wrap{overflow-x:auto;margin:10px 0 16px;border:1px solid var(--border);border-radius:var(--radius)}
.rpt-table{width:100%;border-collapse:collapse;font-size:.84rem;background:var(--surface);min-width:400px}
.rpt-table th{background:var(--surface2);padding:10px 14px;text-align:left;font-weight:600;color:var(--text);font-size:.82rem;white-space:nowrap;border-bottom:2px solid var(--border)}
.rpt-table td{padding:9px 14px;border-top:1px solid var(--border)}
.rpt-table tr:hover td{background:rgba(99,102,241,.04)}
.rpt-table td.cell-high{border-left:3px solid var(--conf-high)}
.rpt-table td.cell-mid{border-left:3px solid var(--conf-mid)}
.rpt-table td.cell-low{border-left:3px solid var(--conf-low)}
.candidates-toggle{cursor:pointer;color:var(--primary);font-size:.78rem;font-weight:500;padding:2px 0}
.candidates-panel{margin:6px 0 4px 12px;font-size:.8rem;display:none}
.candidates-panel.show{display:block}
.candidate-row{display:flex;gap:10px;padding:3px 0;color:var(--muted)}
.candidate-row .cr-src{font-weight:600;min-width:100px}
.validation-box{padding:16px 20px;border-radius:var(--radius);margin:14px 0;border:1px solid}
.validation-box.passed{background:rgba(34,197,94,.06);border-color:rgba(34,197,94,.25)}
.validation-box.failed{background:rgba(239,68,68,.06);border-color:rgba(239,68,68,.25)}
.validation-box .vb-header{display:flex;align-items:center;gap:8px;font-weight:700;font-size:1rem;margin-bottom:6px}
.validation-box .vb-stats{font-size:.84rem;color:var(--muted);margin-bottom:8px}
.issue-item{padding:4px 0;font-size:.84rem;color:var(--warning)}

/* ── Job Selector ──────────────────────────────────────────────── */
.job-selector{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--surface);border-radius:var(--radius);margin-bottom:16px;border:1px solid var(--border)}
.job-selector label{font-weight:600;font-size:.88rem;color:var(--muted)}
.job-selector select{flex:1;padding:8px 14px;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:.88rem;cursor:pointer;max-width:400px}
.job-selector select:focus{outline:none;border-color:var(--primary)}
.job-selector .status-indicator{font-size:.78rem;padding:3px 10px;border-radius:12px;font-weight:600}
.job-selector .status-indicator.completed{background:rgba(34,197,94,.15);color:var(--success)}
.job-selector .status-indicator.failed{background:rgba(239,68,68,.15);color:var(--error)}
.job-selector .status-indicator.processing{background:rgba(245,158,11,.15);color:var(--warning)}

/* ── Spatial OCR View ───────────────────────────────────────────── */
.spatial-viewer{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden}
.spatial-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px;gap:16px;color:var(--muted)}
.spatial-page-nav{display:flex;align-items:center;justify-content:center;gap:16px;padding:12px;background:var(--surface2);border-bottom:1px solid var(--border)}
.spatial-page-nav button{padding:6px 14px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:var(--radius);cursor:pointer;font-size:.85rem}
.spatial-page-nav button:hover:not(:disabled){background:var(--primary);color:#fff;border-color:var(--primary)}
.spatial-page-nav button:disabled{opacity:.4;cursor:not-allowed}
.spatial-page-nav .page-info{font-size:.9rem;color:var(--muted);font-weight:500}
.spatial-container{display:grid;grid-template-columns:1fr 1fr;gap:0;max-height:80vh;overflow:auto}
@media(min-width:1400px){.spatial-container{max-height:85vh}}
.spatial-side{position:relative;min-height:500px}
.spatial-side.image-side{background:#1a1a1a;display:flex;align-items:flex-start;justify-content:center;padding:20px;border-right:1px solid var(--border);overflow:auto}
.spatial-side.image-side img{max-width:100%;height:auto;box-shadow:0 4px 20px rgba(0,0,0,.3)}
.spatial-side.text-side{background:#f8f8f8;padding:10px;overflow:auto}
.spatial-reconstructed{position:relative;background:#fff;margin:0 auto;box-shadow:0 2px 12px rgba(0,0,0,.15)}
/* Spatial text elements - confidence color coding */
.spatial-text{position:absolute;font-size:12px;line-height:1.2;font-family:'Segoe UI',system-ui,sans-serif;padding:2px 5px;border-radius:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer;max-width:250px;z-index:1;transition:all 0.15s ease;border-left:3px solid}
/* High confidence (>=70%): Green */
.spatial-text.high-conf{background:rgba(220,252,231,0.95);border-color:#22c55e;color:#166534;border-left-color:#22c55e}
/* Medium confidence (50-70%): Orange/Amber */
.spatial-text.med-conf{background:rgba(254,243,199,0.95);border-color:#f59e0b;color:#92400e;border-left-color:#f59e0b}
/* Low confidence (<50%): Red */
.spatial-text.low-conf{background:rgba(254,226,226,0.95);border-color:#ef4444;color:#dc2626;border-left-color:#dc2626;font-weight:500}
.spatial-text:hover{overflow:visible;white-space:normal;word-wrap:break-word;max-width:350px;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,0.25);font-size:13px}
.spatial-text.high-conf:hover{background:#dcfce7;border-color:#16a34a}
.spatial-text.med-conf:hover{background:#fef3c7;border-color:#d97706}
.spatial-text.low-conf:hover{background:#fee2e2;border-color:#dc2626}
/* Spatial table elements */
.spatial-table{position:absolute;border:2px solid #333;background:rgba(255,255,255,0.95);z-index:5}
.spatial-table-cell{position:absolute;font-size:11px;line-height:1.2;padding:2px 4px;font-family:'Segoe UI',system-ui,sans-serif;border:1px solid #aaa;background:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;box-sizing:border-box;z-index:6;cursor:pointer;transition:all 0.15s ease;border-left:3px solid}
.spatial-table-cell:hover{overflow:visible;white-space:normal;word-wrap:break-word;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,0.2);font-size:12px}
.spatial-table-cell.header{font-weight:600;background:#e0e0e0}
.spatial-table-cell.high-conf{background:rgba(220,252,231,0.95);border-left-color:#22c55e;color:#166534}
.spatial-table-cell.med-conf{background:rgba(254,243,199,0.95);border-left-color:#f59e0b;color:#92400e}
.spatial-table-cell.low-conf{background:rgba(254,226,226,0.95);border-left-color:#dc2626;color:#dc2626;font-weight:500}
.spatial-no-data{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px;gap:12px;color:var(--muted);text-align:center}
.spatial-no-data .icon{font-size:2.5rem;opacity:.6}
.spatial-footer{padding:8px 16px;background:var(--surface2);border-top:1px solid var(--border);font-size:.75rem;color:var(--muted);text-align:center}
/* Document Grid Layout (Spatial Right Panel) */
.doc-grid{font-family:'Segoe UI',system-ui,sans-serif;font-size:13px;line-height:1.5;color:#1a1a1a;padding:8px}
.doc-row{display:flex;flex-wrap:wrap;gap:8px;padding:4px 0;border-bottom:1px solid #eee}
.doc-row.row-gap{margin-top:16px;padding-top:12px;border-top:2px solid #ddd}
.doc-cell{padding:2px 6px;background:#fff;border-radius:3px}
.doc-cell.left{flex:0 0 auto;max-width:35%}
.doc-cell.center{flex:1 1 auto;text-align:center}
.doc-cell.right{flex:0 0 auto;max-width:35%;margin-left:auto;text-align:right}
.doc-cell.full{flex:1 1 100%}
.doc-cell.low-conf{background:#fef3c7;color:#92400e}
.doc-cell.very-low-conf{background:#fee2e2;color:#991b1b}
.doc-table-section{margin:16px 0;padding:12px;background:#fff;border:1px solid #ddd;border-radius:6px}
.doc-table-section.row-gap{margin-top:24px}
.doc-table-section .table-header{font-size:11px;color:#666;margin-bottom:8px;font-weight:500}
.doc-table-section table{width:100%;border-collapse:collapse;font-size:12px}
.doc-table-section th,.doc-table-section td{border:1px solid #ccc;padding:6px 8px;text-align:left}
.doc-table-section th{background:#f5f5f5;font-weight:600}
.doc-table-section td{background:#fff}
@media(max-width:900px){.spatial-container{grid-template-columns:1fr}.spatial-side.image-side{border-right:none;border-bottom:1px solid var(--border)}}

/* ── Responsive ────────────────────────────────────────────────── */
@media(max-width:640px){
  .app{padding:12px 14px 40px}
  .artifacts-grid{grid-template-columns:1fr}
  .options{grid-template-columns:1fr 1fr}
  .tabs{overflow-x:auto}
  .field-grid{grid-template-columns:1fr}
  .report-meta{grid-template-columns:1fr}
  .field-row{flex-direction:column;gap:4px}
  .field-row .fr-conf{justify-content:flex-start}
}
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header>
    <h1>📄 Doc<span>Vision</span></h1>
    <span class="version" id="versionBadge">DocVision Web UI</span>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="upload"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Upload</div>
    <div class="tab" data-tab="artifacts"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Artifacts</div>
    <div class="tab" data-tab="output"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Output</div>
    <div class="tab" data-tab="history"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>History</div>
    <div class="tab" data-tab="costs"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-3px;margin-right:6px"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Costs</div>
  </div>

  <!-- ─── UPLOAD PANEL ──────────────────────────────────────────── -->
  <div class="panel active" id="panel-upload">
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.tiff,.tif,.bmp,.webp" multiple>
      <div class="icon">📁</div>
      <div><strong>Drop documents here</strong> or click to browse</div>
      <p>PDF · JPEG · PNG · TIFF · BMP · WebP — single or multiple files</p>
    </div>

    <!-- Preview area (single file) -->
    <div id="previewArea" style="display:none"></div>

    <!-- File list (batch) -->
    <div id="fileListArea" style="display:none">
      <div class="file-list" id="fileList"></div>
    </div>

    <!-- Processing Mode -->
    <div class="mode-row">
      <label for="modeSelect">Processing Mode</label>
      <select id="modeSelect">
        <option value="local">🖥 Local Models</option>
        <option value="azure">☁ Azure Cloud</option>
      </select>
      <span class="mode-badge local" id="modeBadge">LOCAL</span>
      <label for="docTypeSelect" id="docTypeLabel" style="margin-left:18px;display:none">Document Type</label>
      <select id="docTypeSelect" style="display:none">
        <option value="auto">Auto-detect</option>
        <option value="bol">Bill of Lading</option>
        <option value="invoice">Invoice</option>
        <option value="receipt">Receipt</option>
        <option value="delivery_ticket">Delivery Ticket</option>
      </select>
    </div>

    <details style="margin-top:16px" id="localOptionsDetails">
      <summary style="cursor:pointer;color:var(--muted);font-size:.88rem">⚙ Processing Options</summary>
      <div class="options" id="optionsGrid">
        <label class="opt"><input type="checkbox" name="preprocess" checked> Preprocess</label>
        <label class="opt"><input type="checkbox" name="detect_layout" checked> Layout Detection</label>
        <label class="opt"><input type="checkbox" name="detect_text" checked> Text Detection</label>
        <label class="opt"><input type="checkbox" name="detect_tables" checked> Table Detection</label>
        <label class="opt"><input type="checkbox" name="run_ocr" checked> OCR Recognition</label>
        <label class="opt"><input type="checkbox" name="run_donut"> Donut KIE</label>
        <label class="opt"><input type="checkbox" name="run_layoutlmv3"> LayoutLMv3 KIE</label>
        <label class="opt"><input type="checkbox" name="run_validators" checked> Validators</label>
      </div>
    </details>

    <div style="margin-top:20px;display:flex;gap:10px">
      <button class="btn btn-primary" id="btnProcess" disabled>🚀 Process Document</button>
      <button class="btn btn-primary" id="btnBatch" disabled style="display:none">🚀 Process All Files</button>
    </div>

    <div class="status-bar" id="statusBar">
      <div class="spinner"></div>
      <div class="status-text" id="statusText">Processing…</div>
      <div class="status-time" id="statusTime">0s</div>
    </div>
  </div>

  <!-- ─── ARTIFACTS PANEL ───────────────────────────────────────── -->
  <div class="panel" id="panel-artifacts">
    <div id="artifactsJobSelector" class="job-selector" style="display:none">
      <label>Document:</label>
      <select id="artifactsJobSelect" onchange="onArtifactsJobChange(this.value)"></select>
    </div>
    <div id="artifactsContent">
      <div class="empty"><div class="icon">🔍</div><p>Upload and process a document first</p></div>
    </div>
  </div>

  <!-- ─── OUTPUT PANEL (Field Editor + JSON toggle) ─────────────── -->
  <div class="panel" id="panel-output">
    <div id="outputJobSelector" class="job-selector" style="display:none">
      <label>Document:</label>
      <select id="outputJobSelect" onchange="onOutputJobChange(this.value)"></select>
    </div>
    <div id="outputContent">
      <div class="empty"><div class="icon">📝</div><p>Upload and process a document first</p></div>
    </div>
  </div>

  <!-- ─── HISTORY PANEL ─────────────────────────────────────────── -->
  <div class="panel" id="panel-history">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
      <h2 style="font-size:1.15rem;font-weight:700">Processing History</h2>
      <button class="btn btn-secondary btn-sm" onclick="loadHistory()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>Refresh</button>
    </div>
    <div class="history-table-wrap">
      <table class="history-table">
        <thead><tr><th>File</th><th>Mode</th><th>Status</th><th>Pages</th><th>Lines</th><th>Tables</th><th>Fields</th><th>Time</th><th>Created</th></tr></thead>
        <tbody id="historyTableBody">
          <tr><td colspan="9" style="text-align:center;color:var(--muted);padding:40px">No documents processed yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ─── COST & USAGE PANEL ────────────────────────────────────── -->
  <div class="panel" id="panel-costs">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
      <h2 style="font-size:1.15rem;font-weight:700">Azure API Usage</h2>
      <span class="cost-refresh" id="costRefreshIndicator"><span class="dot"></span> Live</span>
    </div>
    <div class="cost-grid" id="costCards">
      <div class="cost-card"><div class="value money" id="ccTotalCost">$0.00</div><div class="label">Estimated Cost</div></div>
      <div class="cost-card"><div class="value count" id="ccTotalCalls">0</div><div class="label">Total API Calls</div></div>
      <div class="cost-card"><div class="value count" id="ccDICalls">0</div><div class="label">Doc Intelligence</div><div class="badge">DI</div></div>
      <div class="cost-card"><div class="value count" id="ccGPTCalls">0</div><div class="label">GPT Vision</div><div class="badge" style="background:rgba(34,197,94,.12);color:var(--success)">GPT</div></div>
      <div class="cost-card"><div class="value count" id="ccPages">0</div><div class="label">Pages Analysed</div></div>
      <div class="cost-card"><div class="value count" id="ccTokens">0</div><div class="label">Tokens Used</div></div>
      <div class="cost-card"><div class="value cache" id="ccCacheHits">0</div><div class="label">Cache Hits</div></div>
      <div class="cost-card"><div class="value money" id="ccSaved">$0.00</div><div class="label">Saved by Cache</div></div>
    </div>

    <div class="cost-section">
      <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:6px"><path d="M21 21H4.6c-.6 0-1.1-.2-1.4-.6-.4-.4-.6-.9-.6-1.4V3"/><path d="m7 14 4-4 4 4 6-6"/></svg>Cache Performance</h3>
      <div class="breakdown-row">
        <div class="breakdown-box" style="flex:2">
          <h4>Hit Rate</h4>
          <div class="cache-bar"><div class="hits" id="cacheHitBar" style="width:0%"></div><div class="misses" id="cacheMissBar" style="width:0%"></div></div>
          <div class="cache-bar-labels"><span id="cacheHitPct">0% hits</span><span id="cacheMissPct">0% misses</span></div>
        </div>
        <div class="breakdown-box">
          <h4>Cache Store</h4>
          <div class="breakdown-item"><span class="lbl">Entries</span><span class="val" id="cacheEntries">0</span></div>
          <div class="breakdown-item"><span class="lbl">Status</span><span class="val" id="cacheStatus">—</span></div>
        </div>
      </div>
    </div>

    <div class="cost-section">
      <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:6px"><circle cx="12" cy="12" r="10"/><path d="M12 6v12"/><path d="M15.5 9.4a3.5 3.5 0 1 0 0 5.2"/></svg>Cost Breakdown</h3>
      <div class="breakdown-row" id="costBreakdown">
        <div class="breakdown-box"><h4>Document Intelligence</h4>
          <div class="breakdown-item"><span class="lbl">Calls</span><span class="val" id="bdDICalls">0</span></div>
          <div class="breakdown-item"><span class="lbl">Pages</span><span class="val" id="bdDIPages">0</span></div>
          <div class="breakdown-item"><span class="lbl">Cost</span><span class="val" id="bdDICost">$0.00</span></div>
        </div>
        <div class="breakdown-box"><h4>GPT Vision</h4>
          <div class="breakdown-item"><span class="lbl">Calls</span><span class="val" id="bdGPTCalls">0</span></div>
          <div class="breakdown-item"><span class="lbl">Tokens</span><span class="val" id="bdGPTTokens">0</span></div>
          <div class="breakdown-item"><span class="lbl">Cost</span><span class="val" id="bdGPTCost">$0.00</span></div>
        </div>
      </div>
    </div>

    <div class="cost-actions">
      <button class="btn btn-secondary btn-sm" onclick="loadCosts()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>Refresh</button>
      <button class="btn btn-secondary btn-sm" onclick="resetCosts()" style="color:var(--warning)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M3 6h18"/><path d="M8 6V4c0-.5.2-1 .6-1.4C9 2.2 9.5 2 10 2h4c.5 0 1 .2 1.4.6.4.4.6.9.6 1.4v2"/><path d="M19 6v14c0 .5-.2 1-.6 1.4-.4.4-.9.6-1.4.6H7c-.5 0-1-.2-1.4-.6-.4-.4-.6-.9-.6-1.4V6"/></svg>Reset Counters</button>
      <button class="btn btn-secondary btn-sm" onclick="clearCache()" style="color:var(--error)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M4 4l16 16"/><path d="M9 5h9a2 2 0 0 1 2 2v9"/><path d="M3 12v7a2 2 0 0 0 2 2h12"/><path d="m7 9 2.9 2.9"/><path d="M15 5v4"/></svg>Clear Cache</button>
    </div>

    <div class="cost-section">
      <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:6px"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>Call History</h3>
      <div class="cost-table-wrap">
        <table class="cost-table">
          <thead><tr><th>Time</th><th>Service</th><th>Model</th><th>Detail</th><th>Latency</th><th>Cost</th><th></th></tr></thead>
          <tbody id="costTableBody">
            <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:30px">No API calls recorded yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Lightbox overlay -->
<div class="lightbox" id="lightbox">
  <img id="lightboxImg" src="">
</div>

<script>
/* ════════════════════════════════════════════════════════════════════
   DocVision — Front-end application logic
   ════════════════════════════════════════════════════════════════════ */

// ─── Global state ─────────────────────────────────────────────────
let currentJobId   = null;
let currentResult  = null;
let selectedFile   = null;
let selectedFiles  = [];        // batch
let batchJobIds    = [];        // all job IDs from batch processing
let batchJobInfos  = {};        // map job_id -> {filename, status}
let processStart   = 0;
let outputView     = 'fields';  // 'fields' | 'report' | 'markdown' | 'json'
let markdownContent = null;     // cached markdown content
let costRefreshTimer = null;

// ─── DOM helpers ──────────────────────────────────────────────────
const $  = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

const dropZone      = $('#dropZone');
const fileInput     = $('#fileInput');
const btnProcess    = $('#btnProcess');
const btnBatch      = $('#btnBatch');
const statusBar     = $('#statusBar');
const statusText    = $('#statusText');
const statusTime    = $('#statusTime');
const lightbox      = $('#lightbox');
const lightboxImg   = $('#lightboxImg');
const modeSelect    = $('#modeSelect');
const modeBadge     = $('#modeBadge');
const docTypeSelect = $('#docTypeSelect');
const docTypeLabel  = $('#docTypeLabel');
const localDetails  = $('#localOptionsDetails');

// ─── Mode toggle ──────────────────────────────────────────────────
modeSelect.addEventListener('change', () => {
  const m = modeSelect.value;
  modeBadge.textContent = m.toUpperCase();
  modeBadge.className = 'mode-badge ' + m;
  const isAzure = m === 'azure';
  localDetails.style.display = isAzure ? 'none' : '';
  docTypeSelect.style.display = isAzure ? '' : 'none';
  docTypeLabel.style.display  = isAzure ? '' : 'none';
});

// ─── Tab switching ────────────────────────────────────────────────
$$('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    $$('.tab').forEach(t => t.classList.remove('active'));
    $$('.panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    $(`#panel-${tab.dataset.tab}`).classList.add('active');
    if (tab.dataset.tab === 'history') loadHistory();
    if (tab.dataset.tab === 'costs') {
      loadCosts();
      if (!costRefreshTimer) costRefreshTimer = setInterval(loadCosts, 10000);
    } else {
      if (costRefreshTimer) { clearInterval(costRefreshTimer); costRefreshTimer = null; }
    }
  });
});

// ──────────────────────────────────────────────────────────────────
//  FILE SELECTION (single + multi / drag-and-drop)
// ──────────────────────────────────────────────────────────────────
fileInput.addEventListener('change', e => {
  const files = Array.from(e.target.files);
  if (!files.length) return;
  files.length === 1 ? pickFile(files[0]) : pickFiles(files);
});
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('dragover');
  const files = Array.from(e.dataTransfer.files);
  files.length === 1 ? pickFile(files[0]) : pickFiles(files);
});

function pickFile(f) {
  selectedFile  = f;
  selectedFiles = [];
  btnProcess.disabled = false;
  btnProcess.style.display = '';
  btnBatch.style.display   = 'none';
  $('#fileListArea').style.display = 'none';
  generatePreview(f);
}

function pickFiles(files) {
  selectedFiles = files;
  selectedFile  = null;
  btnProcess.style.display = 'none';
  btnBatch.style.display   = '';
  btnBatch.disabled = false;
  $('#previewArea').style.display   = 'none';
  $('#fileListArea').style.display  = 'block';
  renderFileList();
}

function renderFileList() {
  const el = $('#fileList');
  el.innerHTML = selectedFiles.map((f, i) => {
    const kb  = (f.size / 1024).toFixed(0);
    const ext = f.name.split('.').pop().toUpperCase();
    return `<div class="file-item">
      <span>${ext === 'PDF' ? '📄' : '🖼'}</span>
      <span class="name">${esc(f.name)}</span>
      <span class="size">${kb} KB</span>
      <span class="remove" onclick="removeFile(${i})">✕</span>
    </div>`;
  }).join('');
}

function removeFile(idx) {
  selectedFiles = selectedFiles.filter((_, i) => i !== idx);
  if (selectedFiles.length === 0) {
    $('#fileListArea').style.display = 'none';
    btnBatch.style.display = 'none';
  } else if (selectedFiles.length === 1) {
    pickFile(selectedFiles[0]);
  } else {
    renderFileList();
  }
}

// ──────────────────────────────────────────────────────────────────
//  PDF / IMAGE PREVIEW
// ──────────────────────────────────────────────────────────────────
async function generatePreview(f) {
  const area   = $('#previewArea');
  const sizeMB = (f.size / 1024 / 1024).toFixed(2);
  const ext    = f.name.split('.').pop().toUpperCase();
  area.style.display = 'block';
  area.innerHTML = `<div class="preview-area">
    <div class="preview-info">
      <div class="filename">📎 ${esc(f.name)}</div>
      <div class="meta">${sizeMB} MB · ${ext}<br><span id="previewPageInfo"></span></div>
    </div>
  </div>`;

  // For images, show inline preview immediately
  if (['JPG','JPEG','PNG','BMP','WEBP'].includes(ext)) {
    try {
      const url = URL.createObjectURL(f);
      const thumb = document.createElement('img');
      thumb.src = url;
      thumb.className = 'preview-thumb';
      thumb.onclick = () => showLightbox(url);
      area.querySelector('.preview-area').prepend(thumb);
    } catch {}
    return;
  }

  // For PDFs, request server-side thumbnail
  try {
    const form = new FormData();
    form.append('file', f);
    const res = await fetch('/api/preview', { method: 'POST', body: form });
    if (res.ok) {
      const data = await res.json();
      if (data.preview) {
        const thumb = document.createElement('img');
        thumb.src = data.preview;
        thumb.className = 'preview-thumb';
        thumb.onclick = () => showLightbox(data.preview);
        area.querySelector('.preview-area').prepend(thumb);
      }
      const info = $('#previewPageInfo');
      if (info && data.pages) info.textContent = `${data.pages} page${data.pages > 1 ? 's' : ''}`;
    }
  } catch (e) { console.warn('Preview error:', e); }
}

// ──────────────────────────────────────────────────────────────────
//  SINGLE-FILE PROCESSING
// ──────────────────────────────────────────────────────────────────
btnProcess.addEventListener('click', async () => {
  if (!selectedFile) return;
  const form = new FormData();
  form.append('file', selectedFile);
  form.append('processing_mode', modeSelect.value);
  form.append('document_type', docTypeSelect.value);
  $$('#optionsGrid input[type=checkbox]').forEach(cb => {
    form.append(cb.name, cb.checked ? 'true' : 'false');
  });

  btnProcess.disabled = true;
  showStatus('Uploading & starting processing…');

  try {
    const res = await fetch('/api/process', { method: 'POST', body: form });
    if (!res.ok) throw new Error((await res.json()).detail || res.statusText);
    const data = await res.json();
    currentJobId = data.job_id;
    statusText.textContent = 'Processing document… This may take a few minutes.';
    pollStatus();
  } catch (err) {
    statusText.textContent = `❌ Error: ${err.message}`;
    btnProcess.disabled = false;
  }
});

// ──────────────────────────────────────────────────────────────────
//  BATCH PROCESSING
// ──────────────────────────────────────────────────────────────────
btnBatch.addEventListener('click', async () => {
  if (!selectedFiles.length) return;
  const form = new FormData();
  
  // Store filenames for batch job tracking
  const filenames = selectedFiles.map(f => f.name);
  
  selectedFiles.forEach(f => form.append('files', f));
  form.append('processing_mode', modeSelect.value);
  form.append('document_type', docTypeSelect.value);

  btnBatch.disabled = true;
  showStatus(`Uploading ${selectedFiles.length} files…`);

  try {
    const res = await fetch('/api/process/batch', { method: 'POST', body: form });
    if (!res.ok) throw new Error((await res.json()).detail || res.statusText);
    const data = await res.json();
    
    // Store batch job IDs and initialize job info
    batchJobIds = data.job_ids;
    batchJobInfos = {};
    data.job_ids.forEach((jid, i) => {
      batchJobInfos[jid] = { filename: filenames[i] || `Document ${i+1}`, status: 'queued' };
    });
    
    statusText.textContent = `Processing ${data.count} documents…`;
    pollBatchStatus(data.job_ids);
  } catch (err) {
    statusText.textContent = `❌ Error: ${err.message}`;
    btnBatch.disabled = false;
  }
});

async function pollBatchStatus(jobIds) {
  let allDone = true, completed = 0, failed = 0, processing = 0;
  for (const jid of jobIds) {
    try {
      const r = await fetch(`/api/jobs/${jid}`);
      const j = await r.json();
      // Update job info
      if (batchJobInfos[jid]) {
        batchJobInfos[jid].status = j.status;
        batchJobInfos[jid].filename = j.filename || batchJobInfos[jid].filename;
      }
      if (j.status === 'completed') completed++;
      else if (j.status === 'failed') failed++;
      else { processing++; allDone = false; }
    } catch { allDone = false; processing++; }
  }
  statusText.textContent = `Batch: ${completed} done, ${processing} processing, ${failed} failed`;
  if (allDone) {
    statusText.textContent = `✅ Batch complete! ${completed} succeeded, ${failed} failed`;
    setTimeout(() => statusBar.classList.remove('show'), 4000);
    btnBatch.disabled = false;
    
    // Populate job selectors for batch results
    populateBatchJobSelectors();
    
    // Load the first completed job
    for (let i = 0; i < jobIds.length; i++) {
      try {
        const r = await fetch(`/api/jobs/${jobIds[i]}`);
        const j = await r.json();
        if (j.status === 'completed') { 
          currentJobId = jobIds[i]; 
          await loadResult(); 
          await loadArtifacts(); 
          break; 
        }
      } catch {}
    }
    loadCosts(); loadHistory();
  } else {
    setTimeout(() => pollBatchStatus(jobIds), 2000);
  }
}

// ──────────────────────────────────────────────────────────────────
//  STATUS BAR & POLLING
// ──────────────────────────────────────────────────────────────────
function showStatus(msg) {
  statusBar.classList.add('show');
  statusText.textContent = msg;
  processStart = Date.now();
  tickTimer();
}

function tickTimer() {
  if (!statusBar.classList.contains('show')) return;
  statusTime.textContent = ((Date.now() - processStart) / 1000).toFixed(0) + 's';
  requestAnimationFrame(() => setTimeout(tickTimer, 500));
}

async function pollStatus() {
  try {
    const res = await fetch(`/api/jobs/${currentJobId}`);
    if (!res.ok) {
      // Job not found (e.g. stale ID after server restart) — stop polling
      statusText.textContent = '⚠️ Job not found — please resubmit';
      setTimeout(() => statusBar.classList.remove('show'), 4000);
      btnProcess.disabled = false;
      return;
    }
    const job = await res.json();
    if (job.status === 'completed') {
      statusText.textContent = '✅ Processing complete!';
      setTimeout(() => statusBar.classList.remove('show'), 3000);
      btnProcess.disabled = false;
      // Clear batch state for single file processing
      batchJobIds = [];
      batchJobInfos = {};
      hideJobSelectors();
      await loadResult();
      await loadArtifacts();
      loadCosts();
      $$('.tab')[1].click(); // switch to Artifacts
    } else if (job.status === 'failed') {
      statusText.textContent = `❌ Failed: ${job.error}`;
      btnProcess.disabled = false;
    } else {
      setTimeout(pollStatus, 1500);
    }
  } catch { setTimeout(pollStatus, 2000); }
}

// ──────────────────────────────────────────────────────────────────
//  BATCH JOB SELECTORS
// ──────────────────────────────────────────────────────────────────
function populateBatchJobSelectors() {
  if (batchJobIds.length <= 1) {
    hideJobSelectors();
    return;
  }
  
  const artifactsSelector = $('#artifactsJobSelector');
  const outputSelector = $('#outputJobSelector');
  const artifactsSelect = $('#artifactsJobSelect');
  const outputSelect = $('#outputJobSelect');
  
  // Build options HTML
  let optionsHtml = '';
  batchJobIds.forEach((jid, index) => {
    const info = batchJobInfos[jid] || {};
    const filename = info.filename || `Document ${index + 1}`;
    const status = info.status || 'unknown';
    const statusIcon = status === 'completed' ? '✅' : status === 'failed' ? '❌' : '⏳';
    optionsHtml += `<option value="${jid}" ${jid === currentJobId ? 'selected' : ''}>${statusIcon} ${filename}</option>`;
  });
  
  artifactsSelect.innerHTML = optionsHtml;
  outputSelect.innerHTML = optionsHtml;
  
  // Show selectors
  artifactsSelector.style.display = 'flex';
  outputSelector.style.display = 'flex';
}

function hideJobSelectors() {
  $('#artifactsJobSelector').style.display = 'none';
  $('#outputJobSelector').style.display = 'none';
}

async function onArtifactsJobChange(jobId) {
  if (!jobId || jobId === currentJobId) return;
  currentJobId = jobId;
  // Update both selects to stay in sync
  $('#outputJobSelect').value = jobId;
  await loadResult();
  await loadArtifacts();
}

async function onOutputJobChange(jobId) {
  if (!jobId || jobId === currentJobId) return;
  currentJobId = jobId;
  // Update both selects to stay in sync
  $('#artifactsJobSelect').value = jobId;
  await loadResult();
  await loadArtifacts();
}

// ──────────────────────────────────────────────────────────────────
//  LOAD RESULT + ARTIFACTS
// ──────────────────────────────────────────────────────────────────
async function loadResult() {
  const res = await fetch(`/api/jobs/${currentJobId}/result`);
  currentResult = await res.json();
  renderOutput();
}

async function loadArtifacts() {
  const res = await fetch(`/api/jobs/${currentJobId}/artifacts`);
  const data = await res.json();
  renderArtifacts(data.artifacts || []);
}

// ──────────────────────────────────────────────────────────────────
//  CONFIDENCE HELPERS
// ──────────────────────────────────────────────────────────────────
function confClass(c) { return c >= 0.8 ? 'high' : c >= 0.5 ? 'mid' : 'low'; }
function confBadge(c) { return `<span class="conf-badge ${confClass(c)}">${(c * 100).toFixed(0)}%</span>`; }

// ──────────────────────────────────────────────────────────────────
//  RENDER ARTIFACTS  (with confidence highlighting)
// ──────────────────────────────────────────────────────────────────
function renderArtifacts(artifacts) {
  const el = $('#artifactsContent');
  if (!artifacts.length && !currentResult) {
    el.innerHTML = '<div class="empty"><div class="icon">🔍</div><p>Upload and process a document first</p></div>';
    return;
  }
  let html = '';

  // Stats row
  if (currentResult) {
    html += '<div class="stats">';
    html += stat('Pages', currentResult.page_count || 0);
    html += stat('Text Lines', countLines());
    html += stat('Tables', countTables());
    html += stat('Fields', (currentResult.fields || []).length);
    html += stat('Time', (currentResult.metadata?.processing_time_seconds || 0).toFixed(1) + 's');
    html += '</div>';

    // Confidence legend
    html += `<div class="conf-legend">
      Confidence: <span class="dot" style="background:var(--conf-high)"></span> High (≥80%)
      <span class="dot" style="background:var(--conf-mid)"></span> Medium (50-79%)
      <span class="dot" style="background:var(--conf-low)"></span> Low (&lt;50%)
    </div>`;

    // Per-page confidence summary with low-confidence line details
    if (currentResult.pages) {
      currentResult.pages.forEach((page, pi) => {
        const pageNum = page.page_number || (pi + 1);
        const lines = page.text_lines || [];
        if (!lines.length) return;
        const lowLines = lines.filter(l => (l.confidence||0) < 0.5);
        const midLines = lines.filter(l => (l.confidence||0) >= 0.5 && (l.confidence||0) < 0.8);
        const highCount = lines.length - midLines.length - lowLines.length;
        if (lowLines.length || midLines.length) {
          html += `<div style="margin:10px 0;padding:10px 14px;background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);font-size:.84rem">`;
          html += `<strong>Page ${pageNum}</strong> — ${lines.length} lines: `;
          html += `<span class="conf-high">${highCount} high</span>, `;
          html += `<span class="conf-mid">${midLines.length} medium</span>, `;
          html += `<span class="conf-low">${lowLines.length} low</span>`;
          if (lowLines.length) {
            html += `<details style="margin-top:6px"><summary style="cursor:pointer;color:var(--error);font-size:.8rem">⚠ ${lowLines.length} low-confidence line(s)</summary>`;
            html += `<div style="margin-top:6px;font-family:var(--mono);font-size:.78rem">`;
            lowLines.forEach(l => {
              html += `<div style="padding:3px 0;color:var(--conf-low)">• ${confBadge(l.confidence||0)} "${esc(l.text)}"</div>`;
            });
            html += '</div></details>';
          }
          html += '</div>';
        }
      });
    }
  }

  // Group artifacts by page
  if (artifacts.length) {
    const pages = {};
    artifacts.forEach(a => {
      const m = a.name.match(/page_(\d+)/);
      const pn = m ? parseInt(m[1]) : 0;
      if (!pages[pn]) pages[pn] = [];
      pages[pn].push(a);
    });

    for (const [pageNum, arts] of Object.entries(pages)) {
      html += `<h3 style="margin:20px 0 10px;color:var(--muted)">Page ${pageNum}</h3>`;
      html += '<div class="artifacts-grid">';
      for (const a of arts) {
        const friendly = a.name.replace(/page_\d+_/, '').replace(/_/g, ' ');
        html += `<div class="artifact-card">
          <img src="${a.url}" alt="${esc(a.name)}" onclick="showLightbox('${a.url}')" loading="lazy">
          <div class="label"><span>${friendly}</span><span>${a.size_kb} KB</span></div>
        </div>`;
      }
      html += '</div>';
    }
  } else if (!currentResult) {
    html += '<div class="empty"><div class="icon">🔍</div><p>No artifacts generated</p></div>';
  }

  el.innerHTML = html;
}

function stat(lbl, val) { return `<div class="stat"><div class="value">${val}</div><div class="label">${lbl}</div></div>`; }
function countLines() {
  if (!currentResult?.pages) return 0;
  return currentResult.pages.reduce((s, p) => s + (p.text_lines?.length || 0), 0);
}
function countTables() {
  if (currentResult?.tables) return currentResult.tables.length;
  if (!currentResult?.pages) return 0;
  return currentResult.pages.reduce((s, p) => s + (p.tables?.length || 0), 0);
}

// ──────────────────────────────────────────────────────────────────
//  RENDER OUTPUT  (Fields ↔ JSON toggle)
// ──────────────────────────────────────────────────────────────────
function renderOutput() {
  const el = $('#outputContent');
  if (!currentResult) {
    el.innerHTML = '<div class="empty"><div class="icon">📝</div><p>No result yet</p></div>';
    return;
  }

  let html = `
    <div class="view-toggle">
      <button class="vt-btn ${outputView === 'fields' ? 'active' : ''}" onclick="switchView('fields')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>Fields &amp; Tables</button>
      <button class="vt-btn ${outputView === 'report' ? 'active' : ''}" onclick="switchView('report')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Report</button>
      <button class="vt-btn ${outputView === 'spatial' ? 'active' : ''}" onclick="switchView('spatial')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Spatial</button>
      <button class="vt-btn ${outputView === 'json' ? 'active' : ''}" onclick="switchView('json')"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>JSON</button>
    </div>
    <div class="editor-toolbar">
      <button class="btn btn-success btn-sm" onclick="saveAllEdits()"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>Save Edits</button>
      <button class="btn btn-primary btn-sm" onclick="saveToDisk()"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>Save to Disk</button>
      <button class="btn btn-secondary btn-sm" onclick="downloadJson()"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>JSON</button>
      <button class="btn btn-secondary btn-sm" onclick="downloadMarkdown()" style="background:#4a9eff"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Markdown</button>
    </div>`;

  if (outputView === 'fields') html += renderFieldEditor();
  else if (outputView === 'report') html += renderReportView();
  else if (outputView === 'spatial') html += renderSpatialView();
  else html += renderJsonEditor();
  html += '<div class="json-status" id="jsonStatus"></div>';
  el.innerHTML = html;

  if (outputView === 'spatial') {
    // Initialize spatial view after DOM is ready
    setTimeout(initSpatialView, 0);
  }
  if (outputView === 'json') {
    const ed = $('#jsonEditor');
    if (ed) { ed.addEventListener('input', validateJson); validateJson(); }
  }
}

function switchView(view) {
  if (outputView === 'json') {
    const ed = $('#jsonEditor');
    if (ed) { try { currentResult = JSON.parse(ed.value); } catch {} }
  }
  if (outputView === 'fields') syncFieldEdits();
  outputView = view;
  renderOutput();
}

// ── Field Editor view ─────────────────────────────────────────────
function renderFieldEditor() {
  let html = '';
  const fields = currentResult.fields || [];
  const tables = currentResult.tables || [];

  // ─ Fields ─
  if (fields.length) {
    html += `<div class="cost-section"><h3>📋 Extracted Fields (${fields.length})</h3></div>`;
    html += `<div class="conf-legend">
      Confidence: <span class="dot" style="background:var(--conf-high)"></span> High
      <span class="dot" style="background:var(--conf-mid)"></span> Medium
      <span class="dot" style="background:var(--conf-low)"></span> Low — edit inline to correct
    </div>`;
    html += '<div class="field-grid">';
    fields.forEach((f, i) => {
      const c = f.confidence || 0;
      const cls = c < 0.5 ? 'low-conf' : c < 0.8 ? 'mid-conf' : '';
      const src = f.source ? `<span class="field-source">${f.source}</span>` : '';
      html += `<div class="field-card ${cls}">
        <div class="field-header">
          <span class="field-name">${esc(f.name || 'unnamed')}</span>
          ${confBadge(c)}
        </div>
        <input class="field-input" data-field-idx="${i}" value="${escAttr(f.value ?? '')}" placeholder="(empty)">
        <div class="field-meta">
          <span>Type: ${f.field_type || 'string'}</span>
          ${f.status ? `<span>Status: ${f.status}</span>` : ''}
          ${src}
        </div>
      </div>`;
    });
    html += '</div>';
  } else {
    html += '<div style="margin:20px 0;padding:20px;background:var(--surface);border-radius:var(--radius);border:1px solid var(--border);color:var(--muted);text-align:center">No fields extracted — try Azure mode or enable Donut / LayoutLMv3 KIE</div>';
  }

  // ─ Tables ─
  if (tables.length) {
    html += `<div class="cost-section"><h3>📊 Tables (${tables.length})</h3></div>`;
    tables.forEach((table, ti) => {
      const cells = table.cells || [];
      html += `<div style="margin-bottom:20px">`;
      html += `<div style="font-size:.85rem;color:var(--muted);margin-bottom:8px">Table ${ti + 1} — ${table.row_count || table.rows || '?'} rows × ${table.col_count || table.columns || '?'} cols ${confBadge(table.confidence || 0)}</div>`;
      if (cells.length) {
        const maxR = Math.max(...cells.map(c => c.row));
        const maxC = Math.max(...cells.map(c => c.col || c.column || 0));
        html += '<div style="overflow-x:auto"><table class="result-table"><tbody>';
        for (let r = 0; r <= maxR; r++) {
          html += '<tr>';
          for (let c = 0; c <= maxC; c++) {
            const cell = cells.find(x => x.row === r && (x.col === c || x.column === c));
            const txt = cell?.text || '';
            const cc = cell?.confidence || 0;
            const tag = (cell?.is_header || r === 0) ? 'th' : 'td';
            html += `<${tag}><input data-table="${ti}" data-row="${r}" data-col="${c}" value="${escAttr(txt)}" style="color:var(--conf-${confClass(cc)})"></${tag}>`;
          }
          html += '</tr>';
        }
        html += '</tbody></table></div>';
      }
      html += '</div>';
    });
  }

  // ─ Text lines per page (collapsible) ─
  if (currentResult.pages) {
    html += '<div class="cost-section"><h3>📃 Text Lines by Page</h3></div>';
    currentResult.pages.forEach((page, pi) => {
      const lines = page.text_lines || [];
      if (!lines.length) return;
      html += `<details style="margin-bottom:10px"><summary style="cursor:pointer;color:var(--muted);font-size:.88rem;padding:6px 0">Page ${page.page_number || pi + 1} — ${lines.length} lines</summary><div style="margin-top:6px">`;
      lines.forEach(l => {
        const c = l.confidence || 0;
        html += `<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:.84rem">
          ${confBadge(c)}
          <span style="color:var(--conf-${confClass(c)});font-family:var(--mono);font-size:.8rem">${esc(l.text)}</span>
          <span style="color:var(--muted);font-size:.72rem;margin-left:auto">${l.content_type || ''}</span>
        </div>`;
      });
      html += '</div></details>';
    });
  }

  return html;
}

// ── Report Viewer ─────────────────────────────────────────────────
function renderReportView() {
  const r = currentResult;
  if (!r) return '<div class="empty"><div class="icon">📑</div><p>No result yet</p></div>';
  let h = '<div class="report">';

  // ── Title & Meta ──
  const fn = r.metadata?.filename || 'Document';
  const meta = r.metadata || {};
  h += `<h2>🔎 OCR Report — ${esc(fn)}</h2>`;
  h += '<div class="report-meta">';
  h += rptMeta('Filename', fn);
  h += rptMeta('File Type', meta.file_type || '—');
  h += rptMeta('File Size', fmtBytes(meta.file_size_bytes || 0));
  h += rptMeta('Pages', r.page_count || 0);
  h += rptMeta('Processing Time', (meta.processing_time_seconds || 0).toFixed(2) + 's');
  h += rptMeta('Processed At', meta.processed_at ? new Date(meta.processed_at).toLocaleString() : '—');
  h += rptMeta('Total Fields', (r.fields || []).length);
  h += rptMeta('Total Tables', (r.tables || []).length);
  h += '</div>';

  // ── Per-page sections ──
  const pages = r.pages || [];
  pages.forEach((page, pi) => {
    const pn = page.page_number || page.number || (pi + 1);
    const pm = page.metadata || {};
    h += '<div class="page-section">';
    h += '<div class="page-header">';
    h += `<span class="page-num">📑 Page ${pn}</span>`;
    h += '<span class="page-info">';
    if (pm.width && pm.height) h += `<span>${pm.width}×${pm.height} px</span>`;
    if (pm.dpi) h += `<span>${pm.dpi} DPI</span>`;
    if (pm.content_type) h += `<span>${pm.content_type}</span>`;
    if (pm.readability) {
      const rIcon = {good:'✅',fair:'⚠️',poor:'❌'}[pm.readability] || '❓';
      h += `<span>${rIcon} ${pm.readability}</span>`;
    }
    h += '</span></div>';

    // Layout regions
    const regions = page.layout_regions || [];
    if (regions.length) {
      h += `<h4>🗺️ Layout Regions (${regions.length})</h4>`;
      h += '<table class="report-table"><thead><tr><th>#</th><th>Type</th><th>Position</th><th>Confidence</th><th>Content</th></tr></thead><tbody>';
      regions.forEach((rg, ri) => {
        const bb = rg.bbox || {};
        h += `<tr><td>${ri+1}</td><td><strong>${rg.type || '?'}</strong></td>`;
        h += `<td><span class="spatial-badge">x:${bb.x1||0} y:${bb.y1||0} → ${bb.x2||0},${bb.y2||0}</span></td>`;
        h += `<td>${confBadge(rg.confidence||0)} ${confBarHtml(rg.confidence||0)}</td>`;
        h += `<td>${rg.content_type || '—'}</td></tr>`;
      });
      h += '</tbody></table>';
    }

    // Text lines
    const lines = page.text_lines || [];
    if (lines.length) {
      h += `<h4>📝 Text Lines (${lines.length})</h4>`;
      h += '<table class="report-table"><thead><tr><th>#</th><th>Text</th><th>Position</th><th>Confidence</th><th>Source</th></tr></thead><tbody>';
      lines.forEach((tl, ti) => {
        const bb = tl.bbox || {};
        const cls = confClass(tl.confidence||0);
        h += `<tr><td>${ti+1}</td>`;
        h += `<td style="font-family:var(--mono);font-size:.82rem;color:var(--conf-${cls})">${esc(tl.text||'')}</td>`;
        h += `<td><span class="spatial-badge">x:${bb.x1||0} y:${bb.y1||0}</span></td>`;
        h += `<td>${confBadge(tl.confidence||0)} ${confBarHtml(tl.confidence||0)}</td>`;
        h += `<td>${tl.source || '—'}</td></tr>`;
      });
      h += '</tbody></table>';
    }

    // Tables on this page
    const pageTables = (page.tables || []);
    const docTables = (r.tables || []).filter(t => t.page === pn);
    const tables = pageTables.length ? pageTables : docTables;
    if (tables.length) {
      tables.forEach((tbl, ti) => {
        const cells = tbl.cells || [];
        const rows = tbl.rows || tbl.row_count || 0;
        const cols = tbl.cols || tbl.col_count || tbl.columns || 0;
        const tbb = tbl.bbox || {};
        h += `<h4>📊 Table ${ti+1}</h4>`;
        h += `<div style="display:flex;gap:14px;flex-wrap:wrap;margin-bottom:8px;font-size:.82rem;color:var(--muted)">`;
        h += `<span><strong>Size:</strong> ${rows} rows × ${cols} cols</span>`;
        h += `<span><strong>Confidence:</strong> ${confBadge(tbl.confidence||0)}</span>`;
        if (tbb.x1 !== undefined) h += `<span class="spatial-badge page-loc">📍 x:${tbb.x1} y:${tbb.y1} → ${tbb.x2},${tbb.y2}</span>`;
        h += `<span><strong>Borders:</strong> ${tbl.has_borders ? 'Yes' : 'No'}</span>`;
        h += '</div>';

        if (cells.length && rows > 0 && cols > 0) {
          // Build grid
          const grid = Array.from({length: rows}, () => Array(cols).fill({text:'', confidence:1, isHeader:false}));
          cells.forEach(c => {
            const cr = c.row, cc = c.col ?? c.column ?? 0;
            if (cr >= 0 && cr < rows && cc >= 0 && cc < cols)
              grid[cr][cc] = {text: c.text||'', confidence: c.confidence||0, isHeader: c.is_header||false};
          });

          h += '<div class="rpt-table-wrap"><table class="rpt-table">';
          // Determine header row
          const hasHeaders = cells.some(c => c.is_header);
          if (hasHeaders) {
            const hr = Math.min(...cells.filter(c => c.is_header).map(c => c.row));
            h += '<thead><tr>';
            grid[hr].forEach(cell => { h += `<th>${esc(cell.text) || '&nbsp;'}</th>`; });
            h += '</tr></thead><tbody>';
            for (let rr = hr+1; rr < rows; rr++) {
              h += '<tr>';
              grid[rr].forEach(cell => {
                h += `<td class="cell-${confClass(cell.confidence)}">${esc(cell.text) || '&nbsp;'}</td>`;
              });
              h += '</tr>';
            }
          } else {
            h += '<thead><tr>';
            for (let cc = 0; cc < cols; cc++) h += `<th>Col ${cc+1}</th>`;
            h += '</tr></thead><tbody>';
            for (let rr = 0; rr < rows; rr++) {
              h += '<tr>';
              grid[rr].forEach(cell => {
                h += `<td class="cell-${confClass(cell.confidence)}">${esc(cell.text) || '&nbsp;'}</td>`;
              });
              h += '</tr>';
            }
          }
          h += '</tbody></table></div>';

          // Low-confidence cells
          const lowCells = cells.filter(c => (c.confidence||1) < 0.7);
          if (lowCells.length) {
            h += `<details style="margin:6px 0"><summary class="candidates-toggle">⚠️ ${lowCells.length} low-confidence cell(s)</summary><div style="margin:6px 0">`;
            h += '<table class="report-table" style="font-size:.8rem"><thead><tr><th>Row</th><th>Col</th><th>Text</th><th>Confidence</th></tr></thead><tbody>';
            lowCells.forEach(c => {
              h += `<tr><td>${c.row}</td><td>${c.col??c.column??0}</td><td>${esc(c.text||'')}</td><td>${confBadge(c.confidence||0)}</td></tr>`;
            });
            h += '</tbody></table></div></details>';
          }
        } else {
          h += '<p style="color:var(--muted);font-style:italic">No cell data available</p>';
        }
      });
    }

    h += '</div>'; // page-section
  });

  // ── Extracted Fields ──
  const fields = r.fields || [];
  if (fields.length) {
    h += '<hr><h2>🏷️ Extracted Fields</h2>';
    h += `<div class="conf-legend">
      Confidence: <span class="dot" style="background:var(--conf-high)"></span> High (≥80%)
      <span class="dot" style="background:var(--conf-mid)"></span> Medium (50-79%)
      <span class="dot" style="background:var(--conf-low)"></span> Low (&lt;50%)
    </div>`;

    // Group fields by page
    const byPage = {};
    fields.forEach(f => {
      const pg = f.page || 'doc';
      if (!byPage[pg]) byPage[pg] = [];
      byPage[pg].push(f);
    });

    Object.entries(byPage).forEach(([pg, flds]) => {
      h += `<h3>📄 ${pg === 'doc' ? 'Document-level' : 'Page ' + pg} Fields (${flds.length})</h3>`;
      h += '<div class="field-group">';
      flds.forEach((f, fi) => {
        const c = f.confidence || 0;
        const uid = `cand_${pg}_${fi}`;
        h += '<div class="field-row">';
        h += `<span class="fr-name">${esc(f.name || 'unnamed')}</span>`;
        h += `<span class="fr-value">${esc(String(f.value ?? ''))}</span>`;
        h += '<span class="fr-conf">';
        if (f.status) h += `<span class="status-pill ${f.status}">${f.status}</span>`;
        h += `${confBadge(c)} ${confBarHtml(c)}`;
        if (f.chosen_source || f.source) h += `<span class="fr-source">${f.chosen_source || f.source}</span>`;
        h += '</span>';
        h += '</div>';

        // Candidates
        const cands = f.candidates || [];
        if (cands.length > 1) {
          h += `<div style="padding-left:172px"><span class="candidates-toggle" onclick="toggleCandidates('${uid}')">▸ ${cands.length} candidates</span>`;
          h += `<div class="candidates-panel" id="${uid}">`;
          cands.forEach(cd => {
            h += `<div class="candidate-row"><span class="cr-src">${cd.source||'?'}</span><span>${esc(String(cd.value||''))}</span><span>${confBadge(cd.confidence||0)}</span></div>`;
          });
          h += '</div></div>';
        }
      });
      h += '</div>';
    });
  }

  // ── Validation ──
  const v = r.validation;
  if (v) {
    h += '<hr>';
    const passed = v.passed !== false;
    h += `<div class="validation-box ${passed ? 'passed' : 'failed'}">`;
    h += `<div class="vb-header">${passed ? '✅' : '❌'} Validation ${passed ? 'Passed' : 'Failed'}</div>`;
    h += `<div class="vb-stats">${v.passed_checks||0} / ${v.total_checks||0} checks passed, ${v.failed_checks||0} failed</div>`;
    const issues = v.issues || [];
    if (issues.length) {
      issues.forEach(iss => { h += `<div class="issue-item">⚠️ ${esc(iss)}</div>`; });
    }
    const details = v.details || [];
    if (details.length) {
      h += `<details style="margin-top:8px"><summary class="candidates-toggle">Detailed check results (${details.length})</summary>`;
      h += '<table class="report-table" style="margin-top:6px"><thead><tr><th>Check</th><th>Result</th><th>Message</th></tr></thead><tbody>';
      details.forEach(d => {
        h += `<tr><td>${esc(d.name||'?')}</td><td>${d.passed ? '✅' : '❌'}</td><td>${esc(d.message||'')}</td></tr>`;
      });
      h += '</tbody></table></details>';
    }
    h += '</div>';
  }

  // ── Normalized (Azure) ──
  if (r.normalized) {
    h += '<hr><h2>📦 Normalized Output (Business-Ready)</h2>';
    const n = r.normalized;
    if (n.doc_type) h += `<p><strong>Document Type:</strong> ${esc(n.doc_type)}</p>`;
    if (n.header_fields && Object.keys(n.header_fields).length) {
      h += '<h3>Header Fields</h3><div class="field-group">';
      Object.entries(n.header_fields).forEach(([k, v]) => {
        h += `<div class="field-row"><span class="fr-name">${esc(k)}</span><span class="fr-value">${esc(String(v))}</span></div>`;
      });
      h += '</div>';
    }
    if (n.line_items && n.line_items.length) {
      h += `<h3>Line Items (${n.line_items.length})</h3>`;
      const keys = [...new Set(n.line_items.flatMap(li => Object.keys(li)))];
      h += '<div class="rpt-table-wrap"><table class="rpt-table"><thead><tr>';
      keys.forEach(k => { h += `<th>${esc(k)}</th>`; });
      h += '</tr></thead><tbody>';
      n.line_items.forEach(li => {
        h += '<tr>';
        keys.forEach(k => { h += `<td>${esc(String(li[k] ?? ''))}</td>`; });
        h += '</tr>';
      });
      h += '</tbody></table></div>';
    }
    if (n.totals && Object.keys(n.totals).length) {
      h += '<h3>Totals</h3><div class="field-group">';
      Object.entries(n.totals).forEach(([k, v]) => {
        h += `<div class="field-row"><span class="fr-name">${esc(k)}</span><span class="fr-value">${esc(String(v))}</span></div>`;
      });
      h += '</div>';
    }
  }

  h += '<hr><p style="text-align:center;font-size:.78rem;color:var(--muted);margin-top:24px">Report generated by DocVision — Horizon OCR Pipeline</p>';
  h += '</div>'; // .report
  return h;
}

// ── Spatial OCR View ───────────────────────────────────────────────
let spatialCurrentPage = 1;
let spatialArtifacts = [];

function renderSpatialView() {
  if (!currentJobId || !currentResult) {
    return '<div class="empty"><div class="icon">🗺</div><p>No result yet</p></div>';
  }
  
  const pageCount = currentResult.page_count || currentResult.pages?.length || 1;
  
  return `
    <div class="spatial-viewer" id="spatialViewer">
      <div class="spatial-page-nav">
        <button onclick="spatialPrevPage()" id="spatialPrev">◀ Previous</button>
        <span class="page-info">Page <span id="spatialPageNum">1</span> of ${pageCount}</span>
        <button onclick="spatialNextPage()" id="spatialNext">Next ▶</button>
      </div>
      <div class="spatial-container" id="spatialContainer">
        <div class="spatial-side image-side" id="spatialImageSide">
          <div class="spatial-loading">
            <div class="spinner"></div>
            <p>Loading page image...</p>
          </div>
        </div>
        <div class="spatial-side text-side" id="spatialTextSide">
          <div class="spatial-loading">
            <div class="spinner"></div>
            <p>Loading OCR data...</p>
          </div>
        </div>
      </div>
      <div class="spatial-footer">Left: Original document image | Right: Reconstructed OCR text layout</div>
    </div>`;
}

async function initSpatialView() {
  spatialCurrentPage = 1;
  spatialArtifacts = [];
  
  // Fetch artifacts list
  try {
    const res = await fetch(`/api/jobs/${currentJobId}/artifacts`);
    if (res.ok) {
      const data = await res.json();
      spatialArtifacts = data.artifacts || [];
    }
  } catch (e) {
    console.error('Failed to load artifacts:', e);
  }
  
  renderSpatialPage();
  updateSpatialNavButtons();
}

function spatialPrevPage() {
  if (spatialCurrentPage > 1) {
    spatialCurrentPage--;
    renderSpatialPage();
    updateSpatialNavButtons();
  }
}

function spatialNextPage() {
  const pageCount = currentResult.page_count || currentResult.pages?.length || 1;
  if (spatialCurrentPage < pageCount) {
    spatialCurrentPage++;
    renderSpatialPage();
    updateSpatialNavButtons();
  }
}

function updateSpatialNavButtons() {
  const pageCount = currentResult.page_count || currentResult.pages?.length || 1;
  const prevBtn = $('#spatialPrev');
  const nextBtn = $('#spatialNext');
  const pageNum = $('#spatialPageNum');
  
  if (prevBtn) prevBtn.disabled = spatialCurrentPage <= 1;
  if (nextBtn) nextBtn.disabled = spatialCurrentPage >= pageCount;
  if (pageNum) pageNum.textContent = spatialCurrentPage;
}

function renderSpatialPage() {
  const imageSide = $('#spatialImageSide');
  const textSide = $('#spatialTextSide');
  if (!imageSide || !textSide) return;
  
  // Get page data
  const pages = currentResult.pages || [];
  const pageIdx = spatialCurrentPage - 1;
  const pageData = pages[pageIdx];
  
  if (!pageData) {
    imageSide.innerHTML = '<div class="spatial-no-data"><div class="icon">📄</div><p>No page data found</p></div>';
    textSide.innerHTML = '<div class="spatial-no-data"><div class="icon">📝</div><p>No OCR data for this page</p></div>';
    return;
  }
  
  // Render image side
  const paddedPage = String(spatialCurrentPage).padStart(3, '0');
  const preprocessedArtifact = spatialArtifacts.find(a => a.name === `page_${paddedPage}_preprocessed`);
  const ocrArtifact = spatialArtifacts.find(a => a.name === `page_${paddedPage}_ocr`);
  const anyArtifact = preprocessedArtifact || ocrArtifact || spatialArtifacts.find(a => a.name.includes(`page_${paddedPage}`));
  
  if (anyArtifact) {
    imageSide.innerHTML = `<img src="${anyArtifact.url}" alt="Page ${spatialCurrentPage}" id="spatialPageImg" onload="onSpatialImageLoad()">`;
  } else {
    imageSide.innerHTML = '<div class="spatial-no-data"><div class="icon">🖼</div><p>No page image available</p><small>Artifacts may not have been generated</small></div>';
  }
  
  // Render text side with positioned elements
  renderSpatialTextOverlay(pageData, textSide);
}

function onSpatialImageLoad() {
  // Re-render text side to match image dimensions if needed
  const img = $('#spatialPageImg');
  const textSide = $('#spatialTextSide');
  if (img && textSide) {
    // Set min-height to match image
    textSide.style.minHeight = img.naturalHeight ? `${img.offsetHeight}px` : '500px';
  }
}

function renderSpatialTextOverlay(pageData, container) {
  // ═══════════════════════════════════════════════════════════════════
  // EXACT SPATIAL LAYOUT - Text positioned at exact document coordinates
  // with hover-to-expand for overlapping text
  // ═══════════════════════════════════════════════════════════════════
  
  const meta = pageData.metadata || {};
  
  // Calculate actual page dimensions from content if not in metadata
  // This handles documents where text coordinates exceed metadata dimensions
  const artifactLines = pageData.text_lines || [];
  let maxX = 0, maxY = 0;
  artifactLines.forEach(line => {
    if (line.bbox) {
      const x2 = line.bbox.x2 ?? line.bbox[2] ?? 0;
      const y2 = line.bbox.y2 ?? line.bbox[3] ?? 0;
      if (x2 > maxX) maxX = x2;
      if (y2 > maxY) maxY = y2;
    }
  });
  
  // Use whichever is larger: metadata dimensions or calculated from content
  const pageWidth = Math.max(meta.width || 2550, maxX + 50);
  const pageHeight = Math.max(meta.height || 3300, maxY + 50);
  
  // Use a fixed display width and scale everything proportionally
  const displayWidth = 800;
  const scale = displayWidth / pageWidth;
  const displayHeight = Math.round(pageHeight * scale);
  
  // Use text_lines for BOTH display AND counting (same source as artifacts tab)
  const textLines = [];
  
  // Debug: log low confidence items
  const lowConfDebug = artifactLines.filter(l => (l.confidence || 0) < 0.5);
  console.log('Low confidence items from text_lines:', lowConfDebug.map(l => ({
    text: l.text,
    confidence: l.confidence,
    hasBbox: !!l.bbox,
    bbox: l.bbox
  })));
  
  // Debug page dimensions
  console.log('Page dimensions:', { pageWidth, pageHeight, displayWidth, scale });
  
  artifactLines.forEach((line) => {
    if (!line || !line.text) return;
    const text = line.text.trim();
    if (!text) return;
    const bbox = line.bbox || {};
    const x1 = bbox.x1 ?? bbox[0] ?? 0;
    const y1 = bbox.y1 ?? bbox[1] ?? 0;
    const x2 = bbox.x2 ?? bbox[2] ?? x1 + 100;
    const y2 = bbox.y2 ?? bbox[3] ?? y1 + 20;
    const hasBbox = !!(line.bbox && (line.bbox.x1 !== undefined || line.bbox[0] !== undefined));
    textLines.push({ 
      text, 
      confidence: line.confidence ?? 0,
      x1, y1, x2, y2,
      hasBbox
    });
  });
  
  // Count confidence (same as artifacts tab)
  const lowCount = textLines.filter(l => (l.confidence || 0) < 0.5).length;
  const medCount = textLines.filter(l => (l.confidence || 0) >= 0.5 && (l.confidence || 0) < 0.8).length;
  const highCount = textLines.length - lowCount - medCount;
  const totalLines = textLines.length;
  
  // Debug: log what will be rendered
  const lowWithBbox = textLines.filter(l => (l.confidence || 0) < 0.5 && l.hasBbox);
  console.log('Low confidence items WITH bbox (will be rendered):', lowWithBbox);
  
  // Collect tables
  const pageTables = [];
  const seenTableIds = new Set();
  
  const addTable = (table) => {
    if (!table || !table.bbox) return;
    const tableId = table.id || `t_${Math.round(table.bbox?.x1 ?? 0)}_${Math.round(table.bbox?.y1 ?? 0)}`;
    if (!seenTableIds.has(tableId)) {
      seenTableIds.add(tableId);
      pageTables.push(table);
    }
  };
  
  (currentResult.tables || [])
    .filter(t => (t.page || 1) === spatialCurrentPage)
    .forEach(addTable);
  (pageData.tables || []).forEach(addTable);
  
  // Get all text lines with bbox for display (don't filter by table overlap anymore)
  const filteredTextLines = textLines.filter(line => line.hasBbox);
  
  // Debug: Show what will be rendered
  console.log('Filtered text lines count:', filteredTextLines.length);
  console.log('Low conf in filtered:', filteredTextLines.filter(l => l.confidence < 0.5));
  console.log('Scale and dimensions:', { pageWidth, pageHeight, displayWidth, displayHeight, scale });
  
  if (textLines.length === 0 && pageTables.length === 0) {
    container.innerHTML = '<div class="spatial-no-data"><div class="icon">📝</div><p>No OCR content available</p></div>';
    return;
  }
  
  // Build the spatial reconstructed view
  let html = `<div class="spatial-reconstructed" style="width:${displayWidth}px;height:${displayHeight}px;position:relative;overflow:visible;">`;
  
  // Render text lines at exact positions
  filteredTextLines.forEach((line, idx) => {
    const left = Math.round(line.x1 * scale);
    const top = Math.round(line.y1 * scale);
    const width = Math.max(20, Math.round((line.x2 - line.x1) * scale));
    const height = Math.max(12, Math.round((line.y2 - line.y1) * scale));
    
    const conf = line.confidence || 0;
    let confClass = '';
    let inlineStyle = '';
    if (conf < 0.5) { 
      confClass = ' low-conf'; 
      inlineStyle = 'background:rgba(254,226,226,0.95);border-left-color:#dc2626;color:#dc2626;';
    }
    else if (conf < 0.8) { 
      confClass = ' med-conf'; 
      inlineStyle = 'background:rgba(254,243,199,0.95);border-left-color:#f59e0b;color:#92400e;';
    }
    else { 
      confClass = ' high-conf'; 
      inlineStyle = 'background:rgba(220,252,231,0.95);border-left-color:#22c55e;color:#166534;';
    }
    
    const confPct = Math.round(conf * 100);
    // Truncate display text if too long, full text shown on hover
    const displayText = line.text.length > 50 ? line.text.substring(0, 47) + '...' : line.text;
    
    html += `<div class="spatial-text${confClass}" 
      style="left:${left}px;top:${top}px;max-width:${width}px;min-height:${Math.max(10, height - 4)}px;${inlineStyle}"
      title="${confPct}% confidence: ${esc(line.text)}"
      data-full-text="${esc(line.text)}">${esc(displayText)}</div>`;
  });
  
  // Render tables at exact positions
  pageTables.forEach((table, tidx) => {
    const bbox = normalizeBbox(table.bbox);
    const left = Math.round(bbox.x1 * scale);
    const top = Math.round(bbox.y1 * scale);
    const width = Math.max(50, Math.round((bbox.x2 - bbox.x1) * scale));
    const height = Math.max(30, Math.round((bbox.y2 - bbox.y1) * scale));
    
    html += `<div class="spatial-table" style="left:${left}px;top:${top}px;width:${width}px;height:${height}px;">`;
    
    // Render table cells
    if (table.cells && table.cells.length > 0) {
      table.cells.forEach(cell => {
        if (!cell.bbox) return;
        const cellBbox = normalizeBbox(cell.bbox);
        // Position relative to table
        const cellLeft = Math.round((cellBbox.x1 - bbox.x1) * scale);
        const cellTop = Math.round((cellBbox.y1 - bbox.y1) * scale);
        const cellWidth = Math.max(20, Math.round((cellBbox.x2 - cellBbox.x1) * scale));
        const cellHeight = Math.max(12, Math.round((cellBbox.y2 - cellBbox.y1) * scale));
        
        const isHeader = cell.is_header ? ' header' : '';
        const cellConf = cell.confidence || 1;
        let cellConfClass = '';
        // Only apply styling, don't count (artifacts only counts text_lines, not table cells)
        if (cellConf < 0.5) { cellConfClass = ' low-conf'; }
        else if (cellConf < 0.8) { cellConfClass = ' med-conf'; }
        else { cellConfClass = ' high-conf'; }
        const cellConfPct = Math.round(cellConf * 100);
        const cellText = cell.text || '';
        const displayCellText = cellText.length > 30 ? cellText.substring(0, 27) + '...' : cellText;
        
        html += `<div class="spatial-table-cell${isHeader}${cellConfClass}" 
          style="left:${cellLeft}px;top:${cellTop}px;width:${cellWidth}px;height:${cellHeight}px;"
          title="${cellConfPct}% confidence: ${esc(cellText)}"
          data-full-text="${esc(cellText)}">${esc(displayCellText)}</div>`;
      });
    }
    
    html += '</div>';
  });
  
  html += '</div>';
  
  // Find low/medium confidence items that weren't rendered (no bbox)
  const renderedSet = new Set(filteredTextLines.map(l => l.text));
  const lowConfItems = textLines.filter(l => (l.confidence || 0) < 0.5);
  const medConfItems = textLines.filter(l => (l.confidence || 0) >= 0.5 && (l.confidence || 0) < 0.8);
  const lowNotRendered = lowConfItems.filter(l => !l.hasBbox);
  const medNotRendered = medConfItems.filter(l => !l.hasBbox);
  
  // Add info bar with confidence counts from artifacts tab (text_lines)
  html += `<div style="font-size:12px;color:#444;padding:10px 12px;border-top:1px solid #ddd;background:#f5f5f5;display:flex;flex-wrap:wrap;gap:12px;align-items:center;">
    <span><strong>${totalLines}</strong> lines (${filteredTextLines.length} shown)</span>
    <span style="color:#888">|</span>
    <span style="background:#dcfce7;color:#166534;padding:2px 8px;border-radius:3px;border-left:3px solid #22c55e;"><strong>${highCount}</strong> high</span>
    <span style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:3px;border-left:3px solid #f59e0b;"><strong>${medCount}</strong> medium</span>
    <span style="background:#fee2e2;color:#dc2626;padding:2px 8px;border-radius:3px;border-left:3px solid #dc2626;"><strong>${lowCount}</strong> low</span>
    <span style="color:#888;margin-left:auto;font-size:11px;"><em>Hover for full text + confidence %</em></span>
  </div>`;
  
  // Show low-confidence items that couldn't be positioned (no bbox)
  if (lowNotRendered.length > 0 || medNotRendered.length > 0) {
    html += `<details style="font-size:11px;padding:8px 12px;border-top:1px solid #eee;background:#fafafa;">
      <summary style="cursor:pointer;color:#666;">⚠ ${lowNotRendered.length + medNotRendered.length} low/medium items without position data</summary>
      <div style="margin-top:6px;max-height:150px;overflow-y:auto;">`;
    lowNotRendered.forEach(l => {
      const pct = Math.round((l.confidence || 0) * 100);
      html += `<div style="padding:2px 0;color:#dc2626;"><span style="background:#fee2e2;padding:1px 4px;border-radius:2px;font-size:10px;">${pct}%</span> "${esc(l.text)}"</div>`;
    });
    medNotRendered.forEach(l => {
      const pct = Math.round((l.confidence || 0) * 100);
      html += `<div style="padding:2px 0;color:#92400e;"><span style="background:#fef3c7;padding:1px 4px;border-radius:2px;font-size:10px;">${pct}%</span> "${esc(l.text)}"</div>`;
    });
    html += `</div></details>`;
  }
  
  container.innerHTML = html;
}

// Render a table as a clean HTML table
function renderCleanTable(table) {
  if (!table.cells || table.cells.length === 0) {
    return '<p class="text-line">Empty table</p>';
  }
  
  // Find table dimensions
  let maxRow = 0, maxCol = 0;
  table.cells.forEach(cell => {
    const row = cell.row ?? 0;
    const col = cell.col ?? 0;
    const rowSpan = cell.row_span ?? 1;
    const colSpan = cell.col_span ?? 1;
    maxRow = Math.max(maxRow, row + rowSpan);
    maxCol = Math.max(maxCol, col + colSpan);
  });
  
  // Create 2D grid
  const grid = Array(maxRow).fill(null).map(() => Array(maxCol).fill(null));
  const occupied = Array(maxRow).fill(null).map(() => Array(maxCol).fill(false));
  
  // Place cells in grid
  table.cells.forEach(cell => {
    const row = cell.row ?? 0;
    const col = cell.col ?? 0;
    const rowSpan = cell.row_span ?? 1;
    const colSpan = cell.col_span ?? 1;
    
    // Find first unoccupied position
    let startRow = row, startCol = col;
    while (startRow < maxRow && startCol < maxCol && occupied[startRow][startCol]) {
      startCol++;
      if (startCol >= maxCol) {
        startCol = 0;
        startRow++;
      }
    }
    
    if (startRow < maxRow && startCol < maxCol) {
      grid[startRow][startCol] = {
        text: cell.text || '',
        isHeader: cell.is_header || startRow === 0,
        rowSpan,
        colSpan,
        confidence: cell.confidence || 1
      };
      
      // Mark occupied cells
      for (let r = startRow; r < Math.min(startRow + rowSpan, maxRow); r++) {
        for (let c = startCol; c < Math.min(startCol + colSpan, maxCol); c++) {
          occupied[r][c] = true;
        }
      }
    }
  });
  
  // Generate HTML table
  let html = '<table>';
  for (let r = 0; r < maxRow; r++) {
    html += '<tr>';
    for (let c = 0; c < maxCol; c++) {
      const cell = grid[r][c];
      if (cell === null) {
        // Check if this cell is part of a span (skip it)
        if (!occupied[r][c]) {
          html += '<td></td>';
        }
        continue;
      }
      
      const tag = cell.isHeader ? 'th' : 'td';
      const spanAttrs = [];
      if (cell.rowSpan > 1) spanAttrs.push(`rowspan="${cell.rowSpan}"`);
      if (cell.colSpan > 1) spanAttrs.push(`colspan="${cell.colSpan}"`);
      const confClass = cell.confidence < 0.7 ? ' class="low-conf"' : '';
      
      html += `<${tag} ${spanAttrs.join(' ')}${confClass}>${esc(cell.text)}</${tag}>`;
    }
    html += '</tr>';
  }
  html += '</table>';
  
  return html;
}

// Convert bbox to pixel position with scaling
function bboxToPixels(bbox, scale) {
  let x1, y1;
  
  if (Array.isArray(bbox)) {
    [x1, y1] = bbox;
  } else if (bbox.x1 !== undefined) {
    x1 = bbox.x1;
    y1 = bbox.y1;
  } else if (bbox.x !== undefined) {
    x1 = bbox.x;
    y1 = bbox.y;
  } else {
    return { left: 0, top: 0 };
  }
  
  return {
    left: Math.round(x1 * scale),
    top: Math.round(y1 * scale)
  };
}

// Convert bbox to pixel rect (position + size) with scaling
function bboxToPixelsRect(bbox, scale) {
  let x1, y1, x2, y2;
  
  if (Array.isArray(bbox)) {
    [x1, y1, x2, y2] = bbox;
  } else if (bbox.x1 !== undefined) {
    x1 = bbox.x1;
    y1 = bbox.y1;
    x2 = bbox.x2;
    y2 = bbox.y2;
  } else if (bbox.x !== undefined && bbox.width !== undefined) {
    x1 = bbox.x;
    y1 = bbox.y;
    x2 = bbox.x + bbox.width;
    y2 = bbox.y + bbox.height;
  } else {
    return { left: 0, top: 0, width: 50, height: 20 };
  }
  
  return {
    left: Math.round(x1 * scale),
    top: Math.round(y1 * scale),
    width: Math.max(10, Math.round((x2 - x1) * scale)),
    height: Math.max(10, Math.round((y2 - y1) * scale))
  };
}

function bboxToPercent(bbox, pageWidth, pageHeight) {
  // Handle different bbox formats: {x1,y1,x2,y2} or [x1,y1,x2,y2]
  let x1, y1, x2, y2;
  
  if (Array.isArray(bbox)) {
    [x1, y1, x2, y2] = bbox;
  } else if (bbox.x1 !== undefined) {
    x1 = bbox.x1;
    y1 = bbox.y1;
    x2 = bbox.x2;
    y2 = bbox.y2;
  } else if (bbox.x !== undefined && bbox.width !== undefined) {
    x1 = bbox.x;
    y1 = bbox.y;
    x2 = bbox.x + bbox.width;
    y2 = bbox.y + bbox.height;
  } else {
    return { left: 0, top: 0, width: 5, height: 2 };
  }
  
  // Convert to percentages
  const left = (x1 / pageWidth) * 100;
  const top = (y1 / pageHeight) * 100;
  const width = ((x2 - x1) / pageWidth) * 100;
  const height = ((y2 - y1) / pageHeight) * 100;
  
  return {
    left: Math.max(0, left),
    top: Math.max(0, top),
    width: Math.max(1, Math.min(100 - left, width)),
    height: Math.max(0.5, Math.min(100 - top, height))
  };
}

// Normalize bbox to {x1,y1,x2,y2} format
function normalizeBbox(bbox) {
  if (Array.isArray(bbox)) {
    return { x1: bbox[0], y1: bbox[1], x2: bbox[2], y2: bbox[3] };
  }
  if (bbox.x1 !== undefined) {
    return { x1: bbox.x1, y1: bbox.y1, x2: bbox.x2, y2: bbox.y2 };
  }
  if (bbox.x !== undefined && bbox.width !== undefined) {
    return { x1: bbox.x, y1: bbox.y, x2: bbox.x + bbox.width, y2: bbox.y + bbox.height };
  }
  return { x1: 0, y1: 0, x2: 0, y2: 0 };
}

// Calculate overlap ratio of bbox A inside bbox B
function bboxOverlap(a, b) {
  const x1 = Math.max(a.x1, b.x1);
  const y1 = Math.max(a.y1, b.y1);
  const x2 = Math.min(a.x2, b.x2);
  const y2 = Math.min(a.y2, b.y2);
  
  if (x1 >= x2 || y1 >= y2) return 0; // No overlap
  
  const overlapArea = (x2 - x1) * (y2 - y1);
  const aArea = (a.x2 - a.x1) * (a.y2 - a.y1);
  
  return aArea > 0 ? overlapArea / aArea : 0;
}

function rptMeta(label, value) {
  return `<div class="report-meta-item"><div class="rml">${label}</div><div class="rmv">${esc(String(value))}</div></div>`;
}

function confBarHtml(c) {
  const pct = Math.round(c * 100);
  return `<span class="conf-bar"><span class="conf-bar-fill ${confClass(c)}" style="width:${pct}%"></span></span>`;
}

function fmtBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1024*1024) return (b/1024).toFixed(1) + ' KB';
  return (b/(1024*1024)).toFixed(2) + ' MB';
}

function toggleCandidates(id) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('show');
}

// ── JSON Editor view ──────────────────────────────────────────────
function renderJsonEditor() {
  const jsonStr = JSON.stringify(currentResult, null, 2);
  return `
    <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap">
      <input style="flex:1;min-width:200px;padding:8px 14px;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:.88rem;font-family:var(--mono)"
             id="jsonSearch" placeholder="🔍 Search in JSON…" oninput="highlightJson()">
      <button class="btn btn-secondary btn-sm" onclick="formatJson()">Format</button>
      <button class="btn btn-secondary btn-sm" onclick="collapseJson()">Collapse</button>
    </div>
    <textarea class="json-editor" id="jsonEditor" spellcheck="false">${esc(jsonStr)}</textarea>`;
}

function syncFieldEdits() {
  if (!currentResult) return;
  $$('.field-input[data-field-idx]').forEach(inp => {
    const idx = parseInt(inp.dataset.fieldIdx);
    if (currentResult.fields?.[idx]) currentResult.fields[idx].value = inp.value;
  });
  $$('input[data-table]').forEach(inp => {
    const ti = parseInt(inp.dataset.table);
    const row = parseInt(inp.dataset.row);
    const col = parseInt(inp.dataset.col);
    const cell = currentResult.tables?.[ti]?.cells?.find(c => c.row === row && (c.col === col || c.column === col));
    if (cell) cell.text = inp.value;
  });
}

function validateJson() {
  const ed = $('#jsonEditor'), st = $('#jsonStatus');
  if (!ed || !st) return;
  try { JSON.parse(ed.value); st.textContent = '✓ Valid JSON'; st.className = 'json-status valid'; }
  catch (e) { st.textContent = '✗ ' + e.message; st.className = 'json-status invalid'; }
}
function formatJson() {
  const ed = $('#jsonEditor');
  try { ed.value = JSON.stringify(JSON.parse(ed.value), null, 2); validateJson(); } catch {}
}
function collapseJson() {
  const ed = $('#jsonEditor');
  try { ed.value = JSON.stringify(JSON.parse(ed.value)); validateJson(); } catch {}
}
function highlightJson() {
  const term = $('#jsonSearch')?.value;
  if (!term) return;
  const ed = $('#jsonEditor');
  const idx = ed.value.toLowerCase().indexOf(term.toLowerCase());
  if (idx !== -1) {
    ed.focus(); ed.setSelectionRange(idx, idx + term.length);
    ed.scrollTop = ed.value.substring(0, idx).split('\n').length * 18 - 100;
  }
}

// ──────────────────────────────────────────────────────────────────
//  SAVE / DOWNLOAD
// ──────────────────────────────────────────────────────────────────
async function saveAllEdits() {
  if (!currentJobId) return;
  if (outputView === 'fields') syncFieldEdits();
  else {
    const ed = $('#jsonEditor');
    if (ed) { try { currentResult = JSON.parse(ed.value); } catch { return alert('Fix JSON errors before saving'); } }
  }
  const res = await fetch(`/api/jobs/${currentJobId}/result`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(currentResult)
  });
  if (res.ok) { const st = $('#jsonStatus'); if (st) { st.textContent = '✓ Saved successfully'; st.className = 'json-status valid'; } }
}

function downloadJson() {
  if (!currentResult) return;
  const blob = new Blob([JSON.stringify(currentResult, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = (currentResult?.metadata?.filename || 'document').replace(/\.[^.]+$/, '') + '_result.json';
  a.click(); URL.revokeObjectURL(url);
}

async function downloadMarkdown() {
  if (!currentJobId) return alert('No processed document');
  try {
    const res = await fetch(`/api/jobs/${currentJobId}/download/markdown`);
    if (!res.ok) throw new Error('Download failed');
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (currentResult?.metadata?.filename || 'document').replace(/\.[^.]+$/, '') + '_report.md';
    a.click();
    URL.revokeObjectURL(url);
  } catch (e) { alert('Markdown download failed: ' + e.message); }
}

async function saveToDisk() {
  if (!currentJobId) return alert('No processed document to save');
  if (outputView === 'fields') syncFieldEdits();
  else {
    const ed = $('#jsonEditor');
    if (ed) { try { currentResult = JSON.parse(ed.value); } catch { return alert('Fix JSON errors first'); } }
  }
  await fetch(`/api/jobs/${currentJobId}/result`, {
    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(currentResult)
  });
  try {
    const res = await fetch(`/api/jobs/${currentJobId}/save`, { method: 'POST' });
    if (!res.ok) { const e = await res.json(); throw new Error(e.detail || 'Save failed'); }
    const data = await res.json();
    const st = $('#jsonStatus');
    if (st) { st.textContent = `✓ Saved to ${data.path}`; st.className = 'json-status valid'; }
  } catch (e) { alert('Failed to save: ' + e.message); }
}

// ──────────────────────────────────────────────────────────────────
//  HISTORY PANEL
// ──────────────────────────────────────────────────────────────────
async function loadHistory() {
  try {
    const res = await fetch('/api/history');
    if (!res.ok) return;
    renderHistory((await res.json()).jobs);
  } catch (e) { console.warn('History load error:', e); }
}

function renderHistory(jobs) {
  const tbody = $('#historyTableBody');
  if (!jobs?.length) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--muted);padding:40px">No documents processed yet</td></tr>';
    return;
  }
  tbody.innerHTML = jobs.map(j => {
    const mode = j.processing_mode === 'azure' ? '☁ Azure' : '🖥 Local';
    const dot  = `<span class="status-dot ${j.status}"></span>${j.status}`;
    const time = j.processing_time ? j.processing_time.toFixed(1) + 's' : '—';
    const created = j.created ? new Date(j.created).toLocaleString() : '—';
    return `<tr onclick="loadJob('${j.job_id}')">
      <td><strong>${esc(j.filename)}</strong></td>
      <td>${mode}</td><td>${dot}</td>
      <td>${j.page_count ?? '—'}</td><td>${j.text_lines ?? '—'}</td>
      <td>${j.tables ?? '—'}</td><td>${j.fields ?? '—'}</td>
      <td style="font-family:var(--mono);font-size:.8rem">${time}</td>
      <td style="font-size:.8rem;color:var(--muted)">${created}</td>
    </tr>`;
  }).join('');
}

async function loadJob(jobId) {
  currentJobId = jobId;
  try { await loadResult(); await loadArtifacts(); $$('.tab')[1].click(); }
  catch (e) { alert('Could not load job: ' + e.message); }
}

// ──────────────────────────────────────────────────────────────────
//  COST & USAGE DASHBOARD
// ──────────────────────────────────────────────────────────────────
async function loadCosts() {
  try {
    const res = await fetch('/api/costs');
    if (!res.ok) return;
    renderCosts(await res.json());
  } catch (e) { console.warn('Costs load error:', e); }
}

function renderCosts(data) {
  const c = data.costs || {};
  const cache = data.cache || {};

  $('#ccTotalCost').textContent  = '$' + (c.estimated_cost_usd || 0).toFixed(4);
  $('#ccTotalCalls').textContent = c.total_calls || 0;
  $('#ccDICalls').textContent    = c.total_di_calls || 0;
  $('#ccGPTCalls').textContent   = c.total_gpt_calls || 0;
  $('#ccPages').textContent      = c.total_pages_analysed || 0;
  $('#ccTokens').textContent     = (c.total_tokens || 0).toLocaleString();
  $('#ccCacheHits').textContent  = c.cache_hits || 0;
  $('#ccSaved').textContent      = '$' + (c.cost_saved_by_cache_usd || 0).toFixed(4);

  const hits = cache.hits || 0, misses = cache.misses || 0, total = hits + misses;
  const hitPct = total > 0 ? (hits / total * 100) : 0;
  $('#cacheHitBar').style.width  = hitPct + '%';
  $('#cacheMissBar').style.width = (100 - hitPct) + '%';
  $('#cacheHitPct').textContent  = hitPct.toFixed(0) + '% hits (' + hits + ')';
  $('#cacheMissPct').textContent = (100 - hitPct).toFixed(0) + '% misses (' + misses + ')';
  $('#cacheEntries').textContent = cache.entries || 0;
  const cs = $('#cacheStatus');
  cs.textContent = cache.enabled ? '✓ Active' : '○ Inactive';
  cs.style.color = cache.enabled ? 'var(--success)' : 'var(--muted)';

  const records = c.records || [];
  let diCost = 0, gptCost = 0, diPages = 0, gptTokens = 0;
  records.forEach(r => {
    if (r.service === 'doc_intelligence') { diCost += r.estimated_cost_usd; diPages += r.pages; }
    else if (r.service === 'gpt_vision') { gptCost += r.estimated_cost_usd; gptTokens += (r.prompt_tokens || 0) + (r.completion_tokens || 0); }
  });
  $('#bdDICalls').textContent  = c.total_di_calls || 0;
  $('#bdDIPages').textContent  = diPages;
  $('#bdDICost').textContent   = '$' + diCost.toFixed(4);
  $('#bdGPTCalls').textContent = c.total_gpt_calls || 0;
  $('#bdGPTTokens').textContent = gptTokens.toLocaleString();
  $('#bdGPTCost').textContent  = '$' + gptCost.toFixed(4);

  const tbody = $('#costTableBody');
  if (!records.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:30px">No API calls recorded yet</td></tr>';
    return;
  }
  tbody.innerHTML = [...records].reverse().map(r => {
    const svcCls = r.service === 'doc_intelligence' ? 'svc-di' : 'svc-gpt';
    const svcLbl = r.service === 'doc_intelligence' 
      ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px;margin-right:3px"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>DI' 
      : '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px;margin-right:3px"><path d="M12 8V4H8"/><rect x="8" y="2" width="8" height="4" rx="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11v6"/><path d="m9 14 3-3 3 3"/></svg>GPT';
    const detail = r.service === 'doc_intelligence'
      ? (r.pages || 0) + ' page' + ((r.pages || 0) !== 1 ? 's' : '')
      : ((r.prompt_tokens || 0) + (r.completion_tokens || 0)).toLocaleString() + ' tok';
    const ts = r.timestamp ? new Date(r.timestamp).toLocaleTimeString() : '—';
    const cached = r.cached ? '<span class="cached-tag">CACHED</span>' : '';
    return `<tr><td class="time-col">${ts}</td><td><span class="svc ${svcCls}">${svcLbl}</span></td><td>${r.model || '—'}</td><td>${detail}</td><td class="time-col">${(r.latency_seconds || 0).toFixed(1)}s</td><td>$${(r.estimated_cost_usd || 0).toFixed(4)}</td><td>${cached}</td></tr>`;
  }).join('');
}

async function resetCosts() {
  if (!confirm('Reset all cost tracking counters?')) return;
  try { await fetch('/api/costs/reset', { method: 'POST' }); await loadCosts(); } catch (e) { alert('Failed: ' + e.message); }
}
async function clearCache() {
  if (!confirm('Clear the entire Azure response cache?')) return;
  try {
    const res = await fetch('/api/cache/clear', { method: 'POST' });
    const data = await res.json();
    alert(`Cache cleared — ${data.entries_cleared} entries removed`);
    await loadCosts();
  } catch (e) { alert('Failed: ' + e.message); }
}

// ──────────────────────────────────────────────────────────────────
//  LIGHTBOX
// ──────────────────────────────────────────────────────────────────
function showLightbox(url) {
  lightboxImg.src = url;
  lightbox.classList.add('show');
}
lightbox.addEventListener('click', () => lightbox.classList.remove('show'));
document.addEventListener('keydown', e => { if (e.key === 'Escape') lightbox.classList.remove('show'); });

// ──────────────────────────────────────────────────────────────────
//  UTILITY
// ──────────────────────────────────────────────────────────────────
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escAttr(s) { return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>
