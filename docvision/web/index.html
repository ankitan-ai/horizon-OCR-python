<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DocVision â€” Document Scanner</title>
<style>
/* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1117;--surface:#1a1d27;--surface2:#242836;--surface3:#2e3345;
  --border:#363b4e;--text:#e4e6f0;--muted:#8890a4;
  --primary:#6366f1;--primary-hover:#818cf8;--primary-bg:rgba(99,102,241,.12);
  --success:#22c55e;--warning:#f59e0b;--error:#ef4444;
  --radius:10px;--shadow:0 4px 24px rgba(0,0,0,.35);
  --font:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  --mono:'Cascadia Code','Fira Code','JetBrains Mono',monospace;
}
html{font-size:15px}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh}
a{color:var(--primary);text-decoration:none}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app{max-width:1320px;margin:0 auto;padding:20px 28px 60px}
header{display:flex;align-items:center;gap:14px;padding:18px 0 28px;border-bottom:1px solid var(--border)}
header h1{font-size:1.55rem;font-weight:700;letter-spacing:-.3px}
header h1 span{color:var(--primary)}
header .version{font-size:.78rem;color:var(--muted);margin-left:auto}

/* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs{display:flex;gap:6px;margin:24px 0 20px;border-bottom:2px solid var(--border);padding-bottom:0}
.tab{padding:10px 22px;cursor:pointer;font-size:.9rem;font-weight:500;color:var(--muted);border-bottom:2px solid transparent;margin-bottom:-2px;transition:.2s;user-select:none;border-radius:var(--radius) var(--radius) 0 0}
.tab:hover{color:var(--text);background:var(--surface)}
.tab.active{color:var(--primary);border-bottom-color:var(--primary);background:var(--surface)}
.panel{display:none}
.panel.active{display:block}

/* â”€â”€ Upload Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.drop-zone{
  border:2px dashed var(--border);border-radius:var(--radius);padding:56px 28px;
  text-align:center;cursor:pointer;transition:.3s;position:relative;
  background:var(--surface)
}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--primary);background:var(--primary-bg)}
.drop-zone .icon{font-size:3rem;margin-bottom:14px;opacity:.6}
.drop-zone p{color:var(--muted);margin-top:6px;font-size:.88rem}
.drop-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}

/* â”€â”€ Options Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.options{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:10px;margin:20px 0}
.opt{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--surface);border-radius:var(--radius);font-size:.85rem}
.opt input[type=checkbox]{accent-color:var(--primary);width:16px;height:16px}
.mode-row{display:flex;gap:14px;margin:18px 0 10px;flex-wrap:wrap;align-items:center}
.mode-row label{font-size:.88rem;color:var(--muted);font-weight:500}
.mode-row select{
  padding:8px 14px;border-radius:var(--radius);border:1px solid var(--border);
  background:var(--surface);color:var(--text);font-size:.88rem;cursor:pointer;
  min-width:180px
}
.mode-row select:focus{outline:none;border-color:var(--primary)}
.mode-badge{font-size:.72rem;padding:3px 10px;border-radius:20px;font-weight:600;letter-spacing:.3px}
.mode-badge.local{background:rgba(99,102,241,.15);color:var(--primary)}
.mode-badge.azure{background:rgba(34,197,94,.15);color:var(--success)}
.mode-badge.hybrid{background:rgba(245,158,11,.15);color:var(--warning)}

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{
  display:inline-flex;align-items:center;gap:8px;padding:10px 24px;
  border:none;border-radius:var(--radius);font-size:.9rem;font-weight:600;
  cursor:pointer;transition:.2s
}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:var(--primary-hover)}
.btn-primary:disabled{opacity:.45;cursor:not-allowed}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--surface3)}
.btn-success{background:var(--success);color:#fff}
.btn-sm{padding:6px 14px;font-size:.82rem}

/* â”€â”€ Progress / Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.status-bar{margin:20px 0;padding:16px 20px;border-radius:var(--radius);background:var(--surface);display:none;align-items:center;gap:14px}
.status-bar.show{display:flex}
.spinner{width:22px;height:22px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.status-text{flex:1;font-size:.9rem}
.status-time{font-size:.8rem;color:var(--muted);font-family:var(--mono)}

/* â”€â”€ Artifact Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.artifacts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:18px;margin-top:16px}
.artifact-card{background:var(--surface);border-radius:var(--radius);overflow:hidden;border:1px solid var(--border);transition:.2s}
.artifact-card:hover{border-color:var(--primary);box-shadow:var(--shadow)}
.artifact-card img{width:100%;display:block;cursor:pointer;background:#000}
.artifact-card .label{padding:10px 14px;font-size:.82rem;color:var(--muted);display:flex;justify-content:space-between}

/* â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:999;display:none;justify-content:center;align-items:center;cursor:zoom-out}
.lightbox.show{display:flex}
.lightbox img{max-width:94vw;max-height:92vh;border-radius:6px;box-shadow:0 8px 40px rgba(0,0,0,.5)}

/* â”€â”€ JSON Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.editor-toolbar{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.editor-toolbar .search-box{flex:1;min-width:200px;padding:8px 14px;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:.88rem;font-family:var(--mono)}
.json-editor{
  width:100%;min-height:520px;padding:18px;border-radius:var(--radius);
  border:1px solid var(--border);background:var(--surface);color:var(--text);
  font-family:var(--mono);font-size:.82rem;line-height:1.55;resize:vertical;
  tab-size:2;white-space:pre;overflow:auto
}
.json-editor:focus{outline:none;border-color:var(--primary)}
.json-status{font-size:.8rem;margin-top:8px}
.json-status.valid{color:var(--success)}
.json-status.invalid{color:var(--error)}

/* â”€â”€ Stats Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats{display:flex;gap:14px;flex-wrap:wrap;margin:16px 0}
.stat{background:var(--surface);border-radius:var(--radius);padding:14px 20px;min-width:130px;border:1px solid var(--border)}
.stat .value{font-size:1.5rem;font-weight:700;color:var(--primary)}
.stat .label{font-size:.78rem;color:var(--muted);margin-top:2px}

/* â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty{text-align:center;padding:60px 20px;color:var(--muted)}
.empty .icon{font-size:3rem;margin-bottom:12px;opacity:.4}

/* â”€â”€ Cost Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cost-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;margin:16px 0}
.cost-card{background:var(--surface);border-radius:var(--radius);padding:18px 20px;border:1px solid var(--border);position:relative;overflow:hidden}
.cost-card .value{font-size:1.7rem;font-weight:700;margin-bottom:2px}
.cost-card .value.money{color:var(--success)}
.cost-card .value.count{color:var(--primary)}
.cost-card .value.cache{color:var(--warning)}
.cost-card .label{font-size:.78rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.cost-card .badge{position:absolute;top:12px;right:12px;font-size:.7rem;padding:2px 8px;border-radius:12px;background:var(--primary-bg);color:var(--primary);font-weight:600}

.cost-section{margin:28px 0 16px}
.cost-section h3{font-size:1rem;font-weight:600;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:8px}

.cost-actions{display:flex;gap:10px;flex-wrap:wrap;margin:18px 0}

.cost-table{width:100%;border-collapse:collapse;font-size:.82rem}
.cost-table thead{position:sticky;top:0}
.cost-table th{text-align:left;padding:10px 14px;background:var(--surface2);color:var(--muted);font-weight:600;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
.cost-table td{padding:9px 14px;border-bottom:1px solid var(--border);color:var(--text)}
.cost-table tr:hover td{background:var(--surface)}
.cost-table .svc{font-weight:600;display:flex;align-items:center;gap:6px}
.cost-table .svc-di{color:var(--primary)}
.cost-table .svc-gpt{color:var(--success)}
.cost-table .cached-tag{font-size:.7rem;padding:1px 7px;border-radius:10px;background:rgba(245,158,11,.15);color:var(--warning);font-weight:600}
.cost-table .time-col{font-family:var(--mono);font-size:.78rem;color:var(--muted)}
.cost-table-wrap{max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius);background:var(--surface)}

.cache-bar{height:24px;border-radius:12px;background:var(--surface2);overflow:hidden;display:flex;margin-top:8px}
.cache-bar .hits{background:var(--success);transition:width .4s ease}
.cache-bar .misses{background:var(--error);opacity:.4;transition:width .4s ease}
.cache-bar-labels{display:flex;justify-content:space-between;font-size:.75rem;color:var(--muted);margin-top:4px}

.cost-refresh{font-size:.75rem;color:var(--muted);margin-left:auto;display:flex;align-items:center;gap:4px}
.cost-refresh .dot{width:6px;height:6px;border-radius:50%;background:var(--success);display:inline-block;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}

.breakdown-row{display:flex;gap:20px;flex-wrap:wrap}
.breakdown-box{flex:1;min-width:220px;background:var(--surface);border-radius:var(--radius);padding:16px 18px;border:1px solid var(--border)}
.breakdown-box h4{font-size:.85rem;color:var(--muted);margin-bottom:10px;font-weight:500}
.breakdown-item{display:flex;justify-content:space-between;padding:5px 0;font-size:.84rem}
.breakdown-item .lbl{color:var(--muted)}
.breakdown-item .val{font-weight:600;font-family:var(--mono)}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:640px){
  .app{padding:12px 14px 40px}
  .artifacts-grid{grid-template-columns:1fr}
  .options{grid-template-columns:1fr 1fr}
  .tabs{overflow-x:auto}
}
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <header>
    <h1>ğŸ“„ Doc<span>Vision</span></h1>
    <span class="version" id="versionBadge">loadingâ€¦</span>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="upload">â¬† Upload &amp; Scan</div>
    <div class="tab" data-tab="artifacts">ğŸ” Artifacts</div>
    <div class="tab" data-tab="output">ğŸ“ JSON Output</div>
    <div class="tab" data-tab="costs">ğŸ’° Cost &amp; Usage</div>
  </div>

  <!-- â”€â”€â”€ UPLOAD PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel active" id="panel-upload">
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.tiff,.tif,.bmp,.webp">
      <div class="icon">ğŸ“</div>
      <div><strong>Drop a document here</strong> or click to browse</div>
      <p>PDF Â· JPEG Â· PNG Â· TIFF Â· BMP Â· WebP</p>
    </div>

    <div id="fileInfo" style="margin:14px 0;font-size:.9rem;display:none"></div>

    <!-- Processing Mode -->
    <div class="mode-row">
      <label for="modeSelect">Processing Mode</label>
      <select id="modeSelect">
        <option value="local">ğŸ–¥ Local Models</option>
        <option value="azure">â˜ Azure Cloud</option>
      </select>
      <span class="mode-badge local" id="modeBadge">LOCAL</span>
      <label for="docTypeSelect" id="docTypeLabel" style="margin-left:18px;display:none">Document Type</label>
      <select id="docTypeSelect" style="display:none">
        <option value="auto">Auto-detect</option>
        <option value="bol">Bill of Lading</option>
        <option value="invoice">Invoice</option>
        <option value="receipt">Receipt</option>
        <option value="delivery_ticket">Delivery Ticket</option>
      </select>
    </div>

    <details style="margin-top:16px" id="localOptionsDetails">
      <summary style="cursor:pointer;color:var(--muted);font-size:.88rem">âš™ Processing Options</summary>
      <div class="options" id="optionsGrid">
        <label class="opt"><input type="checkbox" name="preprocess" checked> Preprocess</label>
        <label class="opt"><input type="checkbox" name="detect_layout" checked> Layout Detection</label>
        <label class="opt"><input type="checkbox" name="detect_text" checked> Text Detection</label>
        <label class="opt"><input type="checkbox" name="detect_tables" checked> Table Detection</label>
        <label class="opt"><input type="checkbox" name="run_ocr" checked> OCR Recognition</label>
        <label class="opt"><input type="checkbox" name="run_donut"> Donut KIE</label>
        <label class="opt"><input type="checkbox" name="run_layoutlmv3"> LayoutLMv3 KIE</label>
        <label class="opt"><input type="checkbox" name="run_validators" checked> Validators</label>
      </div>
    </details>

    <div style="margin-top:20px">
      <button class="btn btn-primary" id="btnProcess" disabled>ğŸš€ Process Document</button>
    </div>

    <div class="status-bar" id="statusBar">
      <div class="spinner"></div>
      <div class="status-text" id="statusText">Processingâ€¦</div>
      <div class="status-time" id="statusTime">0s</div>
    </div>
  </div>

  <!-- â”€â”€â”€ ARTIFACTS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel" id="panel-artifacts">
    <div id="artifactsContent">
      <div class="empty"><div class="icon">ğŸ”</div><p>Upload and process a document first</p></div>
    </div>
  </div>

  <!-- â”€â”€â”€ JSON OUTPUT PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel" id="panel-output">
    <div id="outputContent">
      <div class="empty"><div class="icon">ğŸ“</div><p>Upload and process a document first</p></div>
    </div>
  </div>

  <!-- â”€â”€â”€ COST & USAGE PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel" id="panel-costs">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
      <h2 style="font-size:1.15rem;font-weight:700">Azure API Usage</h2>
      <span class="cost-refresh" id="costRefreshIndicator"><span class="dot"></span> Live</span>
    </div>

    <!-- Summary cards -->
    <div class="cost-grid" id="costCards">
      <div class="cost-card"><div class="value money" id="ccTotalCost">$0.00</div><div class="label">Estimated Cost</div></div>
      <div class="cost-card"><div class="value count" id="ccTotalCalls">0</div><div class="label">Total API Calls</div></div>
      <div class="cost-card"><div class="value count" id="ccDICalls">0</div><div class="label">Doc Intelligence</div><div class="badge">DI</div></div>
      <div class="cost-card"><div class="value count" id="ccGPTCalls">0</div><div class="label">GPT Vision</div><div class="badge" style="background:rgba(34,197,94,.12);color:var(--success)">GPT</div></div>
      <div class="cost-card"><div class="value count" id="ccPages">0</div><div class="label">Pages Analysed</div></div>
      <div class="cost-card"><div class="value count" id="ccTokens">0</div><div class="label">Tokens Used</div></div>
      <div class="cost-card"><div class="value cache" id="ccCacheHits">0</div><div class="label">Cache Hits</div></div>
      <div class="cost-card"><div class="value money" id="ccSaved">$0.00</div><div class="label">Saved by Cache</div></div>
    </div>

    <!-- Cache hit-rate bar -->
    <div class="cost-section">
      <h3>ğŸ“Š Cache Performance</h3>
      <div class="breakdown-row">
        <div class="breakdown-box" style="flex:2">
          <h4>Hit Rate</h4>
          <div class="cache-bar"><div class="hits" id="cacheHitBar" style="width:0%"></div><div class="misses" id="cacheMissBar" style="width:0%"></div></div>
          <div class="cache-bar-labels"><span id="cacheHitPct">0% hits</span><span id="cacheMissPct">0% misses</span></div>
        </div>
        <div class="breakdown-box">
          <h4>Cache Store</h4>
          <div class="breakdown-item"><span class="lbl">Entries</span><span class="val" id="cacheEntries">0</span></div>
          <div class="breakdown-item"><span class="lbl">Status</span><span class="val" id="cacheStatus">â€”</span></div>
        </div>
      </div>
    </div>

    <!-- Cost breakdown -->
    <div class="cost-section">
      <h3>ğŸ’µ Cost Breakdown</h3>
      <div class="breakdown-row" id="costBreakdown">
        <div class="breakdown-box">
          <h4>Document Intelligence</h4>
          <div class="breakdown-item"><span class="lbl">Calls</span><span class="val" id="bdDICalls">0</span></div>
          <div class="breakdown-item"><span class="lbl">Pages</span><span class="val" id="bdDIPages">0</span></div>
          <div class="breakdown-item"><span class="lbl">Cost</span><span class="val" id="bdDICost">$0.00</span></div>
        </div>
        <div class="breakdown-box">
          <h4>GPT Vision</h4>
          <div class="breakdown-item"><span class="lbl">Calls</span><span class="val" id="bdGPTCalls">0</span></div>
          <div class="breakdown-item"><span class="lbl">Tokens</span><span class="val" id="bdGPTTokens">0</span></div>
          <div class="breakdown-item"><span class="lbl">Cost</span><span class="val" id="bdGPTCost">$0.00</span></div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="cost-actions">
      <button class="btn btn-secondary btn-sm" onclick="loadCosts()">ğŸ”„ Refresh</button>
      <button class="btn btn-secondary btn-sm" onclick="resetCosts()" style="color:var(--warning)">ğŸ—‘ Reset Counters</button>
      <button class="btn btn-secondary btn-sm" onclick="clearCache()" style="color:var(--error)">ğŸ§¹ Clear Cache</button>
    </div>

    <!-- Call history table -->
    <div class="cost-section">
      <h3>ğŸ“‹ Call History</h3>
      <div class="cost-table-wrap" id="costTableWrap">
        <table class="cost-table">
          <thead><tr><th>Time</th><th>Service</th><th>Model</th><th>Detail</th><th>Latency</th><th>Cost</th><th></th></tr></thead>
          <tbody id="costTableBody">
            <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:30px">No API calls recorded yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox">
  <img id="lightboxImg" src="">
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentJobId = null;
let currentResult = null;
let selectedFile = null;
let pollTimer = null;
let processStart = 0;

// â”€â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const dropZone      = $('#dropZone');
const fileInput     = $('#fileInput');
const fileInfo      = $('#fileInfo');
const btnProcess    = $('#btnProcess');
const statusBar     = $('#statusBar');
const statusText    = $('#statusText');
const statusTime    = $('#statusTime');
const lightbox      = $('#lightbox');
const lightboxImg   = $('#lightboxImg');
const modeSelect    = $('#modeSelect');
const modeBadge     = $('#modeBadge');
const docTypeSelect = $('#docTypeSelect');
const docTypeLabel  = $('#docTypeLabel');
const localDetails  = $('#localOptionsDetails');

// â”€â”€â”€ Mode toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
modeSelect.addEventListener('change', () => {
  const mode = modeSelect.value;
  modeBadge.textContent = mode.toUpperCase();
  modeBadge.className = 'mode-badge ' + mode;
  const isAzure = mode === 'azure';
  localDetails.style.display = isAzure ? 'none' : '';
  docTypeSelect.style.display = isAzure ? '' : 'none';
  docTypeLabel.style.display = isAzure ? '' : 'none';
});

// â”€â”€â”€ Version badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fetch('/api/jobs/_').catch(()=>{});
$('#versionBadge').textContent = 'DocVision Web UI';

// â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$$('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    $$('.tab').forEach(t => t.classList.remove('active'));
    $$('.panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    $(`#panel-${tab.dataset.tab}`).classList.add('active');
  });
});

// â”€â”€â”€ File Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fileInput.addEventListener('change', e => {
  if (e.target.files.length) pickFile(e.target.files[0]);
});
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('dragover');
  if (e.dataTransfer.files.length) pickFile(e.dataTransfer.files[0]);
});

function pickFile(f) {
  selectedFile = f;
  const sizeMB = (f.size / 1024 / 1024).toFixed(2);
  fileInfo.innerHTML = `<strong>ğŸ“ ${f.name}</strong> &nbsp;(${sizeMB} MB)`;
  fileInfo.style.display = 'block';
  btnProcess.disabled = false;
}

// â”€â”€â”€ Processing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnProcess.addEventListener('click', async () => {
  if (!selectedFile) return;

  // Collect options
  const form = new FormData();
  form.append('file', selectedFile);
  form.append('processing_mode', modeSelect.value);
  form.append('document_type', docTypeSelect.value);
  $$('#optionsGrid input[type=checkbox]').forEach(cb => {
    form.append(cb.name, cb.checked ? 'true' : 'false');
  });

  btnProcess.disabled = true;
  statusBar.classList.add('show');
  statusText.textContent = 'Uploading & starting processingâ€¦';
  processStart = Date.now();
  updateTimer();

  try {
    const res = await fetch('/api/process', { method: 'POST', body: form });
    if (!res.ok) throw new Error((await res.json()).detail || res.statusText);
    const data = await res.json();
    currentJobId = data.job_id;
    statusText.textContent = 'Processing documentâ€¦ This may take a few minutes.';
    pollStatus();
  } catch (err) {
    statusText.textContent = `âŒ Error: ${err.message}`;
    btnProcess.disabled = false;
  }
});

function updateTimer() {
  if (!statusBar.classList.contains('show')) return;
  const elapsed = ((Date.now() - processStart) / 1000).toFixed(0);
  statusTime.textContent = `${elapsed}s`;
  requestAnimationFrame(() => setTimeout(updateTimer, 500));
}

async function pollStatus() {
  try {
    const res = await fetch(`/api/jobs/${currentJobId}`);
    const job = await res.json();

    if (job.status === 'completed') {
      statusText.textContent = 'âœ… Processing complete!';
      setTimeout(() => statusBar.classList.remove('show'), 3000);
      btnProcess.disabled = false;
      await loadResult();
      await loadArtifacts();
      // Refresh cost data after processing
      loadCosts();
      // Auto-switch to artifacts tab
      $$('.tab')[1].click();
    } else if (job.status === 'failed') {
      statusText.textContent = `âŒ Failed: ${job.error}`;
      btnProcess.disabled = false;
    } else {
      setTimeout(pollStatus, 1500);
    }
  } catch {
    setTimeout(pollStatus, 2000);
  }
}

// â”€â”€â”€ Load Result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadResult() {
  const res = await fetch(`/api/jobs/${currentJobId}/result`);
  currentResult = await res.json();
  renderOutput();
}

// â”€â”€â”€ Load Artifacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadArtifacts() {
  const res = await fetch(`/api/jobs/${currentJobId}/artifacts`);
  const data = await res.json();
  renderArtifacts(data.artifacts);
}

// â”€â”€â”€ Render Artifacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderArtifacts(artifacts) {
  const el = $('#artifactsContent');
  if (!artifacts.length) {
    el.innerHTML = '<div class="empty"><div class="icon">ğŸ”</div><p>No artifacts generated</p></div>';
    return;
  }

  // Group by page
  const pages = {};
  artifacts.forEach(a => {
    const m = a.name.match(/page_(\d+)/);
    const pageNum = m ? parseInt(m[1]) : 0;
    if (!pages[pageNum]) pages[pageNum] = [];
    pages[pageNum].push(a);
  });

  let html = '';
  if (currentResult) {
    html += '<div class="stats">';
    html += stat('Pages', currentResult.page_count || 0);
    html += stat('Text Lines', countLines());
    html += stat('Tables', (currentResult.tables || []).length);
    html += stat('Fields', (currentResult.fields || []).length);
    html += stat('Time', (currentResult.metadata?.processing_time_seconds || 0).toFixed(1) + 's');
    html += '</div>';
  }

  for (const [pageNum, arts] of Object.entries(pages)) {
    html += `<h3 style="margin:20px 0 10px;color:var(--muted)">Page ${pageNum}</h3>`;
    html += '<div class="artifacts-grid">';
    for (const a of arts) {
      const friendlyName = a.name.replace(/page_\d+_/, '').replace(/_/g, ' ');
      html += `
        <div class="artifact-card">
          <img src="${a.url}" alt="${a.name}" onclick="showLightbox('${a.url}')" loading="lazy">
          <div class="label">
            <span>${friendlyName}</span>
            <span>${a.size_kb} KB</span>
          </div>
        </div>`;
    }
    html += '</div>';
  }
  el.innerHTML = html;
}

function stat(label, value) {
  return `<div class="stat"><div class="value">${value}</div><div class="label">${label}</div></div>`;
}
function countLines() {
  if (!currentResult?.pages) return 0;
  return currentResult.pages.reduce((s,p) => s + (p.text_lines?.length || 0), 0);
}

// â”€â”€â”€ Render JSON Output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOutput() {
  const el = $('#outputContent');
  const jsonStr = JSON.stringify(currentResult, null, 2);

  el.innerHTML = `
    <div class="editor-toolbar">
      <input class="search-box" id="jsonSearch" placeholder="ğŸ” Search in JSONâ€¦" oninput="highlightJson()">
      <button class="btn btn-secondary btn-sm" onclick="formatJson()">Format</button>
      <button class="btn btn-secondary btn-sm" onclick="collapseJson()">Collapse</button>
      <button class="btn btn-success btn-sm" onclick="saveEdits()">ğŸ’¾ Save Edits</button>
      <button class="btn btn-primary btn-sm" onclick="saveToDisk()">ğŸ“‚ Save to Disk</button>
      <button class="btn btn-secondary btn-sm" onclick="downloadJson()">â¬‡ Download</button>
    </div>
    <textarea class="json-editor" id="jsonEditor" spellcheck="false">${escHtml(jsonStr)}</textarea>
    <div class="json-status" id="jsonStatus"></div>
  `;

  // Validate on input
  $('#jsonEditor').addEventListener('input', validateJson);
  validateJson();
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function validateJson() {
  const editor = $('#jsonEditor');
  const status = $('#jsonStatus');
  try {
    JSON.parse(editor.value);
    status.textContent = 'âœ“ Valid JSON';
    status.className = 'json-status valid';
  } catch(e) {
    status.textContent = 'âœ— ' + e.message;
    status.className = 'json-status invalid';
  }
}

function formatJson() {
  const editor = $('#jsonEditor');
  try {
    const obj = JSON.parse(editor.value);
    editor.value = JSON.stringify(obj, null, 2);
    validateJson();
  } catch {}
}

function collapseJson() {
  const editor = $('#jsonEditor');
  try {
    const obj = JSON.parse(editor.value);
    editor.value = JSON.stringify(obj);
    validateJson();
  } catch {}
}

async function saveEdits() {
  const editor = $('#jsonEditor');
  try {
    const obj = JSON.parse(editor.value);
    const res = await fetch(`/api/jobs/${currentJobId}/result`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(obj)
    });
    if (res.ok) {
      currentResult = obj;
      const status = $('#jsonStatus');
      status.textContent = 'âœ“ Saved successfully';
      status.className = 'json-status valid';
    }
  } catch(e) {
    alert('Fix JSON errors before saving');
  }
}

function downloadJson() {
  const editor = $('#jsonEditor');
  try {
    const obj = JSON.parse(editor.value);
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (currentResult?.metadata?.filename || 'document').replace(/\.[^.]+$/, '') + '_result.json';
    a.click();
    URL.revokeObjectURL(url);
  } catch {
    alert('Fix JSON errors before downloading');
  }
}

function highlightJson() {
  // Simple scroll-to for search
  const term = $('#jsonSearch').value;
  if (!term) return;
  const editor = $('#jsonEditor');
  const idx = editor.value.toLowerCase().indexOf(term.toLowerCase());
  if (idx !== -1) {
    editor.focus();
    editor.setSelectionRange(idx, idx + term.length);
    // Scroll to selection
    const linesBefore = editor.value.substring(0, idx).split('\n').length;
    editor.scrollTop = linesBefore * 18 - 100;
  }
}

async function saveToDisk() {
  if (!currentJobId) return alert('No processed document to save');
  // Save any pending edits first
  const editor = $('#jsonEditor');
  if (editor) {
    try {
      const obj = JSON.parse(editor.value);
      await fetch(`/api/jobs/${currentJobId}/result`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(obj)
      });
      currentResult = obj;
    } catch {
      return alert('Fix JSON errors before saving to disk');
    }
  }
  try {
    const res = await fetch(`/api/jobs/${currentJobId}/save`, { method: 'POST' });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || 'Save failed');
    }
    const data = await res.json();
    const status = $('#jsonStatus');
    if (status) {
      status.textContent = `âœ“ Saved to ${data.path}`;
      status.className = 'json-status valid';
    }
  } catch (e) {
    alert('Failed to save: ' + e.message);
  }
}

// â”€â”€â”€ Cost & Usage Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let costRefreshTimer = null;

async function loadCosts() {
  try {
    const res = await fetch('/api/costs');
    if (!res.ok) return;
    const data = await res.json();
    renderCosts(data);
  } catch (e) {
    console.warn('Failed to load costs:', e);
  }
}

function renderCosts(data) {
  const c = data.costs || {};
  const cache = data.cache || {};

  // Summary cards
  $('#ccTotalCost').textContent = '$' + (c.estimated_cost_usd || 0).toFixed(4);
  $('#ccTotalCalls').textContent = c.total_calls || 0;
  $('#ccDICalls').textContent = c.total_di_calls || 0;
  $('#ccGPTCalls').textContent = c.total_gpt_calls || 0;
  $('#ccPages').textContent = c.total_pages_analysed || 0;
  $('#ccTokens').textContent = (c.total_tokens || 0).toLocaleString();
  $('#ccCacheHits').textContent = c.cache_hits || 0;
  $('#ccSaved').textContent = '$' + (c.cost_saved_by_cache_usd || 0).toFixed(4);

  // Cache performance bar
  const hits = cache.hits || 0;
  const misses = cache.misses || 0;
  const total = hits + misses;
  const hitPct = total > 0 ? (hits / total * 100) : 0;
  const missPct = total > 0 ? (misses / total * 100) : 0;
  $('#cacheHitBar').style.width = hitPct + '%';
  $('#cacheMissBar').style.width = missPct + '%';
  $('#cacheHitPct').textContent = hitPct.toFixed(0) + '% hits (' + hits + ')';
  $('#cacheMissPct').textContent = missPct.toFixed(0) + '% misses (' + misses + ')';
  $('#cacheEntries').textContent = cache.entries || 0;
  $('#cacheStatus').textContent = cache.enabled ? 'âœ“ Active' : 'â—‹ Inactive';
  $('#cacheStatus').style.color = cache.enabled ? 'var(--success)' : 'var(--muted)';

  // Cost breakdown by service
  const records = c.records || [];
  let diCost = 0, gptCost = 0, diPages = 0, gptTokens = 0;
  records.forEach(r => {
    if (r.service === 'doc_intelligence') {
      diCost += r.estimated_cost_usd;
      diPages += r.pages;
    } else if (r.service === 'gpt_vision') {
      gptCost += r.estimated_cost_usd;
      gptTokens += r.prompt_tokens + r.completion_tokens;
    }
  });
  $('#bdDICalls').textContent = c.total_di_calls || 0;
  $('#bdDIPages').textContent = diPages;
  $('#bdDICost').textContent = '$' + diCost.toFixed(4);
  $('#bdGPTCalls').textContent = c.total_gpt_calls || 0;
  $('#bdGPTTokens').textContent = gptTokens.toLocaleString();
  $('#bdGPTCost').textContent = '$' + gptCost.toFixed(4);

  // Call history table
  const tbody = $('#costTableBody');
  if (!records.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:30px">No API calls recorded yet</td></tr>';
    return;
  }

  // Show newest first
  const sorted = [...records].reverse();
  tbody.innerHTML = sorted.map(r => {
    const svcClass = r.service === 'doc_intelligence' ? 'svc-di' : 'svc-gpt';
    const svcLabel = r.service === 'doc_intelligence' ? 'ğŸ” DI' : 'ğŸ¤– GPT';
    const detail = r.service === 'doc_intelligence'
      ? r.pages + ' page' + (r.pages !== 1 ? 's' : '')
      : (r.prompt_tokens + r.completion_tokens).toLocaleString() + ' tok';
    const time = r.timestamp ? new Date(r.timestamp).toLocaleTimeString() : 'â€”';
    const cachedTag = r.cached ? '<span class="cached-tag">CACHED</span>' : '';
    return `<tr>
      <td class="time-col">${time}</td>
      <td><span class="svc ${svcClass}">${svcLabel}</span></td>
      <td>${r.model}</td>
      <td>${detail}</td>
      <td class="time-col">${r.latency_seconds.toFixed(1)}s</td>
      <td>$${r.estimated_cost_usd.toFixed(4)}</td>
      <td>${cachedTag}</td>
    </tr>`;
  }).join('');
}

async function resetCosts() {
  if (!confirm('Reset all cost tracking counters?')) return;
  try {
    await fetch('/api/costs/reset', { method: 'POST' });
    await loadCosts();
  } catch (e) {
    alert('Failed to reset: ' + e.message);
  }
}

async function clearCache() {
  if (!confirm('Clear the entire Azure response cache?')) return;
  try {
    const res = await fetch('/api/cache/clear', { method: 'POST' });
    const data = await res.json();
    alert(`Cache cleared â€” ${data.entries_cleared} entries removed`);
    await loadCosts();
  } catch (e) {
    alert('Failed to clear cache: ' + e.message);
  }
}

// Auto-refresh costs when the tab is active
$$('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    if (tab.dataset.tab === 'costs') {
      loadCosts();
      if (!costRefreshTimer) {
        costRefreshTimer = setInterval(loadCosts, 10000); // refresh every 10s
      }
    } else {
      if (costRefreshTimer) {
        clearInterval(costRefreshTimer);
        costRefreshTimer = null;
      }
    }
  });
});

// â”€â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLightbox(url) {
  lightboxImg.src = url;
  lightbox.classList.add('show');
}
lightbox.addEventListener('click', () => lightbox.classList.remove('show'));
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') lightbox.classList.remove('show');
});
</script>
</body>
</html>
